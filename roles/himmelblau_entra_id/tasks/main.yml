---
# tasks file for roles/himmelblau_entra_id
- name: Himmelblau - Add repository GPG key
  ansible.builtin.shell: |
    curl -fsSL https://download.opensuse.org/repositories/home:himmelblau/xUbuntu_22.04/Release.key | \
    gpg --dearmor | \
    tee /etc/apt/trusted.gpg.d/home_himmelblau.gpg > /dev/null
  args:
    creates: /etc/apt/trusted.gpg.d/home_himmelblau.gpg

- name: Himmelblau - APT repository
  ansible.builtin.apt_repository:
    repo: "deb https://download.opensuse.org/repositories/home:/himmelblau/xUbuntu_22.04/ /"
    state: present
    filename: himmelblau

- name: Himmelblau - Update APT cache after adding repository
  ansible.builtin.apt:
    update_cache: true

- name: Himmelblau - add packages
  ansible.builtin.apt:
    name:
      - himmelblaud
      - libnss-himmelblau
      - libpam-himmelblau
    state: present

- name: Himmelblau - create configuration directory
  ansible.builtin.file:
    path: /etc/himmelblau
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Himmelblau - Configure with Entra ID tenant
  ansible.builtin.template:
    src: himmelblau.conf.j2
    dest: /etc/himmelblau/himmelblau.conf
    mode: '0644'
    owner: root
    group: root
  notify: restart himmelblaud

- name: Himmelblau - Configure NSS
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^passwd:'
    line: 'passwd:         files himmelblau systemd'
    backup: true

- name: Himmelblau - Configure NSS group resolution
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^group:'
    line: 'group:          files himmelblau systemd'
    backup: true

- name: Backup original common-auth PAM configuration
  ansible.builtin.copy:
    src: /etc/pam.d/common-auth
    dest: /etc/pam.d/common-auth.backup
    remote_src: true
    force: false
    mode: '0644'

- name: Himmelblau - Configure PAM common-auth with MFA
  ansible.builtin.copy:
    content: |
      #
      # /etc/pam.d/common-auth - authentication settings common to all services
      #
      auth    required    pam_himmelblau.so ignore_unknown_user mfa_poll_prompt
      auth    optional    pam_permit.so
      auth    optional    pam_cap.so
      # end of pam-auth-update config
    dest: /etc/pam.d/common-auth
    mode: '0644'
    owner: root
    group: root
    backup: true

- name: Himmelblau - Configure PAM common-account
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-account
    line: 'account sufficient pam_himmelblau.so ignore_unknown_user'
    insertbefore: '^account\s+required\s+pam_permit.so'
    backup: true

- name: Himmelblau - Configure PAM common-session
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-session
    line: 'session optional pam_himmelblau.so'
    insertbefore: '^session\s+required\s+pam_permit.so'
    backup: true

- name: Himmelblau - Configure PAM common-password
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    line: 'password sufficient pam_himmelblau.so'
    insertbefore: '^password\s+\[success=1\s+default=ignore\]\s+pam_unix.so'
    backup: true

- name: Himmelblau - Enable and start service
  ansible.builtin.systemd:
    name: himmelblaud
    enabled: true
    state: started

- name: Himmelblau - Restart SSH service to apply PAM changes
  ansible.builtin.systemd:
    name: sshd
    state: restarted
  when: himmelblau_restart_sshd | default(true)

- name: Himmelblau - Wait for Himmelblaud to be ready
  ansible.builtin.wait_for:
    path: /var/run/himmelblaud/socket
    state: present
    timeout: 30

- name: Himmelblau - Enroll device with Entra ID (manual step required)
  ansible.builtin.debug:
    msg: |
      Device enrollment must be completed manually:
      1. Run: sudo himmelblaud -e {{ himmelblau_tenant_id }}
      2. Follow the device code flow instructions
      3. Approve the device in the Entra ID admin portal
  when: himmelblau_show_enrollment_instructions | default(true)
