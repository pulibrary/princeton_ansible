---
# tasks file for roles/himmelblau_entra_id
#
- name: Himmelblau | include OS-specific tasks
  ansible.builtin.include_tasks: "{{ include_file }}"
  vars:
    include_file: >-
      {{ 'ubuntu.yml' if ansible_os_family == 'Debian'
      else 'rocky.yml' }}

  # this is the original line in file that worked
  # we use the ansible module instead
  #
  # - name: Himmelblau - Configure PAM common-auth with MFA
  #   ansible.builtin.copy:
  #     content: |
  #       #
  #       # /etc/pam.d/common-auth - authentication settings common to all services
  #       #
  #       auth    required    pam_himmelblau.so ignore_unknown_user mfa_poll_prompt
  #       auth    optional    pam_permit.so
  #       auth    optional    pam_cap.so
  #       # end of pam-auth-update config
  #     dest: /etc/pam.d/common-auth
  #     mode: '0644'
  #     owner: root
  #     group: root
  #     backup: true
  #
  # - name: Himmelblau - Configure PAM common-account
  #   ansible.builtin.lineinfile:
  #     path: /etc/pam.d/common-account
  #     line: 'account sufficient pam_himmelblau.so ignore_unknown_user'
  #     insertbefore: '^account\s+required\s+pam_permit.so'
  #     backup: true
  #
  # - name: Himmelblau - Configure PAM common-session
  #   ansible.builtin.lineinfile:
  #     path: /etc/pam.d/common-session
  #     line: 'session optional pam_himmelblau.so'
  #     insertbefore: '^session\s+required\s+pam_permit.so'
  #     backup: true
  #
  # - name: Himmelblau - Configure PAM common-password
  #   ansible.builtin.lineinfile:
  #     path: /etc/pam.d/common-password
  #     line: 'password sufficient pam_himmelblau.so'
  #     insertbefore: '^password\s+\[success=1\s+default=ignore\]\s+pam_unix.so'
  #     backup: true
  #
  # - name: Himmelblau - Enable and start service
  #   ansible.builtin.systemd:
  #     name: himmelblaud
  #     enabled: true
  #     state: started
  #
  # - name: Himmelblau - Restart SSH service to apply PAM changes
  #   ansible.builtin.systemd:
  #     name: sshd
  #     state: restarted
  #   when: himmelblau_restart_sshd | default(true)
  #
  # - name: Himmelblau - Wait for Himmelblaud to be ready
  #   ansible.builtin.wait_for:
  #     path: /var/run/himmelblaud/socket
  #     state: present
  #     timeout: 30
  #
  # - name: Himmelblau - Enroll device with Entra ID (manual step required)
  #   ansible.builtin.debug:
  #     msg: |
  #       Device enrollment must be completed manually:
  #       1. Run: sudo himmelblaud -e {{ himmelblau_tenant_id }}
  #       2. Follow the device code flow instructions
  #       3. Approve the device in the Entra ID admin portal
  #   when: himmelblau_show_enrollment_instructions | default(true)
