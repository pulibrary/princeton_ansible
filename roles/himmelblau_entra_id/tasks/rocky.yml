---
- name: Himmelblau (Rocky) | import repo GPG key
  ansible.builtin.rpm_key:
    key: "https://packages.himmelblau-idm.org/himmelblau.asc"
    state: present

- name: Himmelblau (Rocky) | add Himmelblau yum repo
  ansible.builtin.yum_repository:
    name: himmelblau
    description: Himmelblau (stable/latest) for Rocky {{ ansible_distribution_major_version }}
    baseurl: "https://packages.himmelblau-idm.org/stable/latest/rpm/rocky{{ ansible_distribution_major_version }}"
    enabled: true
    repo_gpgcheck: true
    gpgcheck: false
    gpgkey: "https://packages.himmelblau-idm.org/himmelblau.asc"
    sslverify: true

- name: Himmelblau (Rocky) | makecache
  ansible.builtin.dnf:
    name: ""
    update_cache: true

- name: Himmelblau (Rocky) | install packages
  ansible.builtin.dnf:
    name:
      - himmelblau
      - nss-himmelblau
      - pam-himmelblau
      - himmelblau-sso
      - himmelblau-sshd-config
      - himmelblau-qr-greeter
    state: present

- name: Himmelblau | create configuration directory
  ansible.builtin.file:
    path: /etc/himmelblau
    state: directory
    mode: "0755"
    owner: root
    group: root

- name: Himmelblau | write configuration
  ansible.builtin.template:
    src: himmelblau.conf.j2
    dest: /etc/himmelblau/himmelblau.conf
    mode: "0644"
    owner: root
    group: root
  notify: restart himmelblaud

# NSS
- name: Himmelblau (Rocky) | ensure nsswitch passwd entry
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^passwd:'
    line: 'passwd:     files himmelblau sss systemd'
    backup: true

- name: Himmelblau (Rocky) | ensure nsswitch group entry
  ansible.builtin.lineinfile:
    path: /etc/nsswitch.conf
    regexp: '^group:'
    line: 'group:      files himmelblau sss systemd'
    backup: true

- name: Himmelblau (Rocky) | PAM system-auth (auth)
  community.general.pamd:
    # Anchor (where to insert before):
    name: system-auth
    type: auth
    control: sufficient
    module_path: pam_unix.so
    state: before
    # New line to insert:
    new_type: auth
    new_control: required
    new_module_path: pam_himmelblau.so
    module_arguments:
      - ignore_unknown_user
      - mfa_poll_prompt

- name: Himmelblau (Rocky) | PAM system-auth (account)
  community.general.pamd:
    # Anchor:
    name: system-auth
    type: account
    control: required
    module_path: pam_unix.so
    state: before
    # New line:
    new_type: account
    new_control: sufficient
    new_module_path: pam_himmelblau.so
    module_arguments:
      - ignore_unknown_user

- name: Himmelblau (Rocky) | PAM system-auth (session)
  community.general.pamd:
    # Anchor:
    name: system-auth
    type: session
    control: required
    module_path: pam_limits.so
    state: after
    # New line:
    new_type: session
    new_control: optional
    new_module_path: pam_himmelblau.so

- name: Himmelblau (Rocky) | PAM password-auth (auth)
  community.general.pamd:
    # Anchor:
    name: password-auth
    type: auth
    control: sufficient
    module_path: pam_unix.so
    state: before
    # New line:
    new_type: auth
    new_control: required
    new_module_path: pam_himmelblau.so
    module_arguments:
      - ignore_unknown_user
      - mfa_poll_prompt

- name: Himmelblau (Rocky) | PAM password-auth (account)
  community.general.pamd:
    # Anchor:
    name: password-auth
    type: account
    control: required
    module_path: pam_unix.so
    state: before
    # New line:
    new_type: account
    new_control: sufficient
    new_module_path: pam_himmelblau.so
    module_arguments:
      - ignore_unknown_user

- name: Himmelblau (Rocky) | PAM password-auth (session)
  community.general.pamd:
    # Anchor:
    name: password-auth
    type: session
    control: required
    module_path: pam_limits.so
    state: after
    # New line:
    new_type: session
    new_control: optional
    new_module_path: pam_himmelblau.so

- name: Himmelblau | enable & start service
  ansible.builtin.systemd:
    name: himmelblaud
    enabled: true
    state: started

- name: Himmelblau | bounce SSH daemon
  ansible.builtin.systemd:
    name: "{{ himmelblau_ssh_service }}"
    state: restarted
  when: himmelblau_restart_sshd | default(true)

- name: Himmelblau | wait for daemon socket
  ansible.builtin.wait_for:
    path: /var/run/himmelblaud/socket
    state: present
    timeout: 30

- name: Himmelblau | enrollment instructions
  ansible.builtin.debug:
    msg: |
      Device enrollment must be completed manually:
      1. Run: sudo himmelblaud -e {{ himmelblau_tenant_id }}
      2. Follow the device code flow
      3. Approve device in Entra ID portal
  when: himmelblau_show_enrollment_instructions | default(true)
