---
- name: Nodejs | Check for legacy Yarn repository files
  ansible.builtin.stat:
    path: "{{ item }}"
  register: legacy_yarn_files
  loop:
    - /etc/apt/sources.list.d/yarn.list

- name: Nodejs | Remove legacy Yarn repository files
  ansible.builtin.file:
    path: "{{ item.item }}"
    state: absent
  when: item.stat.exists
  loop: "{{ legacy_yarn_files.results }}"
  become: true

- name: Nodejs | Download Yarn GPG key (ASCII)
  ansible.builtin.get_url:
    url: "{{ nodejs__yarn_key_url }}"
    dest: "/tmp/yarnpkg.gpg.key"
    mode: '0644'
  when: use_yarn

- name: Nodejs | De-armor Yarn GPG key to binary keyring
  ansible.builtin.shell: "gpg --dearmor < /tmp/yarnpkg.gpg.key > {{ nodejs__yarn_keyring_path }}"
  args:
    creates: "{{ nodejs__yarn_keyring_path }}"
  when: use_yarn
  become: true

- name: Nodejs | Ensure keyring permissions
  ansible.builtin.file:
    path: "{{ nodejs__yarn_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
    state: file
  when: use_yarn

- name: Nodejs | Add upstream Yarn APT repository
  ansible.builtin.apt_repository:
    repo: "{{ nodejs__yarn_upstream_repository }}"
    state: present
    filename: pul_yarn
    update_cache: false
  when: use_yarn

- name: Nodejs | Clean apt cache
  ansible.builtin.command: apt-get clean
  changed_when: false

- name: Nodejs | Update apt cache after adding repository
  ansible.builtin.command: apt-get update
  register: cache_update
  retries: 5
  delay: 10
  until: cache_update.rc == 0
  changed_when: false
  failed_when: false

- name: Nodejs | Display cache update errors
  ansible.builtin.debug:
    msg: |
      Return code: {{ cache_update.rc }}
      STDOUT: {{ cache_update.stdout }}
      STDERR: {{ cache_update.stderr }}
  when: cache_update.rc != 0

- name: Nodejs | Fail if cache update failed
  ansible.builtin.fail:
    msg: "apt-get update failed. See debug output above."
  when: cache_update.rc != 0

- name: Nodejs | uninstall any apt installed node
  ansible.builtin.apt:
    name: ["nodejs"]
    state: absent
  changed_when: false

- name: Nodejs | download nodejs version
  ansible.builtin.unarchive:
    src: "{{ nodejs_release_url }}/{{ desired_nodejs_version }}/node-{{ desired_nodejs_version }}-linux-x64.tar.gz"
    dest: /usr/local
    creates: /usr/local/node-{{ desired_nodejs_version }}-linux-x64
    remote_src: true

- name: Nodejs | create symbolic links for node and npm
  ansible.builtin.file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    state: link
  loop:
    - {src: "/usr/local/node-{{ desired_nodejs_version }}-linux-x64/bin/node", dest: "/usr/local/bin/node"}
    - {src: "/usr/local/node-{{ desired_nodejs_version }}-linux-x64/lib/node_modules/npm/bin/npm-cli.js", dest: "/usr/local/bin/npm"}
  changed_when: false

- name: Nodejs | Install yarn packages
  ansible.builtin.apt:
    name: ["yarn"]
    state: present
  when: use_yarn
