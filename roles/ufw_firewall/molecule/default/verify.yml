---
# Molecule verify playbook
- name: Verify UFW Configuration
  hosts: all
  become: true
  tasks:
    - name: Verify UFW is installed
      ansible.builtin.command: dpkg -l | grep ufw
      register: ufw_installed
      failed_when: "'ufw' not in ufw_installed.stdout"

    - name: Verify UFW is active
      ansible.builtin.command: ufw status
      register: ufw_status
      failed_when: "'inactive' in ufw_status.stdout"

    - name: Verify /etc/ufw/before.rules exists
      ansible.builtin.stat:
        path: /etc/ufw/before.rules
      register: before_rules_file

    - name: Assert /etc/ufw/before.rules exists
      ansible.builtin.assert:
        that:
          - before_rules_file.stat.exists
          - before_rules_file.stat.size > 0

    - name: Verify /etc/ufw/after.rules exists
      ansible.builtin.stat:
        path: /etc/ufw/after.rules
      register: after_rules_file

    - name: Assert /etc/ufw/after.rules exists
      ansible.builtin.assert:
        that:
          - after_rules_file.stat.exists
          - after_rules_file.stat.size > 0

    - name: Verify content of /etc/ufw/before.rules
      ansible.builtin.command:
        cmd: grep "--dport 22 -j ACCEPT" /etc/ufw/before.rules
      register: before_rules_check
      failed_when: before_rules_check.rc != 0

    - name: Verify content of /etc/ufw/after.rules
      ansible.builtin.command:
        cmd: grep "--dport 443 -j ACCEPT" /etc/ufw/after.rules
      register: after_rules_check
      failed_when: after_rules_check.rc != 0

    - name: Debug before.rules content
      ansible.builtin.command:
        cmd: cat /etc/ufw/before.rules
      register: debug_before_rules

    - name: Output /etc/ufw/before.rules for debugging
      ansible.builtin.debug:
        msg: "{{ debug_before_rules.stdout }}"

    - name: Verify UFW has the rules applied
      ansible.builtin.command: ufw status verbose
      register: ufw_applied_rules
      failed_when: "'22/tcp ALLOW' not in ufw_applied_rules.stdout or '443/tcp ALLOW' not in ufw_applied_rules.stdout"

    - name: Debug UFW applied rules
      ansible.builtin.debug:
        msg: "{{ ufw_applied_rules.stdout }}"
