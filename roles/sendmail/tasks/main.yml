---
# tasks file for roles/sendmail
- name: Sendmail | remove postfix
  ansible.builtin.apt:
    name: postfix
    state: absent
  when:
    - sendmail_is_local

- name: Sendmail | configure client
  include_tasks: client.yml
  
- name: Sendmail | install sendmail
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  loop:
    - sendmail
    - mailutils
    - sendmail-bin
  when:
    - sendmail_is_local

- name: Sendmail | set permissions
  ansible.builtin.file:
    path: /etc/mail
    state: directory
    recurse: true
    mode: 0711
  when:
    - sendmail_is_local


- name: Sendmail | create authfile directory
  ansible.builtin.file:
    path: /etc/mail/authinfo
    state: directory
    recurse: true
    mode: 0700
  when:
    - sendmail_is_local

- name: Sendmail | configure sendmail authinfo
  ansible.builtin.template:
    src: pul_sendmail_auth.j2
    dest: "/etc/mail/authinfo/pul_sendmail_auth"
    owner: root
    group: root
  when:
    - sendmail_is_local

- name: Sendmail | create hashed authfile
  ansible.builtin.shell: makemap hash {{ pul_auth }} < {{ pul_auth }}
  become: true
  become_user: root
  args:
    chdir: /etc/mail/authinfo
    creates: /etc/mail/authinfo/pul_sendmail_auth.db
  when:
    - sendmail_is_local

- name: Sendmail | configure sendmail
  ansible.builtin.template:
    src: sendmail.mc.j2
    dest: "/etc/mail/sendmail.mc"
    owner: root
    group: root
    mode: 0644
    backup: true
  notify: Reconfigure sendmail
  when:
    - sendmail_is_local

- name: Sendmail | reload sendmail
  ansible.builtin.service:
    name: sendmail
    state: restarted
  when:
    - running_on_server
    - sendmail_is_local
