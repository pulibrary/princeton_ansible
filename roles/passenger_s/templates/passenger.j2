server {
  listen {{ passenger_s_listen_port }} default_server;
  server_name {{ passenger_s_server_name }};
  passenger_enabled {{ passenger_s_enabled }};
  passenger_app_env {{ passenger_s_app_env }};
  passenger_set_header X-Forwarded-Proto https;
  passenger_set_header X-Forwarded-For $remote_addr;
  root {{ passenger_s_app_root }};
  {% for ip in real_ip_from %}
    set_real_ip_from {{ ip }};
    {% endfor %}
  real_ip_header X-Real-IP;
  large_client_header_buffers 4 16k;

  access_log /opt/nginx/logs/access.log custom if=$logging_enabled;

  {{ passenger_s_extra_config }}

  location /nginx_status {
    stub_status;
    allow 127.0.0.1;	# only allow requests from localhost
    deny all;		# deny all other hosts
  }
}

# this filters out the load-balancer IPs, so we don't log health checks from them
map $remote_addr $logging_enabled {
  {% for ip in real_ip_from %}
    "{{ ip }}" 0;
    {% endfor %}
     default 1;
}
