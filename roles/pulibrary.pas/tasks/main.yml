---
- name: Install grunt-cli
  npm: name=grunt-cli global=yes
  become: true

- name: install sass
  gem:
    name: sass
    state: latest
    user_install: 'no'

# - name: Create mount directories
#   file:
#     path: '/mnt/{{item}}'
#     state: 'directory'
#   with_items:
#     - diglibdata
#
# - name: Copy smb credentials
#   copy: src=files/{{item}} dest=/etc/{{item}}
#   with_items:
#     - pas.smb.credentials
#
# - name: Create mount for pas shared files
#   mount:
#     name: /mnt/diglibdata/pas
#     src: //diglibdata1.princeton.edu/pas
#     fstype: cifs
#     opts: 'credentials=/etc/pas.smb.credentials,uid={{deploy_user_uid}}'
#     state: mounted
#   with_items:
#     - pas

- name: Creates app directory
  file:
    path: '/opt/pas'
    state: 'directory'
    owner: 'pulsys'
    group: 'pulsys'
    mode: 0775
  become: true

- name: Install pas
  git:
    repo: 'git@github.com:pulibrary/pas.git'
    dest: '/opt/pas'
    accept_hostkey: 'yes'
    clone: 'yes'
    update: 'yes'
  become: 'pulsys'

- name: change permissions
  file:
    path: '/opt/pas'
    state: 'directory'
    recurse: 'yes'
    owner: '{{ deploy_user }}'
    group: 'www-data'

- name: create db.php
  template:
    src: 'db.php.j2'
    dest: '/opt/pas/craft/config/db.php'
    owner: '{{ deploy_user }}'
    group: 'www-data'
  become: true

- name: create general.php
  template:
    src: 'general.php.j2'
    dest: '/opt/pas/craft/config/general.php'
    owner: '{{ deploy_user }}'
    group: 'www-data'
  become: true

- name: create mysql user
  mysql_user:
    login_host: '{{ db_host }}'
    login_user: 'root'
    login_password: '{{ mariadb_mysql_root_password }}'
    name: '{{ pas_db_user }}'
    password: '{{ pas_db_password }}'
    state: present
    priv: '{{ pas_db_name }}.*:ALL'

- name: create mysql database
  mysql_db:
    name: '{{ pas_db_name }}'
    encoding: 'utf8'
    login_host: '{{ db_host }}'
    login_password: '{{ pas_db_password }}'
    login_user: '{{ pas_db_user }}'

- name: Unarchive SQL file to import
  unarchive:
    src: 'files/pas.zip'
    dest: '/tmp'
  ignore_errors: 'yes'

- name: Import database
  mysql_db:
    name: '{{ pas_db_name }}'
    login_host: '{{ db_host }}'
    login_user: '{{ pas_db_user }}'
    login_password: '{{ pas_db_password }}'
    state: import
    target: '/tmp/pas.sql'

# - name: Set hostname for php application
#   replace:
#     path: '/opt/pas/craft/config/general.php'
#     regexp: 'pas_hostname'
#     replace: '{{ pas_server_name }}'
#
# - name: Set siteURL for php application
#   replace:
#     path: '/opt/pas/craft/config/general.php'
#     regexp: 'pas_site_url'
#     replace: '{{ pas_site_url }}'
#
# - name: Set filepath for php application
#   replace:
#     path: '/opt/pas/craft/config/general.php'
#     regexp: 'pas_base_path'
#     replace: '{{ apache_app_path }}'
#
# - name: Set hostname for php application
#   replace:
#     path: '/opt/pas/craft/config/general.php'
#     regexp: 'pas_base_url'
#     replace: '{{ pas_base_url }}'

# - name: Create symlinks
#   file:
#     src: '{{item.src}}'
#     dest: '{{item.link}}'
#     owner: '{{deploy_user}}'
#     group: '{{deploy_user}}'
#     state: 'link'
#     force: true
#   with_items:
#     - src: '/mnt/diglibdata/pas'
#       link: '/opt/pas/uploads'
