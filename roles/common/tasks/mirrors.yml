---
- name: Common - Ensure repo tools present
  ansible.builtin.package:
    name: dnf-plugins-core
    state: present
  when: ansible_pkg_mgr == 'dnf'

- name: Common - Add Princeton Rocky repo (preferred by low cost)
  ansible.builtin.template:
    src: rocky-princeton.repo.j2
    dest: "/etc/yum.repos.d/{{ item.priority }}-{{ item.name }}-rocky.repo"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ preferred_mirrors }}"
  when: ansible_os_family == 'RedHat'

# Build cache using the package module, with retries
- name: Common - Build package metadata cache
  ansible.builtin.dnf:
    update_cache: true
  when: ansible_pkg_mgr == 'dnf'
  register: dnf_cache
  retries: 5
  delay: 3
  until: dnf_cache is succeeded

- name: Common - Build package metadata cache (yum fallback)
  ansible.builtin.yum:
    update_cache: true
  when: ansible_pkg_mgr == 'yum'
  register: yum_cache
  retries: 5
  delay: 3
  until: yum_cache is succeeded

- name: Common | Determine Ubuntu codename
  ansible.builtin.set_fact:
    ubuntu_codename: "{{ ansible_distribution_release | default(ansible_lsb.codename) }}"
  when:
    - ansible_os_family == "Debian"

- name: Common | Determine if architecture is supported by Princeton mirror
  ansible.builtin.set_fact:
    use_princeton_mirror: "{{ ansible_architecture in ['x86_64', 'amd64'] }}"
  when:
    - ansible_os_family == "Debian"

- name: Common | Prefer Princeton mirror for apt (x86_64/amd64 only)
  ansible.builtin.apt_repository:
    repo: deb [arch=amd64] https://{{ item.base }}/pub/ubuntu {{ ubuntu_codename }} main restricted universe multiverse
    state: present
    filename: "{{ item.priority }}-{{ item.name }}"
    update_cache: false
  loop: "{{ preferred_mirrors }}"
  when:
    - ansible_os_family == "Debian"
    - use_princeton_mirror | bool
  register: princeton_mirror_apt
  failed_when:
    - princeton_mirror_apt is failed
    - "'does not have a Release file' not in princeton_mirror_apt.msg | default('')"
    - "'Failed to fetch' not in princeton_mirror_apt.msg | default('')"
    - "'Connection failed' not in princeton_mirror_apt.msg | default('')"
    - "'Unable to connect' not in princeton_mirror_apt.msg | default('')"
    - "'Could not resolve' not in princeton_mirror_apt.msg | default('')"
    - "'Temporary failure' not in princeton_mirror_apt.msg | default('')"

- name: Common | Prefer Princeton mirror for apt updates (x86_64/amd64 only)
  ansible.builtin.apt_repository:
    repo: deb [arch=amd64] https://{{ item.base }}/pub/ubuntu {{ ubuntu_codename }}-updates main restricted universe multiverse
    state: present
    filename: "{{ item.priority }}-{{ item.name }}"
    update_cache: false
  loop: "{{ preferred_mirrors }}"
  when:
    - ansible_os_family == "Debian"
    - use_princeton_mirror | bool
  register: princeton_mirror_updates
  failed_when:
    - princeton_mirror_updates is failed
    - "'does not have a Release file' not in princeton_mirror_updates.msg | default('')"
    - "'Failed to fetch' not in princeton_mirror_updates.msg | default('')"
    - "'Connection failed' not in princeton_mirror_updates.msg | default('')"
    - "'Unable to connect' not in princeton_mirror_updates.msg | default('')"
    - "'Could not resolve' not in princeton_mirror_updates.msg | default('')"
    - "'Temporary failure' not in princeton_mirror_updates.msg | default('')"

- name: Common | Prefer Princeton mirror for apt backports (x86_64/amd64 only)
  ansible.builtin.apt_repository:
    repo: deb [arch=amd64] https://{{ item.base }}/pub/ubuntu {{ ubuntu_codename }}-backports main restricted universe multiverse
    state: present
    filename: "{{ item.priority }}-{{ item.name }}"
    update_cache: false
  loop: "{{ preferred_mirrors }}"
  when:
    - ansible_os_family == "Debian"
    - use_princeton_mirror | bool
  register: princeton_mirror_backports
  failed_when:
    - princeton_mirror_backports is failed
    - "'does not have a Release file' not in princeton_mirror_backports.msg | default('')"
    - "'Failed to fetch' not in princeton_mirror_backports.msg | default('')"
    - "'Connection failed' not in princeton_mirror_backports.msg | default('')"
    - "'Unable to connect' not in princeton_mirror_backports.msg | default('')"
    - "'Could not resolve' not in princeton_mirror_backports.msg | default('')"
    - "'Temporary failure' not in princeton_mirror_backports.msg | default('')"

- name: Common | Add fallback Ubuntu archive for apt (all suites)
  ansible.builtin.apt_repository:
    repo: "{{ item }}"
    state: present
    filename: "99-ubuntu-archive"
    update_cache: false
  loop:
    - "deb http://archives.ubuntu.com/ubuntu {{ ubuntu_codename }} main restricted universe multiverse"
    - "deb http://archives.ubuntu.com/ubuntu {{ ubuntu_codename }}-updates main restricted universe multiverse"
    - "deb http://archives.ubuntu.com/ubuntu {{ ubuntu_codename }}-backports main restricted universe multiverse"
  when:
    - ansible_os_family == "Debian"

- name: Common | Clean apt cache before update
  ansible.builtin.command: apt-get clean
  when:
    - ansible_os_family == "Debian"
  changed_when: false

- name: Common | Update apt cache after configuring all repositories
  ansible.builtin.command: apt-get update -o Debug::Acquire::http=true
  when:
    - ansible_os_family == "Debian"
  register: apt_cache_update
  retries: 3
  delay: 5
  until: apt_cache_update.rc == 0
  changed_when: false
  failed_when: false

- name: Common | Show apt-get update output for debugging
  ansible.builtin.debug:
    msg: |
      Return code: {{ apt_cache_update.rc }}
      STDOUT:
      {{ apt_cache_update.stdout }}
      STDERR:
      {{ apt_cache_update.stderr }}
  when:
    - ansible_os_family == "Debian"

- name: Common | Check what repository files were created
  ansible.builtin.command: cat /etc/apt/sources.list.d/00-princeton.list
  when:
    - ansible_os_family == "Debian"
    - use_princeton_mirror | bool
  register: princeton_list_content
  changed_when: false
  failed_when: false

- name: Common | Show Princeton repository file content
  ansible.builtin.debug:
    var: princeton_list_content.stdout_lines
  when:
    - ansible_os_family == "Debian"
    - use_princeton_mirror | bool
    - princeton_list_content.stdout is defined

- name: Common | Check Ubuntu archive repository file
  ansible.builtin.command: cat /etc/apt/sources.list.d/99-ubuntu-archive.list
  when:
    - ansible_os_family == "Debian"
  register: ubuntu_archive_content
  changed_when: false
  failed_when: false

- name: Common | Show Ubuntu archive file content
  ansible.builtin.debug:
    var: ubuntu_archive_content.stdout_lines
  when:
    - ansible_os_family == "Debian"
    - ubuntu_archive_content.stdout is defined

- name: Common | Fail if apt update didn't succeed
  ansible.builtin.fail:
    msg: "apt-get update failed with return code {{ apt_cache_update.rc }}. Check the debug output above for details."
  when:
    - ansible_os_family == "Debian"
    - apt_cache_update.rc != 0

- name: Common | Display apt update status
  ansible.builtin.debug:
    msg: "apt cache updated successfully"
  when:
    - ansible_os_family == "Debian"
    - apt_cache_update.rc == 0
