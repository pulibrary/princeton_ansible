---
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Stop and disable NTP service (if installed)
      ansible.builtin.service:
        name: ntp
        state: stopped
        enabled: false
      when: "'ntp' in ansible_facts.services"

    - name: Uninstall NTP package
      ansible.builtin.package:
        name: ntp
        state: absent

    - name: Install Chronyd package
      ansible.builtin.package:
        name: chrony
        state: present

    - name: Configure Chronyd with chrony.conf file
      ansible.builtin.copy:
        src: chrony.conf
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: '0644'
        backup: true
      notify: restart chronyd

    - name: Ensure duplicate chronyd.conf file is gone
      ansible.builtin.file:
        path: /etc/chronyd.conf
        state: absent
      notify: restart chronyd

    - name: Ensure Chronyd service is enabled and started
      ansible.builtin.service:
        name: chrony
        state: started
        enabled: true

    - name: Verify Chronyd sources
      ansible.builtin.command: chronyc sources -v
      register: chrony_sources
      changed_when: false
      failed_when: "'System clock wrong' in chrony_sources.stderr"

    # - name: Display Chronyd sources
    #   ansible.builtin.debug:
    #     var: chrony_sources.stdout_lines
