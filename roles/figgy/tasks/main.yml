---
- name: figgy | Create repository directory structure
  ansible.builtin.file:
    path: '/opt/{{ item }}'
    state: 'directory'
    owner: '{{ deploy_user }}'
    group: '{{ deploy_user }}'
    mode: 0755
  loop:
    - 'repository'

## Create Mounts
- name: figgy | Create mount directories
  ansible.builtin.file:
    path: '/mnt/{{ item }}'
    state: 'directory'
    mode: 0755
  loop:
    - hydra_sources
    - figgy_binaries
    - figgy_images
    - diglibdata
    - illiad
    - '{{ figgy_cantaloupe_images_mount }}'
    - 'diglibdata/pudl'
    - 'diglibdata/hydra_binaries'
    - 'illiad/images'
    - 'illiad/ocr_scan'
    - 'illiad/cdl_scans'

- name: figgy | Copy smb credentials
  ansible.builtin.copy:
    src: "files/{{ item }}"
    dest: "/etc/{{ item }}"
    mode: 0644
  when: running_on_server
  loop:
    - pudl.smb.credentials
    - archives.smb.credentials
    - archives_bd.smb.credentials
    - studio.new.smb.credentials
    - hydradev.smb.credentials
    - numis.smb.credentials
    - plum_mount.smb.credentials
    - libimages2.smb.credentials
    - maplab.smb.credentials
    - geoserver.smb.credentials
    - illiad.smb.credentials
    - marquand.smb.credentials
    - mendel.smb.credentials
    - mudd.smb.credentials
    - microforms.smb.credentials

- name: figgy | Create mount to plum binaries
  ansible.posix.mount:
    name: '/mnt/diglibdata/hydra_binaries'
    src: '//diglibdata1.princeton.edu/hydra/binaries'
    fstype: cifs
    opts: 'credentials=/etc/plum_mount.smb.credentials,uid={{ deploy_user_uid }},gid=33'
    state: mounted
  when: running_on_server

- name: figgy | Create mount to pudl binaries (for migration)
  ansible.posix.mount:
    name: '/mnt/diglibdata/pudl'
    src: '//diglibdata1.princeton.edu/pudl'
    fstype: cifs
    opts: 'credentials=/etc/pudl.smb.credentials,uid={{ deploy_user_uid }},gid=33'
    state: mounted
  when: running_on_server

- name: figgy | Create mount to scratch space (for bulk ingests)
  ansible.posix.mount:
    name: '/mnt/hydra_sources/ingest_scratch'
    src: '//diglibdata1.princeton.edu/hydra/binaries/ingest_scratch'
    fstype: cifs
    opts: 'credentials=/etc/plum_mount.smb.credentials,uid={{ deploy_user_uid }},gid=33'
    state: mounted
  when: running_on_server

- name: figgy | Create cantaloupe images mount
  ansible.posix.mount:
    name: '/mnt/{{ figgy_cantaloupe_images_mount }}/data'
    src: '//{{ figgy_cantaloupe_images_mount }}.princeton.edu/data'
    fstype: cifs
    opts: 'credentials=/etc/libimages2.smb.credentials,uid={{ deploy_user_uid }},gid={{ deploy_user_uid }}'
    state: mounted
  when: running_on_server

- name: figgy | Ensure figgy derivatives mount directory exists
  ansible.builtin.file:
    path: '{{ figgy_derivatives_mount }}'
    state: directory
    mode: 0755

- name: figgy | Create diglibdata mounts (hydra sources)
  ansible.posix.mount:
    name: /mnt/hydra_sources/{{ item }}
    src: //diglibdata1.princeton.edu/{{ item }}
    fstype: cifs
    opts: 'credentials=/etc/{{ item }}.smb.credentials,uid={{ deploy_user_uid }}'
    state: mounted
  when: running_on_server
  loop:
    - pudl
    - archives
    - archives_bd
    - maplab

- name: figgy | Create mount to studio (hydra sources)
  ansible.posix.mount:
    name: /mnt/hydra_sources/studio
    src: //libserv64.princeton.edu/studio
    fstype: cifs
    opts: 'credentials=/etc/studio.smb.credentials,uid={{ deploy_user_uid }}'
    state: absent
  when: running_on_server

- name: figgy | Create mount to studio (hydra sources)
  ansible.posix.mount:
    name: /mnt/hydra_sources/studio_new
    src: //lib-dps-server.princeton.edu/studio
    fstype: cifs
    opts: 'credentials=/etc/studio.new.smb.credentials,uid={{ deploy_user_uid }}'
    state: mounted
  when: running_on_server

- name: figgy | Create lib-dps mounts
  ansible.posix.mount:
    name: /mnt/hydra_sources/{{ item }}
    src: //lib-dps-server.princeton.edu/{{ item }}
    fstype: cifs
    opts: 'credentials=/etc/{{ item }}.smb.credentials,uid={{ deploy_user_uid }}'
    state: mounted
  when: running_on_server
  loop:
    - marquand
    - mendel
    - mudd
    - microforms

- name: figgy | Create mount to music reserves (hydra sources)
  ansible.posix.mount:
    name: /mnt/hydra_sources/music
    src: '//diglibdata1.princeton.edu/music'
    fstype: cifs
    opts: 'credentials=/etc/plum_mount.smb.credentials,uid={{ deploy_user_uid }},gid=33'
    state: mounted
  when: running_on_server

- name: figgy | Create mount to numismatics (hydra sources)
  ansible.posix.mount:
    name: /mnt/hydra_sources/numismatics
    src: '//diglibdata1.princeton.edu/numismatics'
    fstype: cifs
    opts: 'credentials=/etc/numis.smb.credentials,uid={{ deploy_user_uid }},gid=33'
    state: mounted
  when: running_on_server

- name: figgy | Create geoserver derivatives mount
  ansible.posix.mount:
    name: /mnt/geoserver/figgy_geo_data
    src: //geoserv1.princeton.edu/figgy_geo_data
    fstype: cifs
    opts: 'credentials=/etc/geoserver.smb.credentials,uid={{ deploy_user_uid }}'
    state: mounted
  when: running_on_server

- name: figgy | Create ILLiad mounts
  ansible.posix.mount:
    name: /mnt/illiad/{{ item }}
    src: //lib-illsql.princeton.edu/{{ item }}
    fstype: cifs
    opts: 'credentials=/etc/illiad.smb.credentials,uid={{ deploy_user_uid }},gid=33'
    state: mounted
  when: running_on_server
  loop:
    - images
    - ocr_scan
    - cdl_scans

## Symlink to Mounts
- name: figgy | Create symlinks
  ansible.builtin.file:
    src: '{{ item.src }}'
    dest: '{{ item.link }}'
    owner: '{{ deploy_user }}'
    group: '{{ deploy_user }}'
    state: 'link'
    force: true
  loop:
    - src: '/mnt/hydra_sources'
      link: '/opt/{{ rails_app_directory }}/shared/staged_files'
    - src: '{{ figgy_repository_mount }}'
      link: '/opt/repository/files'
    - src: '{{ figgy_derivatives_mount }}'
      link: '/opt/repository/derivatives'
    - src: '{{ figgy_geo_derivatives_mount }}'
      link: '/opt/repository/geo_derivatives'
    - src: '{{ figgy_stream_derivatives_mount }}'
      link: '/opt/repository/stream_derivatives'

- name: figgy | add GDAL repository
  ansible.builtin.apt_repository:
    repo: "ppa:ubuntugis/ppa"

- name: figgy | Install GDAL
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - "libgdal-dev"
    - "gdal-bin"

- name: figgy | Install cogeo-mosaic apt prerequisites
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - "python3-setuptools"
    - "cython3"

- name: figgy | update pip3 for cogeo-mosaic
  ansible.builtin.pip:
    name: pip>21,!=21.2
    executable: pip3
    state: present

- name: figgy | remove cogeo-mosaic requests dependency to ensure the correct version
  ansible.builtin.pip:
    name: requests
    executable: pip3
    state: absent
  changed_when: "'molecule-idempotence-notest' not in ansible_skip_tags"

- name: figgy | remove cogeo-mosaic urllib3 dependency to ensure the correct version
  ansible.builtin.pip:
    name: urllib3
    executable: pip3
    state: absent
  changed_when: "'molecule-idempotence-notest' not in ansible_skip_tags"

- name: figgy | Install cogeo-mosaic
  ansible.builtin.pip:
    name: cogeo-mosaic
    executable: pip3
    extra_args: --pre
  changed_when: "'molecule-idempotence-notest' not in ansible_skip_tags"

- name: figgy | Create cloud_config directory
  ansible.builtin.file:
    path: '/home/{{ deploy_user }}/cloud_config'
    state: 'directory'
    mode: 0755

- name: figgy | Install Google Cloud Authorization
  ansible.builtin.copy:
    src: "files/{{ rails_app_env }}-google_cloud_credentials.json"
    dest: "/home/{{ deploy_user }}/cloud_config/google_cloud_credentials.json"
    mode: 0644
  tags:
    - site_config
  when: running_on_server
