---
- name: Converge
  hosts: all
  vars:
    - node_identifier: 1
    - replication_database: "replicant"
    - replication_user: "replicant"
    - repmgr_config: "/etc/repmgr.conf"
    - running_on_server: false
  roles:
    - role: pulibrary.postgresql
      postgresql_ext_install_postgis: true
      postgresql_databases:
        - name: awesome_db
          gis: true
        - name: replicant
      postgresql_database_extensions:
        - db: awesome_db
          extensions:
            - gis
      postgresql_users:
        - name: awesome_user_with_pass
          password: "ToughToGusspAsSwOrD"
        - name: awesome_user_with_db
          password: "ToughToGusspAsSwOrD"
          db: test_db
        - name: replicant
          password: "VoightKampff"
          db: replicant
      postgresql_hba_entries:
        - type: local
          database: all
          user: postgres
          method: ident
        - type: local
          database: replicant
          user: replicant
          method: md5
        - type: host
          database: all
          user: postgres
          address: 127.0.0.1/32
          method: ident
        - type: host
          database: replicant
          user: replicant
          address: 127.0.0.1/32
          method: md5
    - role: pulibrary.pgbouncer
      pgbouncer_database_aliases:
        - name: awesome_db
          host: 127.0.0.1
          pool_size: 50
          user: awesome_user_with_pass
      pgbouncer_auth_users:
        - name: test_app
          password: md55febd31cd57bced0b87cc9fce61c00b4
      pgbouncer_install_pg_client: true
      pgbouncer_auth_type: md5
