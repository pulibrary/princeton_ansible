---
# tasks file for roles/postfix
- name: Postfix | Pre-configure systems
  ansible.builtin.debconf:
    name: postfix
    question: postfix/main_mailer_type
    vtype: string
    value: "Internet with smarthost"

- name: Postfix | Install postfix
  ansible.builtin.apt:
    name: postfix
    state: present

- name: Postfix | Set values for main.cf
  ansible.builtin.set_fact:
    _postfix_mynetworks: >-
      {% if postfix_mynetworks is string %}{{ postfix_mynetworks }}
      {% elif postfix_mynetworks is iterable and (postfix_mynetworks is not string and postfix_mynetworks is not mapping) %}
      {% for network in postfix_mynetworks %}{{ network }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
    _postfix_mydestination: >-
      {% if postfix_mydestination is defined %}
      {% if postfix_mydestination is string %}
      {{ postfix_mydestination }}
      {% elif postfix_mydestination is iterable and (postfix_mydestination is not string and postfix_mydestination is not mapping) %}
      {% for domain in postfix_mydestination %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}
    _postfix_relay_domains: >-
      {% if postfix_relay_domains is defined %}
      {% if postfix_relay_domains is string %}
      {{ postfix_relay_domains }}
      {% elif postfix_relay_domains is iterable and (postfix_relay_domains is not string and postfix_relay_domains is not mapping) %}
      {% for domain in postfix_relay_domains %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}
    _postfix_smtpd_recipient_restrictions: >-
      {% if postfix_smtpd_recipient_restrictions is defined %}
      {% if postfix_smtpd_recipient_restrictions is string %}
      {{ _postfix_smtpd_recipient_restrictions_check_recipient_access | trim }} {{ postfix_smtpd_recipient_restrictions }}
      {% elif postfix_smtpd_recipient_restrictions is iterable and (postfix_smtpd_recipient_restrictions is not string and postfix_smtpd_recipient_restrictions is not mapping) %}
      {{ _postfix_smtpd_recipient_restrictions_check_recipient_access | trim }} {% for domain in postfix_smtpd_recipient_restrictions %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_smtpd_sender_restrictions: >-
      {% if postfix_smtpd_sender_restrictions is defined %}
      {% if postfix_smtpd_sender_restrictions is string %}
      {{ _postfix_smtpd_sender_restrictions_check_sender_access | trim }} {{ postfix_smtpd_sender_restrictions }}
      {% elif postfix_smtpd_sender_restrictions is iterable and (postfix_smtpd_sender_restrictions is not string and postfix_smtpd_sender_restrictions is not mapping) %}
      {{ _postfix_smtpd_sender_restrictions_check_sender_access | trim }} {% for domain in postfix_smtpd_sender_restrictions %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_virtual_mailbox_domains: >-
      {% if postfix_virtual_mailbox_domains is defined %}
      {% if postfix_virtual_mailbox_domains is string %}
      {{ postfix_virtual_mailbox_domains }}
      {% elif postfix_virtual_mailbox_domains is iterable and (postfix_virtual_mailbox_domains is not string and postfix_virtual_mailbox_domains is not mapping) %}
      {% for domain in postfix_virtual_mailbox_domains %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}
    _postfix_virtual_alias_domains: >-
      {% if postfix_virtual_alias_domains is defined %}
      {% if postfix_virtual_alias_domains is string %}
      {{ postfix_virtual_alias_domains }}
      {% elif postfix_virtual_alias_domains is iterable and (postfix_virtual_alias_domains is not string and postfix_virtual_alias_domains is not mapping) %}
      {% for domain in postfix_virtual_alias_domains %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}

- name: Postfix | Configure postfix
  ansible.builtin.template:
    src: main.cf.j2
    dest: /etc/postfix/main.cf
    validate: postconf -d -c %s
    mode: "0644"
  notify:
    - Validate configuration
    - Restart postfix


- name: Postfix | Configure postfix
  ansible.builtin.template:
    src: master.cf.j2
    dest: /etc/postfix/master.cf
    validate: postconf -d -c %s
    mode: "0644"
  notify:
    - Validate configuration
    - Restart postfix

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Postfix | Configure aliases
  ansible.builtin.lineinfile:
    path: "{{ postfix_alias_path }}"
    regexp: "^{{ item.name }}:"
    line: "{{ item.name }}: {{ item.destination }}"
    mode: "0644"
  when:
    - postfix_aliases is defined
  loop: "{{ postfix_aliases }}"
  notify:
    - Rebuild alias database
    - Reload postfix
  loop_control:
    label: "{{ item.name }}"

- name: Postfix | Configure sender_access
  ansible.builtin.lineinfile:
    path: "{{ postfix_sender_access_path }}"
    regexp: "^{{ item.domain }}"
    line: "{{ item.domain }} {{ item.action }}"
    create: yes
    mode: "0644"
  when:
    - postfix_sender_access is defined
  loop: "{{ postfix_sender_access }}"
  notify:
    - Rebuild sender_access database
    - Reload postfix
  loop_control:
    label: "{{ item.domain }}"


- name: Postfix | Place sasl_password_map
  ansible.builtin.copy:
    content: "{{ postfix_smtp_sasl_password_map_content }}"
    dest: "{{ postfix_smtp_sasl_password_map }}"
    mode: "0600"
  when:
    - postfix_smtp_sasl_password_map is defined
  notify:
    - Rebuild sasl_password_map database

- name: Flush handlers again
  ansible.builtin.meta: flush_handlers

- name: Postfix | Start and enable postfix
  ansible.builtin.service:
    name: "{{ postfix_service }}"
    state: started
    enabled: true

