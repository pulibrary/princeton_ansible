---
- name: dspace | configure git credentials
  command: "git config --global credential.helper store"
  when: running_on_server
  changed_when: false

- name: dspace | populate the git credential store
  template:
    src: git_credentials.j2
    dest: "/home/{{ deploy_user }}/.git-credentials"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: u=rw,g=,o=
  when: running_on_server
  no_log: false

- name: dspace | create directory to host atmire scripts
  file:
    path: "{{ atmire_path }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  when: running_on_server

- name: dspace | setup install scripts
  git:
    repo: "{{ atmire_git_path }}"
    dest: "{{ atmire_path }}"
    force: true
  when: running_on_server

- name: dspace | remove bash dot files
  file:
    path: "/home/{{ deploy_user }}/{{ item }}"
    state: absent
  loop:
    - .bashrc
    - .bash_profile
  when: running_on_server

- name: dspace | configure user bashrc
  file:
    src: "{{ atmire_path }}/dspace/config/bash/bashrc"
    dest: "/home/{{ deploy_user }}/.bashrc"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    state: link
  when: running_on_server

- name: dspace | configure user bash_profile
  file:
    src: "{{ atmire_path }}/dspace/config/bash/bash_profile"
    dest: "/home/{{ deploy_user }}/.bash_profile"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    state: link
  when: running_on_server

- name: dspace | configure dspace_local_settings
  file:
    src: "{{ atmire_path }}/dspace/config/local-settings.cfg"
    dest: "/home/{{ deploy_user }}/local-settings.cfg"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    state: link
  when: running_on_server

- name: dspace | configure dspace scripts
  file:
    src: "{{ atmire_path }}/dspace/scripts"
    dest: "/home/{{ deploy_user }}/scripts"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    state: link
  when: running_on_server

- name: dspace | download dspace release
  unarchive:
    src: https://github.com/DSpace/DSpace/releases/download/dspace-{{ dspace_version }}/dspace-{{ dspace_version }}-release.zip
    dest: /opt
    remote_src: true
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
  changed_when: false
