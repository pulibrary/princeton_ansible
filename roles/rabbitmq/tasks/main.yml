---
# Needed in order to add the rabbitmq repository
- name: rabbitmq | remove old erlang apt repository
  ansible.builtin.apt_repository:
    repo: 'deb https://dl.bintray.com/rabbitmq-erlang/debian {{ ansible_distribution_release }} erlang-21.x'
    state: absent
    update_cache: false

- name: rabbitmq | remove old rabbitmq official apt repository
  ansible.builtin.apt_repository:
    repo: 'deb https://dl.bintray.com/rabbitmq/debian {{ ansible_distribution_release }} main'
    state: absent
    update_cache: false

- name: rabbitmq | ensure software-properties-common is installed
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - apt-transport-https
    - gnupg
    - software-properties-common
    - curl

- name: rabbitmq | import rabbitmq main key
  ansible.builtin.shell: curl -1sLf https://keys.openpgp.org/vks/v1/by-fingerprint/0A9AF2115F4687BD29803A206B73A36E6026DFCA | sudo gpg --dearmor | sudo tee /usr/share/keyrings/com.rabbitmq.team.gpg > /dev/null
  changed_when: false

- name: rabbitmq | import launchpad ppa key
  ansible.builtin.shell: curl -1sLf https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xf77f1eda57ebb1cc | sudo gpg --dearmor | sudo tee /usr/share/keyrings/net.launchpad.ppa.rabbitmq.erlang.gpg > /dev/null
  changed_when: false

- name: rabbitmq | import packagecloud key
  ansible.builtin.shell: curl -1sLf https://packagecloud.io/rabbitmq/rabbitmq-server/gpgkey | sudo gpg --dearmor | sudo tee /usr/share/keyrings/io.packagecloud.rabbitmq.gpg > /dev/null
  changed_when: false

- name: rabbitmq | import modern Erlang repository
  ansible.builtin.shell: curl -1sLf https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/gpg.E495BB49CC4BBE5B.key | sudo gpg --dearmor | sudo tee /usr/share/keyrings/io.cloudsmith.rabbitmq.E495BB49CC4BBE5B.gpg > /dev/null
  changed_when: false

- name: rabbitmq | import cloudsmith repository
  ansible.builtin.shell: curl -1sLf https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-server/gpg.9F4587F226208342.key | sudo gpg --dearmor | sudo tee /usr/share/keyrings/io.cloudsmith.rabbitmq.9F4587F226208342.gpg > /dev/null
  changed_when: false

- name: rabbitmq | add rabbitmq packagecloud repository
  ansible.builtin.apt_repository:
    repo: "{{ item }}"
    state: present
    filename: rabbitmq-packagecloud
  loop:
    - 'deb [signed-by=/usr/share/keyrings/io.packagecloud.rabbitmq.gpg] https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/ {{ ansible_distribution_release }} main'
    - 'deb-src [signed-by=/usr/share/keyrings/io.packagecloud.rabbitmq.gpg] https://packagecloud.io/rabbitmq/rabbitmq-server/ubuntu/ {{ ansible_distribution_release }} main'

- name: rabbitmq | add rabbitmq cloudsmith
  ansible.builtin.apt_repository:
    repo: "{{ item }}"
    state: present
    filename: rabbitmq-cloudsmith
  loop:
    - 'deb [signed-by=/usr/share/keyrings/io.cloudsmith.rabbitmq.E495BB49CC4BBE5B.gpg] https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/deb/ubuntu {{ ansible_distribution_release }} main'
    - 'deb-src [signed-by=/usr/share/keyrings/io.cloudsmith.rabbitmq.E495BB49CC4BBE5B.gpg] https://dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/deb/ubuntu {{ ansible_distribution_release }} main'

- name: rabbitmq | install package
  ansible.builtin.apt:
    name: rabbitmq-server
    state: present

- name: rabbitmq | enable rabbitmq plugins
  community.rabbitmq.rabbitmq_plugin:
    names: rabbitmq_management
    state: enabled
  notify:
    - restart rabbitmq

- name: rabbitmq | add user
  community.rabbitmq.rabbitmq_user:
    user: '{{ rabbitmq_user }}'
    password: '{{ rabbitmq_password }}'
    tags: 'administrator, {{ rabbitmq_user }}'
    vhost: '/'
    configure_priv: '.*'
    write_priv: '.*'
    read_priv: '.*'
    state: present

- name: rabbitmq | remove default guest user
  community.rabbitmq.rabbitmq_user:
    user: guest
    state: absent
