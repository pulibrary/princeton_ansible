---
- name: Nginxplus - Install Add NGINX Repository
  ansible.builtin.apt_repository:
    repo: "{{ item }}"
  with_items:
    - "{{ nginx_repository.debian }}"

- name: Nginxplus | Clean apt cache
  ansible.builtin.command: apt-get clean
  changed_when: false

- name: Nginxplus | Update apt cache after adding repository
  ansible.builtin.command: apt-get update
  register: cache_update
  retries: 3
  delay: 5
  until: cache_update.rc == 0
  changed_when: false
  failed_when: false

- name: Nginxplus | Display cache update errors
  ansible.builtin.debug:
    msg: |
      Return code: {{ cache_update.rc }}
      STDOUT: {{ cache_update.stdout }}
      STDERR: {{ cache_update.stderr }}
  when: cache_update.rc != 0

- name: Nginxplus | Fail if cache update failed
  ansible.builtin.fail:
    msg: "apt-get update failed. See debug output above."
  when: cache_update.rc != 0
