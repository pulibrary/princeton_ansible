---
# tasks file for roles/gcp-openbsd-nginx
- name: Install basic nginx
  ansible.builtin.include_tasks: base_nginx.yml

- name: Deploy acme-client.conf
  ansible.builtin.template:
    src: acme_client.j2
    dest: /etc/acme-client.conf
    owner: root
    group: wheel
    mode: "0644"
    backup: false

- name: Register ACME name
  ansible.builtin.shell: /usr/sbin/acme-client -v {{ gcp_fqdn }}
  changed_when: false
  ignore_errors: true

- name: Download and refresh certs
  ansible.builtin.cron:
    name: "Download current certs"
    hour: "0"
    job: "/usr/sbin/acme-client {{ gcp_fqdn }} && rcctl reload nginx && logger 'Updated ssl certs'"
    user: root

- name: Deploy full nginx
  ansible.builtin.template:
    src: default.j2
    dest: /etc/nginx/conf.d/default.conf
    owner: root
    group: wheel
    mode: "0644"
    backup: false
  notify:
    - Restart nginx

# not sure what should happen here for a generic
# nginx site
# - name: Copy files for static site
#   ansible.builtin.copy:
#     src: ????
#     dest: /var/www/htdocs/{{ my_file }}
#     owner: root
#     group: daemon
#     mode: "0644"
#     backup: true
#   notify:
#     - Reload nginx
