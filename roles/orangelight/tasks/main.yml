---
# tasks file for roles/orangelight

- name: Orangelight | update rubygems
  ansible.builtin.command: gem update --system 3.6.1
  become: true
  register: update_rubygems
  changed_when: '"Latest version already installed. Done." not in update_rubygems.stdout'
  tags: rubygems

- name: Orangelight | install default bundler
  ansible.builtin.command: gem install --default bundler:2.6.1
  become: true
  register: install_default_bundler
  changed_when: '"Fetching bundler-2.6.1.gem" in install_default_bundler.stdout'
  tags: rubygems

- name: Orangelight | remove old default bundler
  ansible.builtin.file:
    path: /usr/local/lib/ruby/gems/3.1.0/specifications/default/bundler-2.5.10.gemspec
    state: absent
  tags: rubygems

- name: Orangelight | create sneakers log directory
  ansible.builtin.file:
    path: /var/log/sneakers
    state: directory
    owner: deploy
    group: deploy
    mode: '0755'
  become: true

- name: Orangelight | re-deploy sneakers systemd unit file
  ansible.builtin.template:
    src: sneakers.service.j2
    dest: /etc/systemd/system/sneakers.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: reload_systemd

- name: Orangelight | enable and start sneakers service
  ansible.builtin.systemd:
    name: sneakers
    enabled: true
    state: started
  become: true

- name: Orangelight | restart sneakers service (if changed)
  ansible.builtin.systemd:
    name: sneakers
    state: restarted
  become: true
  when: sneakers_service_changed

- name: Orangelight | Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  listen: reload_systemd
