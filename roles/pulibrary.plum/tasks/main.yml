---
# tasks file for pulibrary.plum
- name: Install dependencies
  apt: name={{item}} state=present
  with_items:
    - cifs-utils
    - nfs-common
    - libpq-dev
    - tesseract-ocr
    - tesseract-ocr-*
    - gdal-bin
    - libgdal-dev
    - libcairo2-dev
    - libpango1.0-dev
    - libmagickwand-dev
    - imagemagick
  become: true
- name: Compile simple-tiles from source
  shell: curl -L {{ simple_tiles_url }} | tar -xz && cd simple-tiles-{{simple_tiles_version}} && ./configure && make && make install
  args:
    creates: /usr/local/lib/libsimple-tiles.so
- name: Create mount directories
  file:
    path: '/mnt/{{item}}'
    state: 'directory'
  with_items:
    - diglibdata
    - libimages1
    - hydra_sources
    - lib-gissystem
    - libimages
- name: Copy smb credentials
  copy: src=files/{{item}} dest=/etc/{{item}}
  with_items:
    - pudl.smb.credentials
    - archives.smb.credentials
    - libimages1.smb.credentials
    - plum_mount.smb.credentials
    - studio.smb.credentials
- name: Create diglibdata mounts
  mount:
    name: /mnt/diglibdata/{{item}}
    src: //diglibdata1.princeton.edu/{{item}}
    fstype: cifs
    opts: credentials=/etc/{{item}}.smb.credentials
    state: mounted
  with_items:
    - pudl
    - archives
- name: Create diglibdata mounts (hydra sources)
  mount:
    name: /mnt/hydra_sources/{{item}}
    src: //diglibdata1.princeton.edu/{{item}}
    fstype: cifs
    opts: 'credentials=/etc/{{item}}.smb.credentials,uid={{deploy_user_uid}}'
    state: mounted
  with_items:
    - pudl
    - archives
- name: Create mount to studio (hydra sources)
  mount:
    name: /mnt/hydra_sources/studio
    src: //libserv64.princeton.edu/studio
    fstype: cifs
    opts: 'credentials=/etc/studio.smb.credentials,uid={{deploy_user_uid}}'
    state: mounted
- name: Create mount to binaries
  mount:
    name: '/mnt/diglibdata/{{plum_fedora_mount}}_binaries'
    src: '//diglibdata1.princeton.edu/{{plum_fedora_mount}}/binaries'
    fstype: cifs
    opts: 'credentials=/etc/plum_mount.smb.credentials,uid={{deploy_user_uid}},gid=33'
    state: mounted
- name: Create libimages1 mount
  mount:
    name: /mnt/libimages1/data
    src: //libimages1.princeton.edu/data
    fstype: cifs
    opts: credentials=/etc/libimages1.smb.credentials
    state: mounted
- name: Create libimages mount
  mount:
    name: /mnt/libimages/data
    src: //libimages.princeton.edu/data
    fstype: cifs
    opts: credentials=/etc/libimages1.smb.credentials
    state: mounted
- name: Create lib-gissystem mount
  mount:
    name: /mnt/lib-gissystem/data
    src: '{{lib_gissystem_src}}'
    fstype: nfs
    opts: ro
    state: mounted
- name: Create plum directory structure
  file:
    path: '/opt/{{item}}'
    state: 'directory'
    owner: '{{deploy_user}}'
    group: '{{deploy_user}}'
  with_items:
    - '{{plum_directory}}'
    - '{{plum_directory}}/shared'
    - '{{plum_directory}}/shared/tmp'
- name: Create symlinks
  file:
    src: '{{item.src}}'
    dest: '{{item.link}}'
    owner: '{{deploy_user}}'
    group: '{{deploy_user}}'
    state: 'link'
    force: true
  with_items:
    - src: '/mnt/hydra_sources'
      link: '/opt/{{plum_directory}}/shared/staged_files'
    - src: '{{plum_derivatives_dir}}'
      link: '/opt/{{plum_directory}}/shared/tmp/derivatives'
    - src: '{{plum_uploads_dir}}'
      link: '/opt/{{plum_directory}}/shared/tmp/uploads'
    - src: '/mnt/diglibdata/archives'
      link: '/opt/{{plum_directory}}/shared/tmp/pulfa-master'
    - src: '/mnt/libimages/data/jp2s'
      link: '/opt/{{plum_directory}}/shared/tmp/pulfa-service'
- name: Install site configuration
  template: src=plum_config dest=/home/{{deploy_user}}/app_configs owner={{deploy_user}} group={{deploy_user}}
