---
- name: Sssd_ad | Ensure required packages are installed
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
      - adcli
      - krb5-user
      - libnss-sss
      - libpam-sss
      - ldap-utils
      - oddjob
      - oddjob-mkhomedir
      - packagekit
      - realmd
      - sssd
      - sssd-tools
      - samba-common-bin

- name: Sssd_ad | Configure realmd for TLS
  ansible.builtin.template:
    src: realmd.conf.j2
    dest: /etc/realmd.conf
    owner: root
    group: root
    mode: "0644"

- name: Sssd_ad | Configure sssd for TLS
  ansible.builtin.template:
    src: sssd.conf.j2
    dest: /etc/sssd/sssd.conf
    owner: root
    group: root
    mode: "0600"

- name: Sssd_ad | Configure OpenLDAP for TLS
  ansible.builtin.template:
    src: ldap.conf.j2
    dest: /etc/ldap/ldap.conf
    owner: root
    group: root
    mode: "0644"

- name: Sssd_ad | Ensure CA certificate is present
  ansible.builtin.copy:
    src: "{{ ad_ldap_cert }}"
    dest: /usr/local/share/ca-certificates/ad_ca.crt
    owner: root
    group: root
    mode: "0644"
  when: ad_ldap_cert is defined

- name: Sssd_ad | Update CA certificates
  ansible.builtin.command: update-ca-certificates
  changed_when: false
  when: ad_ldap_cert is defined

- name: Sssd_ad | Restart SSSD service
  ansible.builtin.service:
    name: sssd
    state: restarted
    enabled: true

- name: Sssd_ad | Join the AD domain using TLS
  ansible.builtin.command: realm join --user={{ ad_admin_user }} {{ ad_domain }}
  register: realm_join_result
  ignore_errors: false
  when: running_on_server

- name: Sssd_ad | Display realm join result
  ansible.builtin.debug:
    var: realm_join_result.stdout
  when: running_on_server
