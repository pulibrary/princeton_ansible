---
- name: extract OJS archive
  unarchive:
    src: https://github.com/pkp/ojs/archive/ojs-{{ ojs_version }}.zip
    dest: /var/www/
    creates: /var/www/ojs-{{ ojs_version }}
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    remote_src: true

- name: remove apache document root
  file:
    path: "{{ apache.docroot }}"
    state: absent

- name: create symlink for versions
  file:
    src: /home/pulsys/ojs-ojs-{{ ojs_version }}
    dest: "{{ apache.docroot }}"
    state: link

- name: update password
  lineinfile:
    path: "{{ apache.docroot }}/config.TEMPLATE.inc.php"
    regexp: '^password ='
    line: "password = {{ ojs_db_password }}"
  become_user: "{{ deploy_user }}"
  notify:
    - restart apache

- name: copy template file for live config
  copy:
    src: "{{ apache.docroot }}/config.TEMPLATE.inc.php"
    dest: "{{ apache.docroot }}/config.inc.php"
    remote_src: true
  become_user: "{{ deploy_user }}"
  notify:
    - restart apache

- name: create uploads directory
  file:
    path: "{{ ojs_file_uploads }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
