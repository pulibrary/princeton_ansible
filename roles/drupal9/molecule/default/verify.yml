---
# This is a playbook to execute Ansible tests.

- name: Verify
  hosts: all
  gather_facts: false
  vars:
    - php_version: "8.1"
    - php_eolversion: "7.4"
  tasks:
  - name: test for presence drupal9 apache config
    ansible.builtin.lineinfile:
      path: "/etc/sudoers"
      line: "{{ item }}"
      state: present
    loop:
      - "deploy ALL=(ALL) NOPASSWD: /usr/sbin/service nginx *"
      - "Runas_Alias WWW = www-data"
      - "deploy ALL = (WWW) NOPASSWD: ALL"
      - "deploy ALL=(ALL) NOPASSWD: /bin/chown -R www-data /var/www/drupal9*"
      - "deploy ALL=(ALL) NOPASSWD: /bin/chown -R deploy /var/www/drupal9*"
    check_mode: true
    register: present
    failed_when:
      - present is changed
  - name: test for presence allow list in settings.php
    ansible.builtin.lineinfile:
      path: "/home/deploy/settings.php"
      line: "{{ item }}"
      state: present
    loop:
      - "  '^example.com$',"
      - "  '^example-also.com$',"
    check_mode: true
    register: present
    failed_when:
      - present is changed
  - name: test for nginx conf file existence
    ansible.builtin.stat:
      path: "{{ item }}"
    loop:
      - "/home/deploy/settings.php"
    register: file
    failed_when:
      - not file.stat.exists
  - name: remove legacy php packages
    ansible.builtin.apt:
      name: "{{ item }}"
      state: absent
      autoremove: true
    loop:
      - "php{{ php_eolversion }}"
      - "php{{ php_eolversion }}-gd"
      - "php{{ php_eolversion }}-mbstring"
  - name: test for drupal packages
    ansible.builtin.apt:
      name: "{{ item }}"
      state: present
    loop:
      - "php{{ php_version }}"
      - "postgresql-client"
      - "php{{ php_version }}-gd"
      - "php{{ php_version }}-mbstring"
    check_mode: true
    register: present
    failed_when:
      - present is changed
