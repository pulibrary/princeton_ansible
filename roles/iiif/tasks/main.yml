---
# tasks file for iiif
- name: Iiif | create a working directory for serverless
  ansible.builtin.file:
    path: "{{ serverless_path }}"
    state: directory
    mode: "0755"

- name: Iiif | install sam and awscli
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop:
    - awscli
    - aws-sam-cli

- name: Iiif | clone serverless-iiif repo
  ansible.builtin.git:
    repo: "https://github.com/pulibrary/serverless-iiif.git"
    dest: "{{ lambda_dir }}"
    version: "{{ serverless_iiif_branch | default('main') }}"
    force: true

- name: Iiif | ensure existence of S3 buckets
  amazon.aws.s3_bucket:
    profile: "{{ aws_profile }}"
    region: "{{ source_bucket_region }}"
    name: "{{ item }}"
    state: present
  loop:
    - "{{ source_bucket }}"

- name: Iiif | copy deploy script
  ansible.builtin.template:
    src: ans_deploy.sh.j2
    dest: "{{ lambda_dir }}/ans_deploy.sh"
    mode: "0755"

- name: Iiif | clean SAM build cache
  ansible.builtin.file:
    path: "{{ lambda_dir }}/.aws-sam"
    state: absent

- name: Iiif | build with SAM
  ansible.builtin.command: >
    sam build --use-container
    --build-image public.ecr.aws/sam/build-nodejs22.x
  args:
    chdir: "{{ lambda_dir }}"
  environment:
    AWS_PROFILE: "{{ aws_profile }}"
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  changed_when: false

- name: Iiif | deploy lambda
  ansible.builtin.command: "{{ lambda_dir }}/ans_deploy.sh"
  args:
    chdir: "{{ lambda_dir }}"
  environment:
    AWS_PROFILE: "{{ aws_profile }}"
    AWS_DEFAULT_REGION: "{{ aws_region }}"
  changed_when: false
