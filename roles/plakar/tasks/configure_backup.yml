---
- name: Plakar | Ensure config directory exists
  ansible.builtin.file:
    path: "/etc/plakar"
    state: directory
    mode: "0755"
    owner: "{{ plakar_user }}"
    group: "{{ plakar_user }}"

- name: Plakar | Render /etc/plakar.yaml
  ansible.builtin.template:
    src: plakar.yaml.j2
    dest: /etc/plakar/plakar.yaml
    owner: root
    group: root
    mode: "0640"

# Make sure the snapshot root exists
- name: Plakar | Ensure snapshot root directory exists
  ansible.builtin.file:
    path: "{{ plakar_snapshot_root }}"
    state: directory
    mode: "0755"

# Check if the AWS store is already configured
- name: Plakar | Check if AWS store exists
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar store show {{ plakar_store_name }}
  register: plakar_store_show
  changed_when: false
  failed_when: false

# Configure the AWS store if missing
# Example (from plakar docs):
#   plakar store add mys3bucket \
#     location=s3://s3.eu-west-3.amazonaws.com/backups \
#     access_key="access_key" \
#     secret_access_key="secret_key"
- name: Plakar | Configure AWS store
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar store add {{ plakar_store_name }}
    location=s3://s3.{{ plakar_repo_region }}.amazonaws.com/{{ plakar_repo_bucket }}
    access_key={{ plakar_repo_access_key }}
    secret_access_key={{ plakar_repo_secret_key }}
  when: plakar_store_show.rc != 0

# Keep AWS credentials in sync if they change in Ansible
- name: Plakar | Ensure AWS store credentials are up to date
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar store set {{ plakar_store_name }}
    access_key={{ plakar_repo_access_key }}
    secret_access_key={{ plakar_repo_secret_key }}
  changed_when: false

# Check if a repository already exists in the AWS store
- name: Plakar | Check if AWS repository exists
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar at @{{ plakar_store_name }} ls
  environment:
    PLAKAR_PASSPHRASE: "{{ plakar_repo_passphrase }}"
  register: plakar_aws_ls
  changed_when: false
  failed_when: false

- name: Plakar | Initialize AWS repository (@{{ plakar_store_name }})
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar at @{{ plakar_store_name }} create
  environment:
    PLAKAR_PASSPHRASE: "{{ plakar_repo_passphrase }}"
  when: plakar_aws_ls.rc != 0

# Initial backup to AWS
# plakar_run_initial_backup (default: false). Set to true the first time
# you want to seed the repo with an initial backup from this host.
- name: Plakar | Run initial backup to AWS
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar at @{{ plakar_store_name }} backup {{ plakar_snapshot_root }}
  environment:
    PLAKAR_PASSPHRASE: "{{ plakar_repo_passphrase }}"
  when: plakar_run_initial_backup | default(false) | bool

# Render the scheduler config (maps the docs example to your store + root)
- name: Plakar | Render scheduler config
  ansible.builtin.template:
    src: scheduler.yaml.j2
    dest: "{{ plakar_scheduler_config_path }}"
    owner: "{{ plakar_user }}"
    group: "{{ plakar_user }}"
    mode: "0640"
  when: plakar_scheduler_enabled | default(false) | bool

# Check if scheduler is already running
- name: Plakar | Check if scheduler is already running
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: plakar scheduler list
  register: plakar_scheduler_list
  changed_when: false
  failed_when: false
  when: plakar_scheduler_enabled | default(false) | bool

# Start scheduler in the background if it's not running
# Matches docs:
#   plakar scheduler start -tasks ./scheduler.yaml
- name: Plakar | Start scheduler for daily backups
  become: true
  become_user: "{{ plakar_user }}"
  ansible.builtin.command: >
    plakar scheduler start -tasks {{ plakar_scheduler_config_path }}
  when:
    - plakar_scheduler_enabled | default(false) | bool
    - plakar_scheduler_list.rc != 0
