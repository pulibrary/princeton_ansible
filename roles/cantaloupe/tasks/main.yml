---
- name: Cantaloupe | Ensure group exists
  ansible.builtin.group:
    name: "{{ cantaloupe_group }}"
    state: present

- name: Cantaloupe | Ensure user exists
  ansible.builtin.user:
    name: "{{ cantaloupe_user }}"
    group: "{{ cantaloupe_group }}"
    state: present

- name: Cantaloupe | Check if Cantaloupe is already installed
  ansible.builtin.stat:
    path: "{{ cantaloupe_install_root }}/Cantaloupe-{{ cantaloupe_version }}"
  register: cantaloupe_installed_dir

- name: Cantaloupe | Download Cantaloupe release
  ansible.builtin.get_url:
    url: "https://github.com/medusa-project/cantaloupe/releases/download/v{{ cantaloupe_version }}/Cantaloupe-{{ cantaloupe_version }}.zip"
    dest: "/tmp/Cantaloupe-{{ cantaloupe_version }}.zip"
    mode: '0644'
    timeout: 60
  register: download_cantaloupe
  until: download_cantaloupe is success
  retries: 5
  delay: 10
  when: not cantaloupe_installed_dir.stat.exists

- name: Cantaloupe | Install Cantaloupe (unarchive)
  ansible.builtin.unarchive:
    src: "/tmp/Cantaloupe-{{ cantaloupe_version }}.zip"
    dest: "{{ cantaloupe_install_root }}"
    remote_src: true
    owner: "{{ cantaloupe_user }}"
    group: "{{ cantaloupe_group }}"
    creates: "{{ cantaloupe_install_root }}/Cantaloupe-{{ cantaloupe_version }}"
  when: not cantaloupe_installed_dir.stat.exists

- name: Cantaloupe | Create symlink
  ansible.builtin.file:
    src: "{{ cantaloupe_install_root }}/Cantaloupe-{{ cantaloupe_version }}"
    dest: "{{ cantaloupe_symlink }}"
    state: link
    owner: "{{ cantaloupe_user }}"
    group: "{{ cantaloupe_group }}"
