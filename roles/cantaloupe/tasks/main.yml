---
- name: Cantaloupe | Ensure group exists
  ansible.builtin.group:
    name: "{{ cantaloupe_group }}"
    state: present

- name: Cantaloupe | Ensure user exists
  ansible.builtin.user:
    name: "{{ cantaloupe_user }}"
    group: "{{ cantaloupe_group }}"
    state: present

- name: Cantaloupe | Check if Cantaloupe is already installed
  ansible.builtin.stat:
    path: "{{ cantaloupe_install_root }}/Cantaloupe-{{ cantaloupe_version }}"
  register: cantaloupe_installed_dir

- name: Cantaloupe | Download Cantaloupe release
  ansible.builtin.get_url:
    url: "https://github.com/medusa-project/cantaloupe/releases/download/v{{ cantaloupe_version }}/Cantaloupe-{{ cantaloupe_version }}.zip"
    dest: "/tmp/Cantaloupe-{{ cantaloupe_version }}.zip"
    mode: '0644'
    timeout: 60
  register: download_cantaloupe
  until: download_cantaloupe is success
  retries: 5
  delay: 10
  when: not cantaloupe_installed_dir.stat.exists

- name: Cantaloupe | Install Cantaloupe (unarchive)
  ansible.builtin.unarchive:
    src: "/tmp/Cantaloupe-{{ cantaloupe_version }}.zip"
    dest: "{{ cantaloupe_install_root }}"
    remote_src: true
    owner: "{{ cantaloupe_user }}"
    group: "{{ cantaloupe_group }}"
  when: not cantaloupe_installed_dir.stat.exists

- name: Cantaloupe | Find the extracted directory
  ansible.builtin.find:
    paths: "{{ cantaloupe_install_root }}"
    patterns: "*antaloupe-{{ cantaloupe_version }}"
    file_type: directory
  register: found_cantaloupe_dir

- name: Cantaloupe | Fail if directory not found
  ansible.builtin.fail:
    msg: "Could not find the unarchived Cantaloupe directory in {{ cantaloupe_install_root }}."
  when: found_cantaloupe_dir.matched == 0

- name: Cantaloupe | Create symlink
  ansible.builtin.file:
    src: "{{ found_cantaloupe_dir.files[0].path }}"
    dest: "{{ cantaloupe_symlink }}"
    state: link
    owner: "{{ cantaloupe_user }}"
    group: "{{ cantaloupe_group }}"
    force: true
