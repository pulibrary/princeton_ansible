# /etc/nginx/nginx.conf
# Take note of http://wiki.nginx.org/Pitfalls

#user  www;
worker_processes {{ nginx_worker_processes }};
worker_rlimit_nofile {{ nginx_worker_rlimit_nofile }};

events {
    worker_connections {{ nginx_worker_connections | default(1024) }};
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    index  index.html index.htm;

    {% if nginx_gzip %}gzip on;{% else %}gzip off;{% endif %}
    {% if nginx_server_tokens_off %}server_tokens off;{% endif %}
    keepalive_timeout {{ nginx_keepalive_timeout }};

    # HTTP
    server {
        listen {{ nginx_listen_ipv4 }};
        {% if nginx_listen_ipv6 %}listen [::]:{{ nginx_listen_ipv4 }};{% endif %}
        server_name {{ nginx_server_name }};
        root {{ nginx_root }};

        # Directory browsing for the mirror
        location {{ nginx_mirror_uri_prefix }} {
            autoindex on;
            autoindex_exact_size off;   # human-readable sizes
            autoindex_localtime on;     # local time
        }

        # STABLE CANONICAL PATH: /mirror/solr/<version>/<file>
        # This provides a version-independent URL structure that never breaks
        # Examples:
        #   /mirror/solr/9.9.0/solr-9.9.0.tgz
        #   /mirror/solr/8.11.4/solr-8.11.4.tgz
        #   /mirror/solr/4.10.4/solr-4.10.4.tgz
        location ~ ^{{ nginx_mirror_uri_prefix | regex_replace('/$', '') }}/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            # Try locations in order of likelihood
            # 1. Check apache/solr/solr (current releases like 9.10.0)
            if (-f $document_root{{ nginx_mirror_uri_prefix }}apache/solr/solr/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}apache/solr/solr/$ver/$file last;
            }
            # 2. Check archive/solr/9x
            if (-f $document_root{{ nginx_mirror_uri_prefix }}archive/solr/9x/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}archive/solr/9x/$ver/$file last;
            }
            # 3. Check archive/solr/legacy
            if (-f $document_root{{ nginx_mirror_uri_prefix }}archive/solr/legacy/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}archive/solr/legacy/$ver/$file last;
            }
            # 4. Check solr/dist/lucene/solr (old structure)
            if (-f $document_root{{ nginx_mirror_uri_prefix }}solr/dist/lucene/solr/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}solr/dist/lucene/solr/$ver/$file last;
            }
            # If not found anywhere, return 404
            return 404;
        }

        # LEGACY PATH SUPPORT: /mirror/apache/solr/solr/<version>/<file>
        # Redirect to canonical path for consistency
        location ~ ^{{ nginx_mirror_uri_prefix | regex_replace('/$', '') }}/apache/solr/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            return 301 {{ nginx_mirror_uri_prefix }}solr/$ver/$file;
        }

        # LEGACY PATH SUPPORT: /mirror/solr/dist/lucene/solr/<version>/<file>
        # Redirect to canonical path for consistency
        location ~ ^{{ nginx_mirror_uri_prefix | regex_replace('/$', '') }}/solr/dist/lucene/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            return 301 {{ nginx_mirror_uri_prefix }}solr/$ver/$file;
        }

        location = /50x.html { root {{ nginx_root }}; }

{% if nginx_acme_challenge_conf %}
        # allow acme path to port 80
        include {{ nginx_acme_challenge_conf }};
{% endif %}
    }

    # HTTPS
    server {
        listen {{ nginx_tls_port }} ssl;
        server_name {{ nginx_server_name }};
        root {{ nginx_root }};

        ssl_certificate      {{ nginx_ssl_certificate }};
        ssl_certificate_key  {{ nginx_ssl_certificate_key }};
        ssl_session_timeout  {{ nginx_ssl_session_timeout }};
        ssl_session_cache    {{ nginx_ssl_session_cache }};
        ssl_ciphers '{{ nginx_ssl_ciphers | replace("\n","") | trim }}';
        {% if nginx_ssl_prefer_server_ciphers %}ssl_prefer_server_ciphers on;{% endif %}

        # Directory browsing for the mirror (HTTPS)
        location {{ nginx_mirror_uri_prefix }} {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # STABLE CANONICAL PATH: /mirror/solr/<version>/<file>
        location ~ ^{{ nginx_mirror_uri_prefix | regex_replace('/$', '') }}/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            # Try locations in order of likelihood
            # 1. Check apache/solr/solr (current releases like 9.10.0)
            if (-f $document_root{{ nginx_mirror_uri_prefix }}apache/solr/solr/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}apache/solr/solr/$ver/$file last;
            }
            # 2. Check archive/solr/9x
            if (-f $document_root{{ nginx_mirror_uri_prefix }}archive/solr/9x/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}archive/solr/9x/$ver/$file last;
            }
            # 3. Check archive/solr/legacy
            if (-f $document_root{{ nginx_mirror_uri_prefix }}archive/solr/legacy/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}archive/solr/legacy/$ver/$file last;
            }
            # 4. Check solr/dist/lucene/solr (old structure)
            if (-f $document_root{{ nginx_mirror_uri_prefix }}solr/dist/lucene/solr/$ver/$file) {
                rewrite ^ {{ nginx_mirror_uri_prefix }}solr/dist/lucene/solr/$ver/$file last;
            }
            # If not found anywhere, return 404
            return 404;
        }

        # LEGACY PATH SUPPORT: /mirror/apache/solr/solr/<version>/<file>
        # Redirect to canonical path for consistency
        location ~ ^{{ nginx_mirror_uri_prefix | regex_replace('/$', '') }}/apache/solr/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            return 301 {{ nginx_mirror_uri_prefix }}solr/$ver/$file;
        }

        # LEGACY PATH SUPPORT: /mirror/solr/dist/lucene/solr/<version>/<file>
        # Redirect to canonical path for consistency
        location ~ ^{{ nginx_mirror_uri_prefix | regex_replace('/$', '') }}/solr/dist/lucene/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            return 301 {{ nginx_mirror_uri_prefix }}solr/$ver/$file;
        }

        location = /50x.html { root {{ nginx_root }}; }
    }
}
