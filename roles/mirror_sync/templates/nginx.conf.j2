# /etc/nginx/nginx.conf
# Take note of http://wiki.nginx.org/Pitfalls

#user  www;
worker_processes {{ nginx_worker_processes }};
worker_rlimit_nofile {{ nginx_worker_rlimit_nofile }};

events {
    worker_connections 1024;  # Increased worker connections
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    index  index.html index.htm;

    {% if nginx_gzip %}gzip on;{% else %}gzip off;{% endif %}
    {% if nginx_server_tokens_off %}server_tokens off;{% endif %}
    keepalive_timeout {{ nginx_keepalive_timeout }};

    # HTTP
    server {
        listen {{ nginx_listen_ipv4 }};
        {% if nginx_listen_ipv6 %}listen [::]:{{ nginx_listen_ipv4 }};{% endif %}
        server_name {{ nginx_server_name }};
        root {{ nginx_root }};

        # Directory browsing for the mirror
        location {{ nginx_mirror_uri_prefix }} {
            autoindex on;
            autoindex_exact_size off;   # human-readable sizes
            autoindex_localtime on;     # local time
        }

        # Legacy Solr paths → archive or current
        # Matches: /mirror/solr/dist/lucene/solr/<ver>/<file>
        # <ver> examples: 4.10.4, 9.2.0, 4.0.0-BETA
        location ~ ^/mirror/solr/dist/lucene/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            # Prefer the "current" tree if the file exists there
            if (-f $document_root/mirror/archive/solr/$ver/$file) {
                return 302 /mirror/archive/solr/$ver/$file;
            }
            # Otherwise route by version family
            if ($ver ~ '^9\.') {
                return 302 /mirror/archive/solr/9x/$ver/$file;
            }
            return 302 /mirror/archive/solr/legacy/$ver/$file;  # 1.x–8.x
        }

        location = /50x.html { root {{ nginx_root }}; }
    }

    # HTTPS
    server {
        listen {{ nginx_tls_port }} ssl;
        server_name {{ nginx_server_name }};
        root {{ nginx_root }};

        ssl_certificate      {{ nginx_ssl_certificate }};
        ssl_certificate_key  {{ nginx_ssl_certificate_key }};
        ssl_session_timeout  {{ nginx_ssl_session_timeout }};
        ssl_session_cache    {{ nginx_ssl_session_cache }};
        ssl_ciphers '{{ nginx_ssl_ciphers | replace("\n","") | trim }}';
        {% if nginx_ssl_prefer_server_ciphers %}ssl_prefer_server_ciphers on;{% endif %}

        # Directory browsing for the mirror (HTTPS)
        location {{ nginx_mirror_uri_prefix }} {
            autoindex on;
            autoindex_exact_size off;
            autoindex_localtime on;
        }

        # Legacy Solr paths → archive or current (HTTPS too)
        location ~ ^/mirror/solr/dist/lucene/solr/(?<ver>[0-9]+\.[0-9]+(?:\.[0-9]+)?(?:-[A-Za-z0-9.-]+)?)/(?<file>.+)$ {
            if (-f $document_root/mirror/archive/solr/$ver/$file) {
                return 302 /mirror/archive/solr/$ver/$file;
            }
            if ($ver ~ '^9\.') {
                return 302 /mirror/archive/solr/9x/$ver/$file;
            }
            return 302 /mirror/archive/solr/legacy/$ver/$file;
        }

        location = /50x.html { root {{ nginx_root }}; }
    }
}
