---
- name: Converge
  hosts: all
  vars:
    - running_on_server: false
    - deploy_user: "dspace"
    - java_type: jdk
  become: true
  pre_tasks:
    - name: update cache
      apt:
        update_cache: true
        cache_valid_time: 600
  tasks:
    - name: "Include postgresql"
      include_role:
        name: psql
      vars:
        application_db_name: vireo_db
        application_dbuser_name: vireo_user
        application_dbuser_password: vireo_password
        application_dbuser_role_attr_flags: 'SUPERUSER'
        postgres_admin_password: 'VoightKampff'
        postgresql_users:
        postgresql_databases:
          - vireo_db
        postgresql_hba_entries:
          - type: local
            database: all
            user: postgres
            method: ident
          - type: host
            database: all
            user: postgres
            address: 127.0.0.1/32
            method: ident
          - type: host
            database: vireo_db
            user: vireo_user
            address: 127.0.0.1/32
            method: md5
    - name: "Include vireo"
      include_role:
        name: vireo
