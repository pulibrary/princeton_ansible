---
- name: Redis | Download Redis GPG key (ASCII)
  ansible.builtin.get_url:
    url: "{{ redis_apt_key_url }}"
    dest: "/tmp/redis.gpg.key"
    mode: '0644'

- name: Redis | De-armor Redis GPG key to binary keyring
  ansible.builtin.shell: "gpg --dearmor < /tmp/redis.gpg.key > {{ redis_keyring_path }}"
  args:
    creates: "{{ redis_keyring_path }}"
  become: true

- name: Redis | Ensure keyring permissions
  ansible.builtin.file:
    path: "{{ redis_keyring_path }}"
    mode: '0644'
    owner: root
    group: root
    state: file
  become: true

- name: Redis | Remove legacy repository file if it exists
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/redis.list
    state: absent
  become: true

- name: Redis | Add Redis Labs repository (Modern)
  ansible.builtin.apt_repository:
    repo: "{{ redis_apt_repository }}"
    state: present
    filename: pul_redis
    update_cache: false

- name: Redis | Clean apt cache before update
  ansible.builtin.command: apt-get clean
  changed_when: false

- name: Redis | Update apt cache after adding Redis repository
  ansible.builtin.command: apt-get update
  register: redis_cache_update
  retries: 3
  delay: 5
  until: redis_cache_update.rc == 0
  changed_when: false
  failed_when: false

- name: Redis | Display cache update output for debugging
  ansible.builtin.debug:
    msg: |
      apt-get update return code: {{ redis_cache_update.rc }}
      STDOUT: {{ redis_cache_update.stdout }}
      STDERR: {{ redis_cache_update.stderr }}
  when: redis_cache_update.rc != 0

- name: Redis | Fail if cache update didn't succeed
  ansible.builtin.fail:
    msg: "Failed to update apt cache after adding Redis repository. See debug output above."
  when: redis_cache_update.rc != 0

- name: Redis | install redis packages
  ansible.builtin.apt:
    name: "{{ redis_packages }}"
    state: present

- name: Redis | configure redis
  ansible.builtin.template:
    src: "redis.conf.j2"
    dest: "/etc/redis/redis.conf"
    owner: "redis"
    group: "redis"
    mode: "0644"
  changed_when: false
  notify:
    - restart redis

- name: Redis | ulimit value for redis
  ansible.builtin.template:
    src: "redis_ulimit.conf.j2"
    dest: "/etc/security/limits.d/redis.conf"
    force: true
    mode: "0644"

- name: Redis | Set vm.overcommit
  ansible.posix.sysctl:
    name: "vm.overcommit_memory"
    value: 1
    sysctl_file: "/etc/sysctl.d/30-redis.conf"
  when: redis__overcommit_memory_enable|bool

- name: Redis | ensure Redis Server service enabled
  ansible.builtin.service:
    name: "redis-server"
    state: started
    enabled: true
  when: running_on_server
