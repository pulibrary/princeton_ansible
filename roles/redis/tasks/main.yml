---
- name: Redis | Download and add the Redis GPG key
  ansible.builtin.shell:
    cmd: |
      curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
      chmod 644 /usr/share/keyrings/redis-archive-keyring.gpg
  changed_when: false

- name: Redis | Set correct permissions for the Redis GPG key
  ansible.builtin.file:
    path: /usr/share/keyrings/redis-archive-keyring.gpg
    owner: root
    group: root
    mode: '0644'

- name: Redis | add the Redis labs APT repository
  ansible.builtin.copy:
    content: "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb {{ ansible_lsb.codename }} main\n"
    dest: /etc/apt/sources.list.d/redis.list
    mode: '0644'

- name: Redis | install redis packages
  ansible.builtin.apt:
    name: "{{ redis_packages }}"
    state: present
    update_cache: true

- name: Redis | configure redis
  ansible.builtin.template:
    src: "redis.conf.j2"
    dest: "/etc/redis/redis.conf"
    owner: "redis"
    group: "redis"
    mode: "0644"
  changed_when: false
  notify:
    - restart redis

- name: Redis | ulimit value for redis
  ansible.builtin.template:
    src: "redis_ulimit.conf.j2"
    dest: "/etc/security/limits.d/redis.conf"
    force: true
    mode: "0644"

- name: Redis | Set vm.overcommit
  ansible.posix.sysctl:
    name: "vm.overcommit_memory"
    value: 1
    sysctl_file: "/etc/sysctl.d/30-redis.conf"
  when: redis__overcommit_memory_enable|bool

- name: Redis | ensure Redis Server service enabled
  service:
    name: "redis-server"
    state: started
    enabled: true
