---
  - name: Update and install required system packages
    dnf:
      pkg:
        - curl
        - vim
        - git
        - java-1.8.0-openjdk
        - wget
        - expect
        - python3-pexpect
        - python3-psycopg2
      state: latest
      update_cache: true
  - name: download the installer
    ansible.builtin.get_url:
      url: https://www.arcitecta.com/software/mf/4.16.047/mflux-dev_4.16.047_jvm_1.8.jar
      dest: /home/pulsys
      mode: '0444'
  - name: Check if mediaflux is installed
    stat:
      path: "/opt/mediaflux"
    register: "mediaflux_check"
  - name: Print the variable to the screen
    ansible.builtin.debug:
      msg: "{{ mediaflux_check.stat.exists }}"
  - name: install the jar file
    become: true
    ansible.builtin.expect:
      command: java -jar mflux-dev_4.16.047_jvm_1.8.jar nogui
      responses:
        "[accept,decline]:": "accept"
        "Install location?":
          - "/opt/mediaflux"
    when: mediaflux_check.stat.exists == False
  - name: Copy mflux licence
    ansible.builtin.copy:
      src: files/licence-{{ runtime_env }}.xml
      dest: /opt/mediaflux/config/licence.xml
  - name: Copy mediaflux service file
    become: true
    ansible.builtin.copy:
      src: files/mediaflux.service
      dest: /etc/systemd/system/mediaflux.service
  - name: Reload systemd
    ansible.builtin.systemd:
      daemon_reload: yes
  - name: Start mediaflux if not started
    ansible.builtin.service:
      name: mediaflux
      state: started
      enabled: yes
  - name: Stop and disable the firewall
    ansible.builtin.systemd:
      name: firewalld
      state: stopped
      enabled: no

  # - name: enable tkbcopr
  #   community.general.copr:
  #     host: mflux-{{ runtime_env }}.princeton.edu
  #     state: enabled
  #     name: tkbcopr
