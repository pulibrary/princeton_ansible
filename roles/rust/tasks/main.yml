---
- name: rust | ensure dependencies are present (Debian)
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"

- name: rust | set system-wide rustup locations
  ansible.builtin.set_fact:
    rust_cargo_home: /usr/local/cargo
    rust_rustup_home: /usr/local/rustup
    rust_tmpdir: /var/tmp

- name: rust | ensure rustup directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ rust_cargo_home }}"
    - "{{ rust_rustup_home }}"
    - "{{ rust_tmpdir }}/rustup"

- name: rust | check if system cargo exists
  ansible.builtin.stat:
    path: "{{ rust_cargo_home }}/bin/cargo"
  register: system_cargo

- name: rust | download rustup installer script
  ansible.builtin.get_url:
    url: https://sh.rustup.rs
    dest: "{{ rust_tmpdir }}/rustup/rustup-init.sh"
    mode: "0644"
  when: not system_cargo.stat.exists

- name: rust | install rustup + stable toolchain (system-wide)
  ansible.builtin.command:
    argv:
      - sh
      - "{{ rust_tmpdir }}/rustup/rustup-init.sh"
      - -y
      - --no-modify-path
      - --default-toolchain
      - stable
  environment:
    CARGO_HOME: "{{ rust_cargo_home }}"
    RUSTUP_HOME: "{{ rust_rustup_home }}"
    TMPDIR: "{{ rust_tmpdir }}/rustup"   # <-- avoids /tmp noexec
  args:
    creates: "{{ rust_cargo_home }}/bin/rustc"
  when: not system_cargo.stat.exists

- name: rust | make system-wide env available to all users
  ansible.builtin.copy:
    dest: /etc/profile.d/rust.sh
    owner: root
    group: root
    mode: "0644"
    content: |
      export CARGO_HOME={{ rust_cargo_home }}
      export RUSTUP_HOME={{ rust_rustup_home }}
      export PATH={{ rust_cargo_home }}/bin:$PATH

- name: rust | verify cargo works (with explicit env)
  ansible.builtin.command: "{{ rust_cargo_home }}/bin/cargo --version"
  environment:
    CARGO_HOME: "{{ rust_cargo_home }}"
    RUSTUP_HOME: "{{ rust_rustup_home }}"
  changed_when: false

