---
- name: Verify
  hosts: all
  gather_facts: false
  vars:
    - expected_golang_version: "1.25.5"
  tasks:
    - name: Check if Go binary exists at install location
      ansible.builtin.stat:
        path: /usr/local/go/bin/go
      register: go_binary

    - name: Assert Go binary is present and executable
      ansible.builtin.assert:
        that:
          - go_binary.stat.exists
          - go_binary.stat.executable
        fail_msg: "Go binary not found or not executable at /usr/local/go/bin/go"

    - name: Check if the symlink exists in /usr/local/bin
      ansible.builtin.stat:
        path: /usr/local/bin/go
      register: go_symlink

    - name: Assert symlink is valid and points to the correct source
      ansible.builtin.assert:
        that:
          - go_symlink.stat.exists
          - go_symlink.stat.islnk
          - go_symlink.stat.lnk_source == '/usr/local/go/bin/go'
        fail_msg: "/usr/local/bin/go is missing or does not point to /usr/local/go/bin/go"

    - name: Get installed Go version
      ansible.builtin.command: /usr/local/bin/go version
      register: go_version_output
      changed_when: false

    - name: Assert installed version matches expectation
      ansible.builtin.assert:
        that:
          - "'go' ~ expected_golang_version in go_version_output.stdout"
        fail_msg: "Expected Go version {{ expected_golang_version }}, but got: {{ go_version_output.stdout }}"
