---
- name: Verify
  hosts: all
  gather_facts: false

  tasks:
    - name: Load golang role defaults
      ansible.builtin.include_vars:
        file: "../../defaults/main.yml"
        name: golang_defaults

    - name: Derive expected Go version and install dir
      ansible.builtin.set_fact:
        expected_golang_version: "{{ golang_version | default(golang_defaults.golang_version) }}"
        expected_install_dir: "{{ golang_install_dir | default(golang_defaults.golang_install_dir) }}"

    - name: Check if Go binary exists at install location
      ansible.builtin.stat:
        path: "{{ expected_install_dir }}/go/bin/go"
      register: go_binary

    - name: Assert Go binary is present and executable
      ansible.builtin.assert:
        that:
          - go_binary.stat.exists
          - go_binary.stat.executable
        fail_msg: "Go binary not found or not executable at {{ expected_install_dir }}/go/bin/go"

    - name: Check if the symlink exists in /usr/local/bin
      ansible.builtin.stat:
        path: /usr/local/bin/go
      register: go_symlink

    - name: Assert symlink is valid and points to the correct source
      ansible.builtin.assert:
        that:
          - go_symlink.stat.exists
          - go_symlink.stat.islnk
          - go_symlink.stat.lnk_source == expected_install_dir + '/go/bin/go'
        fail_msg: "/usr/local/bin/go is missing or does not point to {{ expected_install_dir }}/go/bin/go"

    - name: Get installed Go version
      ansible.builtin.command: /usr/local/bin/go version
      register: go_version_output
      changed_when: false

    - name: Assert installed version matches expectation
      ansible.builtin.assert:
        that:
          - "'go' ~ expected_golang_version in go_version_output.stdout"
        fail_msg: "Expected Go version {{ expected_golang_version }}, but got: {{ go_version_output.stdout }}"

