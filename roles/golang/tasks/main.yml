---
# roles/golang
- name: Golang | Ensure download directory exists
  ansible.builtin.file:
    path: "{{ golang_download_dir }}"
    state: directory
    mode: "0755"

- name: Golang | Determine architecture string (if not overridden)
# allows local testing on containers that don't match the host machine
  ansible.builtin.set_fact:
    golang_arch: >-
      {{ 'amd64' if ansible_architecture in ['x86_64', 'amd64'] else
         'arm64' if ansible_architecture in ['aarch64', 'arm64'] else
         golang_arch }}
  when: golang_arch is not defined or golang_arch | length == 0

- name: Golang | Download Go tarball for {{ golang_version }} if missing
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ golang_version }}.linux-{{ golang_arch }}.tar.gz"
    dest: "{{ golang_download_dir }}/go{{ golang_version }}.linux-{{ golang_arch }}.tar.gz"
    mode: "0644"
    force: false
    checksum: "{{ golang_tarball_checksum | default(omit) }}"
  register: golang_tarball

# Go tarball contains a top-level go/ directory; extract into /usr/local to get /usr/local/go per upstream docs.
- name: Golang | Install Go {{ golang_version }}
  ansible.builtin.unarchive:
    src: "{{ golang_download_dir }}/go{{ golang_version }}.linux-{{ golang_arch }}.tar.gz"
    dest: "/usr/local"
    remote_src: true
  when: golang_tarball.changed

- name: Golang | Ensure /usr/local/bin/go symlink exists
  ansible.builtin.file:
    src: "{{ golang_install_dir }}/bin/go"
    dest: "/usr/local/bin/go"
    state: link
  when: golang_tarball.changed
