---
# This is an example playbook to execute Ansible tests.

- name: Verify
  hosts: all
  gather_facts: false
  tasks:
    - name: register output of consul members
      command: consul members
      environment:
        CONSUL_HTTP_TOKEN: '{{ consul_acl_master_token }}'
      register: consul_members_results
    - name: test consul cluster has members
      assert:
        that:
          - "'nomadserver1' in consul_members_results.stdout"
          - "'nomadserver2' in consul_members_results.stdout"
          - "'nomadserver3' in consul_members_results.stdout"
    - name: register output of consul DNS command
      command: dig consul.service.consul SRV
      register: consul_dns_results
    - name: test consul dns has consul members
      assert:
        that:
          - "'ANSWER SECTION:' in consul_dns_results.stdout"
          - "'ANSWER: 3' in consul_dns_results.stdout"
    - name: register output of nomad command
      command: nomad operator raft list-peers
      register: nomad_operator_raft_results
    - name: test nomad cluster registration
      assert:
        that:
          - "'nomadserver1' in nomad_operator_raft_results.stdout"
