---
- name: Pul_nomad_cdh_baserow | create postgresql db users
  community.postgresql.postgresql_user:
    name: '{{ cdh_baserow_sandbox_db_user }}'
    password: '{{ cdh_baserow_sandbox_db_password }}'
    encrypted: true
    state: 'present'
  delegate_to: '{{ cdh_baserow_sandbox_postgres_host }}'
  become: true
  become_user: '{{ cdh_baserow_sandbox_postgres_admin_user }}'
  run_once: true

- name: Pul_nomad_cdh_baserow | create postgresql database
  community.postgresql.postgresql_db:
    name: '{{ cdh_baserow_sandbox_db_name }}'
    encoding: 'UTF-8'
    state: 'present'
    owner: "{{ cdh_baserow_sandbox_db_user }}"
  delegate_to: '{{ cdh_baserow_sandbox_postgres_host }}'
  become: true
  become_user: '{{ cdh_baserow_sandbox_postgres_admin_user }}'
  run_once: true

- name: Pul_nomad_cdh_baserow - ensure baserow media dir exists on clients
  ansible.builtin.file:
    path: /srv/nomad/host_volumes/cdh-baserow-media
    state: directory
    owner: 9999
    group: 9999
    mode: "0755"
  when: pul_nomad_role == 'client'


- name: Pul_nomad_cdh_baserow | ensure access to postgres server for client connections
  ansible.builtin.lineinfile:
    path: '/etc/postgresql/{{ cdh_baserow_sandbox_postgres_version }}/main/pg_hba.conf'
    line: 'host  all      all {{ ansible_default_ipv4.address }}/32       md5'
  delegate_to: '{{ cdh_baserow_sandbox_postgres_host }}'
  register: remote_postgres_configured
  throttle: 1 # have this task run one machine at a time to avoid race condition
  when:
    - "pul_nomad_role == 'client'"

- name: Pul_nomad_cdh_baserow | reload postgresql
  ansible.builtin.service:
    name: postgresql
    state: reloaded
  when:
    - remote_postgres_configured.changed
  delegate_to: '{{ cdh_baserow_sandbox_postgres_host }}'

- name: Pul_nomad_cdh_baserow | add the application environment variables
  ansible.builtin.shell:
    cmd: '/usr/local/bin/nomad var put -force nomad/jobs/cdh_baserow-sandbox {{ cdh_baserow_sandbox_nomad_env_vars.keys() | zip(cdh_baserow_sandbox_nomad_env_vars.values()) | map("join", "=") | join(" ") }}'
  environment:
    NOMAD_TOKEN: '{{ pul_nomad_management_token }}'
  run_once: true
