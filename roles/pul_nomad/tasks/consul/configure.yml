---
# File: config.yml - Consul configuration tasks
- name: pul_nomad | consul | Determine bind address from routing
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      ip -4 route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="src"){print $(i+1); exit}}'
  register: _consul_src_ip
  changed_when: false

- name: pul_nomad | consul | Set consul_bind_addr fact
  ansible.builtin.set_fact:
    consul_bind_addr: "{{ _consul_src_ip.stdout | trim }}"

- name: pul_nomad | consul | Create configuration directories.
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: consul
    group: consul
  loop:
    - '/etc/consul'
    - '/etc/consul.d'
    - '/opt/consul'
- name: pul_nomad | consul | Create base config
  ansible.builtin.template:
    src: consul/consul.hcl.j2
    dest: "/etc/consul.d/consul.hcl"
    owner: consul
    group: consul
    mode: '0640'
  notify: restart consul
