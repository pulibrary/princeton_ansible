---
- name: Pul_nomad | consul | Gather minimal facts needed for pkg/service handling
  ansible.builtin.setup:
    gather_subset:
      - '!all'
      - min
      - distribution
      - pkg_mgr
      - service_mgr
  when:
    - ansible_os_family is not defined
      or ansible_pkg_mgr is not defined
      or ansible_service_mgr is not defined
# Get things like consul_installed_version.
- name: Pul_nomad | consul | Set consul facts
  ansible.builtin.import_tasks: consul_facts.yml

# Install servers first.
# `include_tasks` instead of `import_tasks` makes it safe to use
# `run_once: true` in child tasks, since they'll only execute for servers.
- name: pul_nomad | consul | Install & Configure Servers
  ansible.builtin.include_tasks: server.yml
  when: pul_nomad_role == 'server'

# Install clients.
# `include_tasks` instead of `import_tasks` makes it safe to use
# `run_once: true` in child tasks, since they'll only execute for clients.
- name: pul_nomad | consul | Install & Configure Clients
  ansible.builtin.include_tasks: client.yml
  when: pul_nomad_role == 'client'

# Install ACL Configuration
- name: pul_nomad | consul | Install ACLs
  ansible.builtin.import_tasks: acl.yml

# Install DNSMasq
- name: pul_nomad | consul | Install DNSMasq
  ansible.builtin.import_tasks: dnsmasq.yml
  tags: dnsmasq
