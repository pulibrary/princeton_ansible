---
# Gather facts from hosts not targeted. If we limit with --limit, we still need the IPs of
# the hosts so configs know which consul hosts to talk to, but we need to get their facts to get that.
- name: pul_nomad | Gather facts from other servers
  ansible.builtin.setup:
  delegate_to: "{{ item }}"
  delegate_facts: true
  with_items: "{{ groups[nomad_server_group] | difference(ansible_play_hosts) }}"
  ignore_errors: true
  ignore_unreachable: true

# This will install & configure consul/dnsmasq w/ ACLs
- name: pul_nomad | Install & Configure Consul
  ansible.builtin.import_tasks: consul/main.yml
  tags:
    - consul
    - dnsmasq

# This will install & configure Nomad & connect it to Consul
- name: pul_nomad | Install & Configure Nomad
  ansible.builtin.import_tasks: nomad/main.yml
  tags:
    - nomad

# This sets up the deploy user so deploy scripts can access Nomad from host
# machines.
- name: pul_nomad | Cluster Configuration
  ansible.builtin.import_tasks: cluster_config.yml

# This configures Nomad/Other Services (like postgres) with all the variables and other settings individual apps need.
- name: pul_nomad | Configure Applications
  ansible.builtin.import_tasks: application_configurations.yml
  tags:
    - notest
    - app_config
