- name: pul_nomad | nomad | Configure Consul ACLs for Nomad
  environment:
    CONSUL_HTTP_TOKEN: '{{ consul_acl_management_token }}'
  block:
    - name: pul_nomad | nomad | Create nomad server policy
      community.general.consul_policy:
        token: '{{ consul_acl_management_token }}'
        name: nomad-server-agents
        rules: |
          agent_prefix "" {
            policy = "read"
          }
          node_prefix "" {
            policy = "write"
          }
          service_prefix "" {
            policy = "write"
          }
          acl = "write"
          mesh = "write"
      run_once: true
    - name: pul_nomad | nomad | Create Nomad Server Token
      community.general.consul_token:
        state: present
        accessor_id: 'd666b929-9e88-41f5-8938-d4f1dcb56c22' # Consistent ID for idempotency.
        policies:
          - name: 'nomad-server-agents'
        token: '{{ consul_acl_management_token }}'
      register: generated_nomad_consul_token
      throttle: 1
    - name: pul_nomad | nomad | Create nomad task policy
      community.general.consul_policy:
        token: '{{ consul_acl_management_token }}'
        name: nomad-task-policy
        rules: |
          agent_prefix "" {
            policy = "read"
          }
          service_prefix "" {
            policy = "read"
          }
          node_prefix "" {
            policy = "read"
          }
      run_once: true
    - name: pul_nomad | nomad | Create consul auth method for Nomad
      community.general.consul_auth_method:
        name: 'nomad-workloads'
        type: 'jwt'
        description: 'JWT auth method for Nomad services and workloads'
        token: '{{ consul_acl_management_token }}'
        config:
          JWKSURL: "{{ nomad_http_address }}/.well-known/jwks.json"
          JWTSupportedAlgs: 
            - "RS256"
          BoundAudiences: 
            - "consul.io"
          ClaimMappings:
            nomad_namespace: "nomad_namespace"
            nomad_job_id: "nomad_job_id"
            nomad_task: "nomad_task"
            nomad_service: "nomad_service"
      run_once: true
    - name: pul_nomad | nomad | Bind Nomad auth method for services
      community.general.consul_binding_rule:
        name: 'nomad-workloads'
        token: '{{ consul_acl_management_token }}'
        auth_method: 'nomad-workloads'
        bind_type: service
        bind_name: '${value.nomad_service}'
        selector: '"nomad_service" in value'
      run_once: true
    - name: pul_nomad | nomad | Bind Nomad auth method for tasks
      community.general.consul_binding_rule:
        name: 'nomad-tasks-binding'
        token: '{{ consul_acl_management_token }}'
        auth_method: 'nomad-workloads'
        bind_type: 'role'
        bind_name: 'nomad-tasks-${value.nomad_namespace}'
        selector: '"nomad_service" not in value'
      run_once: true
    - name: pul_nomad | nomad | Create consul task role that tasks will be associated with
      community.general.consul_role:
        name: 'nomad-tasks-default'
        token: '{{ consul_acl_management_token }}'
        policies:
          - name: "nomad-task-policy"
      run_once: true
    # TODO: Remove this when we have task identitys working.
    - name: pul_nomad | nomad | Create Nomad Task Token
      community.general.consul_token:
        state: present
        secret_id: '{{nomad_task_consul_token}}'
        policies:
          - name: 'nomad-task-policy'
        token: '{{ consul_acl_management_token }}'
      ignore_errors: true
      # idempotence only works with an accessor_id, we made this token before
      # with a known token, so we have to ignore errors and make it never mark
      # as changed.
      changed_when: false
      run_once: true

- name: pul_nomad | nomad | Create server config
  ansible.builtin.template:
    src: nomad/server.hcl.j2
    dest: "/etc/nomad.d/server.hcl"
    mode: '0640'
  notify: restart nomad
