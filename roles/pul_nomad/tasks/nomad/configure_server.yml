- name: pul_nomad | nomad | Configure Consul ACLs for Nomad
  environment:
    CONSUL_HTTP_TOKEN: '{{ consul_acl_management_token }}'
  block:
    - name: pul_nomad | nomad | Create nomad server policy
      community.general.consul_policy:
        token: '{{ consul_acl_management_token }}'
        name: nomad-server-agents
        rules: |
          agent_prefix "" {
            policy = "read"
          }
          node_prefix "" {
            policy = "write"
          }
          service_prefix "" {
            policy = "write"
          }
          acl = "write"
          mesh = "write"
      run_once: true
    - name: pul_nomad | nomad | Create Nomad Server Token
      community.general.consul_token:
        state: present
        accessor_id: 'd666b929-9e88-41f5-8938-d4f1dcb56c22' # Consistent ID for idempotency.
        policies:
          - name: 'nomad-server-agents'
        token: '{{ consul_acl_management_token }}'
      register: generated_nomad_consul_token
      throttle: 1
    - name: pul_nomad | nomad | Create nomad task policy
      community.general.consul_policy:
        token: '{{ consul_acl_management_token }}'
        name: nomad-task-policy
        rules: |
          agent_prefix "" {
            policy = "read"
          }
          service_prefix "" {
            policy = "read"
          }
          node_prefix "" {
            policy = "read"
          }
      run_once: true
    # TODO: Remove this when we have task identitys working.
    - name: pul_nomad | nomad | Create Nomad Task Token
      community.general.consul_token:
        state: present
        secret_id: '{{nomad_task_consul_token}}'
        policies:
          - name: 'nomad-task-policy'
        token: '{{ consul_acl_management_token }}'
      ignore_errors: true
      # idempotence only works with an accessor_id, we made this token before
      # with a known token, so we have to ignore errors and make it never mark
      # as changed.
      changed_when: false
      run_once: true

- name: pul_nomad | nomad | Create server config
  ansible.builtin.template:
    src: nomad/server.hcl.j2
    dest: "/etc/nomad.d/server.hcl"
    mode: '0640'
  notify: restart nomad
