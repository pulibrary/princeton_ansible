job "signoz" {
  datacenters = ["dc1"]
  type        = "service"

  group "signoz" {
    count = 1
    network {
      port "ch"           { static = {{ signoz_clickhouse_port | default(9000) }} }
    port "ui"           { static = {{ signoz_ui_port       | default(3301) }} }
    port "otlp_grpc"    { static = {{ signoz_otlp_grpc_port }} }
    port "otlp_http"    { static = {{ signoz_otlp_http_port }} }
    }

    task "clickhouse" {
      driver = "podman"
      config {
        image = "{{ signoz_clickhouse_image }}"
        network_mode = "host"
        volumes = [
          "{{ signoz_data_root }}/clickhouse:/var/lib/clickhouse:Z"
        ]
        ulimit = ["nofile=262144:262144"]
      }
      resources {
        cpu    = 1000
        memory = 2048
      }
      service {
        name = "clickhouse"
        port = "ch"
        check {
          name     = "ch alive"
          type     = "tcp"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }

    task "otel-collector" {
      driver = "podman"
      config {
        image = "{{ signoz_otelcol_image }}"
        network_mode = "host"
        args  = ["--config={{ signoz_otel_config_path }}"]
        volumes = [
          "{{ signoz_otel_config_path }}:{{ signoz_otel_config_path }}:ro,Z"
        ]
      }
      resources {
        cpu    = 300
        memory = 384
      }
    }

    task "signoz" {
      driver = "podman"
      config {
        image = "{{ signoz_image }}"
        network_mode = "host"
        volumes = [
          "{{ signoz_data_root }}/app:/var/lib/signoz:Z"
        ]
        # No port mappings needed on host network
      }
      env {
        SIGNOZ_BASEURL = "{{ signoz_baseurl }}"
        CLICKHOUSE_ADDR = "tcp://127.0.0.1:{{ signoz_clickhouse_port }}?database={{ signoz_clickhouse_db }}"
        # Google OIDC (SigNoz UI > Settings)
        GOOGLE_OAUTH_CLIENT_ID     = "{{ vault_signoz_google_oidc_client_id }}"
        GOOGLE_OAUTH_CLIENT_SECRET = "{{ vault_signoz_google_oidc_client_secret }}"
        GOOGLE_OAUTH_REDIRECT_URL  = "{{ signoz_baseurl }}/api/v1/complete/google"
      }
      resources {
        cpu    = 500
        memory = 1024
      }
      service {
        name = "signoz-ui"
        port = "ui"
        check {
          name     = "ui http"
          type     = "http"
          path     = "/"
          interval = "15s"
          timeout  = "3s"
        }
      }
    }
  }
}

