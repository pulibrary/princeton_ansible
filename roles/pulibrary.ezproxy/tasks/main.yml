---
- name: create ezproxy directory
  file:
    path: '/var/local/ezproxy'
    state: directory
    group: '{{ deploy_user }}'
    owner: '{{ deploy_user }}'

- name: download ezproxy binary
  get_url:
    url: 'https://www.oclc.org/content/dam/support/ezproxy/documentation/download/binaries/{{ ezproxy_version }}/ezproxy-linux.bin'
    dest: '/var/local/ezproxy/ezproxy'
    mode: 0755

- name: install dependencies for 64bit
  apt:
    name: '{{ item }}'
    state: 'present'
  with_items:
    - lib32ncurses5
    - lib32z1

- name: install missing file replacements
  command: /var/local/ezproxy/ezproxy -m
  become_user: '{{ deploy_user }}'
  ignore_errors: true

- name: create admin password
  copy:
    src: 'local_files/ezproxy/user.txt'
    dest: '/var/local/ezproxy/user.txt'
    owner: '{{ deploy_user }}'
    group: '{{ deploy_user }}'

- name: run command with WSKey
  command: /var/local/ezproxy/ezproxy -k '{{ oclc_wskey }}'
  become_user: '{{ deploy_user }}'

- name: launch ezproxy
  command: /var/local/ezproxy/ezproxy start
  become_user: '{{ deploy_user }}'
