---
# tasks file for roles/solrcloud

- name: Solrcloud | Set Solr version variables
  ansible.builtin.set_fact:
    is_solr9: "{{ true if solr_cloud_download_version is version('9.0.0', '>=') else false }}"

- name: Solrcloud | Display Solr version info
  ansible.builtin.debug:
    msg: "Configuring Solr {{ 'version 9.x' if is_solr9 else 'version 8.x' }} ({{ solr_cloud_download_version }})"

# Check for actual Solr installation location
- name: Solrcloud | Check for solr binary location
  ansible.builtin.stat:
    path: "/opt/solr/bin/solr"
  register: solr_bin_check

- name: Solrcloud | Find actual Solr installation path
  ansible.builtin.find:
    paths: "/opt/solr"
    file_type: directory
    patterns: "solr-*"
  register: solr_install_path
  when: solr_bin_check.stat.exists

- name: Solrcloud | Set installation directory fact
  ansible.builtin.set_fact:
    solr_installation_dir: "{{ solr_install_path.files[0].path if solr_install_path.matched > 0 else solr_installation }}"
  when: solr_bin_check.stat.exists and solr_install_path.matched is defined and solr_install_path.matched > 0

- name: Solrcloud | Debug Solr installation paths
  ansible.builtin.debug:
    msg: 
      - "Solr installation: {{ solr_installation }}"
      - "Solr installation dir: {{ solr_installation_dir | default('Not found') }}"
      - "Solr binary: {{ solr_bin }}"

- name: Solrcloud | Install dependencies
  ansible.builtin.apt:
    name:
      - cifs-utils
      - lsof
    state: present

- name: Solrcloud | Create solr directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: "directory"
    mode: "0755"
    owner: "{{ deploy_user | default(solr_user) }}" 
    group: "{{ deploy_user | default(solr_group) }}"
  loop:
    - "{{ solr_data_home }}"     # /solr
    - "{{ solr_data_dir }}"      # /solr/data
    - "{{ solr_log_dir }}"       # /solr/logs
    - "/var/run/solr"
    - "/mnt/solr_backup"
  when: running_on_server

- name: Solrcloud | Configure backup mounts
  ansible.builtin.include_tasks: backup_mounts.yml
  when: running_on_server
  tags:
    - backup
    - fix_backups

- name: Solrcloud | Install SolrCloud
  ansible.builtin.include_tasks: install.yml
  tags:
    - install

- name: Solrcloud | Find JAVA_HOME if not already set
  ansible.builtin.shell: set -o pipefail ; readlink -f /usr/bin/java | sed 's%/bin/java%%'
  args:
    executable: /bin/bash
  changed_when: false
  register: java_home_result
  when: java_home is not defined

- name: Solrcloud | Set JAVA_HOME fact
  ansible.builtin.set_fact:
    java_home: "{{ java_home_result.stdout if java_home_result is defined and java_home_result.stdout is defined else '/usr/lib/jvm/java-' + java_version|string + '-openjdk-amd64' }}"
  when: java_home is not defined

- name: Solrcloud | Configure Solr systemd service
  ansible.builtin.template:
    src: solr.service.j2
    dest: /etc/systemd/system/solr.service
    mode: "0644"
  notify: Restart solr

- name: Solrcloud | Configure SolrCloud
  ansible.builtin.include_tasks: config.yml
  tags:
    - configure

- name: Solrcloud | Configure SolrCloud init script
  ansible.builtin.template:
    src: 'solr.in.sh.j2'
    dest: '/etc/default/solr.in.sh'
    owner: '{{ solr_user }}'
    group: '{{ solr_group }}'
    mode: "0644"
  notify: Restart solr

- name: Solrcloud | Configure high ulimit value for Solr
  ansible.builtin.template:
    src: 'solr.conf.j2'
    dest: '/etc/security/limits.d/solr.conf'
    mode: "0644"
  notify: Restart solr

- name: Solrcloud | Configure logging
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: '{{ deploy_user | default(solr_user) }}'
    group: '{{ deploy_user | default(solr_group) }}'
    mode: "0644"
  loop:
    - { src: 'log4j2.xml.j2', dest: '{{ solr_data_home }}/log4j2.xml' }
  notify: Restart solr

- name: Solrcloud | Start and enable Solr service
  ansible.builtin.systemd:
    name: solr
    state: started
    enabled: true
    daemon_reload: true
  ignore_errors: true
