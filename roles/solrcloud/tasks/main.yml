---
- name: Solrcloud | create directories for mounts
  ansible.builtin.file:
    path: "{{ item }}"
    state: "directory"
    mode: "0755"
    group: deploy
    owner: deploy
  loop:
    - "/solr/data/cloud_backup"
    - "/var/log/gcsfuse"
  tags:
    - google_cloud

- name: Solrcloud | Configure cloud backup mounts
  ansible.builtin.import_tasks: backup_gcs_mount.yml
  #  apply:
  #     tags: google_cloud
  tags:
    - google_cloud

- name: Solrcloud | update host file
  ansible.builtin.lineinfile:
    dest: /etc/hosts
    regexp: "{{ item.address }}.*{{ item.hostname }}$"
    line: "{{ item.address }} {{ item.hostname }}"
    state: present
  become: true
  loop:
    - {
      hostname: "{{ lib_zk1_host_name }}.princeton.edu",
      address: "{{ lib_zk1_host }}",
    }
    - {
      hostname: "{{ lib_zk2_host_name }}.princeton.edu",
      address: "{{ lib_zk2_host }}",
    }
    - {
      hostname: "{{ lib_zk3_host_name }}.princeton.edu",
      address: "{{ lib_zk3_host }}",
    }
  tags:
    - hosts
  when: lib_zk1_host_name != "localhost" and lib_zk2_host_name != "localhost" and lib_zk3_host_name != "localhost"

- name: Solrcloud | solr cloud install node
  ansible.builtin.include_tasks: install.yml
  tags:
    - install

- name: Solrcloud | configure solr cloud
  ansible.builtin.include_tasks: config.yml
  tags:
    - configure

- name: Solrcloud | run solr service
  ansible.builtin.include_tasks: service.yml
  tags:
    - service
