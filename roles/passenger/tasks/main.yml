---
# Variable setup.
- name: Phusion | Include OS-specific variables.
  ansible.builtin.include_vars: "main.yml"

- name: Phusion | Define nginx_user.
  ansible.builtin.set_fact:
    nginx_user: "{{ __nginx_user }}"
  when: nginx_user is not defined
  tags: passenger_config

- name: Phusion | Ensure keyring directory exists
  become: true
  ansible.builtin.file:
    path: /usr/local/share/keyrings
    state: directory
    owner: root
    group: root
    mode: "0755"
# Legacy auto-software-signing key (still used to sign the jammy repo)
# https://oss-binaries.phusionpassenger.com/auto-software-signing-gpg-key.txt
- name: Phusion | Download legacy auto signing key (SHA1)
  ansible.builtin.get_url:
    url: https://oss-binaries.phusionpassenger.com/auto-software-signing-gpg-key.txt
    dest: /usr/local/share/keyrings/phusion_passenger_legacy.asc
    mode: "0644"
  register: phusion_passenger_legacy_key

- name: Phusion | Convert legacy key to GPG keyring
  become: true
  ansible.builtin.command: >
    gpg --batch --yes --dearmor
    -o /usr/local/share/keyrings/phusion_passenger_legacy.gpg
    /usr/local/share/keyrings/phusion_passenger_legacy.asc
  when: phusion_passenger_legacy_key.changed

- name: Phusion | Install legacy key into apt trusted.gpg.d
  become: true
  ansible.builtin.copy:
    src: /usr/local/share/keyrings/phusion_passenger_legacy.gpg
    dest: /etc/apt/trusted.gpg.d/phusion.gpg
    owner: root
    group: root
    mode: "0644"
    remote_src: true
  when: phusion_passenger_legacy_key.changed

# phusion new future proof key
# https://blog.phusion.nl/important-new-signing-key-for-passenger/
# https://oss-binaries.phusionpassenger.com/auto-software-signing-gpg-key-2025.txt
- name: Phusion | use new sha-256 apt key
  ansible.builtin.get_url:
    url: https://oss-binaries.phusionpassenger.com/auto-software-signing-gpg-key-2025.txt
    dest: /usr/local/share/keyrings/phusion_passenger_2025.asc
    mode: "0644"
  register: phusion_passenger_key

- name: Phusion Passenger | Convert key to GPG keyring
  ansible.builtin.command:
    cmd: >
      gpg --batch --yes --dearmor
      -o /usr/local/share/keyrings/phusion_passenger_2025.gpg
      /usr/local/share/keyrings/phusion_passenger_2025.asc
  when: phusion_passenger_key.changed

- name: Phusion Passenger | Install key into apt trusted.gpg.d
  ansible.builtin.copy:
    src: /usr/local/share/keyrings/phusion_passenger_2025.gpg
    dest: /etc/apt/trusted.gpg.d/phusion_new.gpg
    owner: root
    group: root
    mode: "0644"
    remote_src: true
  when: phusion_passenger_key.changed

- name: Phusion | Add Phusion apt repo.
  ansible.builtin.apt_repository:
    repo: 'deb https://oss-binaries.phusionpassenger.com/apt/passenger {{ ansible_distribution_release }} main'
    state: present
    filename: passenger
    update_cache: false

- name: Passenger | Clean apt cache
  ansible.builtin.command: apt-get clean
  changed_when: false

- name: Passenger | Update apt cache after adding repository
  ansible.builtin.command: apt-get update
  register: cache_update
  retries: 3
  delay: 5
  until: cache_update.rc == 0
  changed_when: false
  failed_when: false

- name: Passenger | Display cache update errors
  ansible.builtin.debug:
    msg: |
      Return code: {{ cache_update.rc }}
      STDOUT: {{ cache_update.stdout }}
      STDERR: {{ cache_update.stderr }}
  when: cache_update.rc != 0

- name: Passenger | Fail if cache update failed
  ansible.builtin.fail:
    msg: "apt-get update failed. See debug output above."
  when: cache_update.rc != 0

- name: Phusion | Install Nginx and Passenger.
  ansible.builtin.apt:
    name: "{{ nginx_passenger_packages }}"
    state: present

# Nginx and passenger configuration.
- name: Phusion | Copy Nginx configuration into place.
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    mode: "0644"
  tags: passenger_config
  notify: 'passenger : restart nginx'

- name: Phusion | Configure passenger virtual host.
  ansible.builtin.template:
    src: passenger.j2
    dest: /etc/nginx/sites-available/passenger
    mode: "0644"
  notify: restart nginx

- name: Phusion | Ensure passenger virtual host is enabled.
  ansible.builtin.file:
    src: /etc/nginx/sites-available/passenger
    dest: /etc/nginx/sites-enabled/passenger
    state: link

- name: Phusion | Ensure default virtual host is removed.
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
    mode: "0644"
  when: nginx_remove_default_vhost
  notify:
    - restart nginx

- name: Phusion | Create nginx override dir
  ansible.builtin.file:
    path: /etc/systemd/system/nginx.service.d
    state: directory
    mode: "0755"
  tags:
    - notest
    - nginx

- name: Phusion | Restart nginx on crash
  ansible.builtin.copy:
    src: 'systemd_override.conf'
    dest: /etc/systemd/system/nginx.service.d/override.conf
    mode: "0644"
  tags:
    - notest
    - nginx
  notify:
    - reload systemd

- name: Phusion | add checkmk local check
  ansible.builtin.copy:
    src: passenger_health_check.sh
    dest: "/usr/lib/check_mk_agent/local/passenger_health_check.sh"
    mode: "0755"
    owner: root
    group: root
  when: running_on_server
