---
- name: ojs | ensure SSL files directories exist
  file:
    path: "/etc/apache2/ssl/{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - private
    - certs

- name: ojs | copy certificates
  copy:
    src: "files/{{ item }}"
    dest: "/etc/apache/ssl/certs/"
    mode: 0644
  with_items:
    - ojs-staging1_princeton_edu_cert.pem
    - ojs-staging1_princeton_edu_chained.pem
  when: running_on_server

- name: ojs | copy private key
  copy:
    src: "files/ojs-staging1_princeton_edu_priv.key"
    dest: "/etc/apache/ssl/private/"
    mode: 0644
  when: running_on_server

- name: ojs | set ojs Virtualhost
  template:
    src: virtualhost.conf.j2
    dest: "/etc/apache2/sites-available/{{ deploy_ojs_url }}.conf"
    mode: 0644
  changed_when: false

- name: ojs | deactivate ojs virtualhost
  command: a2dissite 000-default
  changed_when: false

- name: ojs | activate ojs virtualhost
  command: a2ensite "{{ deploy_ojs_url }}"
  changed_when: false
  notify:
    - restart apache
  when: running_on_server

- name: ojs | add in config.inc.php
  template:
    src: "config.inc.php.j2"
    dest: "{{ deploy_ojs_dest }}/config.inc.php"
    mode: 0644
  changed_when: false

- name: ojs | configure shibboleth
  template:
    src: shibboleth2.xml.j2
    dest: /etc/shibboleth/shibboleth2.xml
    mode: 0644
  changed_when: false

- name: ojs | generate signing key
  command: shib-keygen -n sp-signing -u _shibd -g _shibd -y 20 -h {{ inventory_hostname }} -e https://{{ inventory_hostname }}/shibboleth
  changed_when: false
  ignore_errors: true
  when: running_on_server

- name: ojs | generate encryption key
  command: shib-keygen -n sp-encrypt -u _shibd -g _shibd -y 20 -h {{ inventory_hostname }} -e https://{{ inventory_hostname }}/shibboleth
  changed_when: false
  ignore_errors: true
  when: running_on_server
