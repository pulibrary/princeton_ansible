---
- name: ojs | install php postgres drivers
  apt:
    name: ['php-pgsql', 'libapache2-mod-php']
    state: present

- name: ojs | create ojs directory
  file:
    path: "{{ ojs_home }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: 0755

- name: ojs | unarchive the ojs
  unarchive:
    src: "http://pkp.sfu.ca/ojs/download/ojs-{{ ojs_version }}.tar.gz"
    dest: "/var/www"
    remote_src: true
  become: true
  become_user: "{{ deploy_user }}"
  changed_when: false

- name: ojs | remove apache document root
  file:
    path: "{{ apache.docroot }}"
    state: absent
  changed_when: false

- name: ojs | create symlink for versions
  file:
    src: /var/www/ojs-{{ ojs_version }}
    dest: "{{ apache.docroot }}"
    state: link
  changed_when: false

- name: ojs | update db driver
  lineinfile:
    path: "{{ apache.docroot }}/config.TEMPLATE.inc.php"
    regexp: "driver = mysql"
    line: "driver = postgres"
  changed_when: false
  become: true
  become_user: "{{ deploy_user }}"

- name: ojs | update password
  lineinfile:
    path: "{{ apache.docroot }}/config.TEMPLATE.inc.php"
    regexp: '^password ='
    line: "password = {{ ojs_db_password }}"
  changed_when: false
  become: true
  become_user: "{{ deploy_user }}"
  notify:
    - restart apache

- name: ojs | copy template file for live config
  copy:
    src: "{{ apache.docroot }}/config.TEMPLATE.inc.php"
    dest: "{{ apache.docroot }}/config.inc.php"
    remote_src: true
  become: true
  become_user: "{{ deploy_user }}"
  changed_when: false
  notify:
    - restart apache

- name: configure apache2
  import_tasks: apache2.yml

- name: ojs | create uploads directory
  file:
    path: "{{ ojs_file_uploads }}"
    state: directory
    owner: "{{ deploy_user }}"
    group: "www-data"
    mode: "ug+w"
  changed_when: false

- name: ojs | upstream README on other directories to modify
  file:
    path: "{{ apache.docroot }}/{{ item }}"
    group: "www-data"
    mode: "ug+w"
    recurse: true
  changed_when: false
  with_items:
    - "cache"
    - "plugins"
    - "public"

- name: ojs | ensure config file has correct permissions
  file:
    path: "{{ apache.docroot }}/config.inc.php"
    group: "www-data"
    mode: "ug+w"
  changed_when: false
  notify:
    - restart apache
