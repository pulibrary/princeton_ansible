---
- name: Create
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    molecule_inventory:
      all:
        children:
          molecule:
            hosts: {}

  tasks:
    - name: Set async_dir for HOME env (Ansible 2.19+ safe)
      ansible.builtin.set_fact:
        ansible_async_dir: "{{ lookup('env', 'HOME') }}/.ansible_async/"
      when: (lookup('env', 'HOME') | default('') | length) > 0

    - name: Create container(s)
      community.docker.docker_container:
        name: "{{ item.name }}"
        image: "{{ item.image }}"
        state: started
        recreate: false
        privileged: "{{ item.privileged | default(omit) }}"
        cgroupns_mode: "{{ item.cgroupns_mode | default(omit) }}"
        tmpfs: "{{ item.tmpfs | default(omit) }}"
        volumes: "{{ item.volumes | default(omit) }}"
        # Only pass command if itâ€™s non-empty; otherwise use image CMD (/sbin/init in your image)
        command: "{{ (item.command | default('') | length > 0) | ternary(item.command, omit) }}"
        log_driver: json-file
      loop: "{{ molecule_yml.platforms }}"

    - name: Add containers to dynamic inventory
      vars:
        inventory_partial_yaml: |
          all:
            children:
              molecule:
                hosts:
                  "{{ item.name }}":
                    ansible_connection: community.docker.docker
      ansible.builtin.set_fact:
        molecule_inventory: "{{ molecule_inventory | combine(inventory_partial_yaml | from_yaml, recursive=true) }}"
      loop: "{{ molecule_yml.platforms }}"

    - name: Write dynamic inventory file
      ansible.builtin.copy:
        dest: "{{ molecule_ephemeral_directory }}/inventory/molecule_inventory.yml"
        content: "{{ molecule_inventory | to_yaml }}"
        mode: "0600"

    - name: Refresh inventory
      ansible.builtin.meta: refresh_inventory
