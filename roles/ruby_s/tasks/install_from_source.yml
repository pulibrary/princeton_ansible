---
- name: ruby |lookup download path and checksum from ruby-lang release index
  ansible.builtin.shell: curl https://cache.ruby-lang.org/pub/ruby/index.txt | grep {{ ruby_version }}.tar.gz
  register: ruby_index_line

- name: ruby | separate index entry values
  ansible.builtin.set_fact:
    ruby_values: "{{ ruby_index_line.stdout | regex_findall('(\\S+)') }}"

- name: get ruby url
  ansible.builtin.set_fact:
    ruby_gzip_url: "{{ ruby_values[1] }}"

- name: get ruby checksum
  ansible.builtin.set_fact:
    ruby_sha_256: "{{ ruby_values[3] }}"

- name: ruby | ensure install path exists
  ansible.builtin.file:
    path: "{{ install_path }}"
    state: directory
    mode: 0644

- name: ruby | download ruby
  ansible.builtin.get_url:
    url: "{{ ruby_gzip_url }}"
    checksum: "sha256:{{ ruby_sha_256 }}"
    dest: "{{ install_path }}/{{ ruby_version }}.tar.gz"

- name: ruby | unzip ruby file
  ansible.builtin.unarchive:
    src: "{{ install_path }}/{{ ruby_version }}.tar.gz"
    dest: "{{ install_path }}/"
    creates: "{{ install_path }}/{{ ruby_version }}/compile.c"
    copy: false

- name: ruby | configure ruby
  ansible.builtin.shell: cd {{ install_path }}/{{ ruby_version }} && ./configure --enable-shared

- name: ruby | make ruby
  ansible.builtin.shell: cd {{ install_path }}/{{ ruby_version }} && make

- name: ruby | install ruby
  ansible.builtin.shell: cd {{ install_path }}/{{ ruby_version }} && make install
  become: true

- name: what version of bundler is on the VM?
  shell: cd /opt/bibdata/current && bundler -v
  register: installed_bundler

- name: look at installed bundler
  debug:
    var: installed_bundler

- name: uninstall wrong version of bundler
  community.general.gem:
    name: bundler
    state: absent

- name: what version of bundler is on the VM - second?
  shell: cd /opt/bibdata/current && bundler -v
  register: installed_bundler

- name: look at installed bundler
  debug:
    var: installed_bundler

- name: do we have a value?
  debug:
    var: bundler_version

- name: ruby | install global bundler, specific version
  community.general.gem:
    name: bundler
    version: "{{ bundler_version }}"
    user_install: false
  when: bundler_version is defined

- name: ruby | install global bundler, any version
  community.general.gem:
    name: bundler
    user_install: false
  when: bundler_version is undefined

- name: ruby | update rubygems
  ansible.builtin.command: gem update --system
  become: true
