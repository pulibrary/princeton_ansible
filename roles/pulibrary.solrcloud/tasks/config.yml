---
- name: Check for solr znode
  command: >
    {{ solr_installation }}/bin/solr zk ls /
    -z {{ zk_host_setting }}
  register: znode_check
  changed_when: false

  #- debug:
  #    var: znode_check.stdout_lines
  #
  #- debug:
  #    msg: Will create znode
  #  when: zookeeper_hosts_solr_path not in znode_check.stdout_lines

- name: Create zk chroot / solr znode using bin/solr
  command: >
    {{ solr_installation }}/bin/solr zk mkroot {{ solr_zookeeper_hosts_solr_path }}
    -z {{ zk_host_setting }}
  when: zookeeper_hosts_solr_path not in znode_check.stdout_lines

  #- name: Check for solr znode
  #  command: >
  #    {{ solr_installation }}/bin/solr zk ls /
  #    -z {{ zk_host_setting }}
  #  register: znode_check
  #  changed_when: false
  #
  #- debug:
  #    var: znode_check.stdout_lines

- name: Configuring jetty server
  template:
    src: 'jetty.xml.j2'
    dest: '/opt/solr/server/etc/jetty.xml'
    force: 'yes'
  notify: restart SolrCloud

- name: Configure jetty server http
  template:
    src: 'jetty-http.xml.j2'
    dest: '/opt/solr/server/etc/jetty-http.xml'
    force: 'yes'
  notify: restart SolrCloud

- name: Configure SolrCloud init script
  template:
    src: 'solr.in.sh.j2'
    dest: '/etc/default/solr.in.sh'
    force: 'yes'
  notify: restart SolrCloud

- name: Configure high ulimit value for Solr
  template:
    src: 'solr.conf.j2'
    dest: '/etc/security/limits.d/solr.conf'
    force: 'yes'
  notify: restart SolrCloud

- name: Configure SolrCloud properties
  template:
    src: 'solr.xml.j2'
    dest: '{{ solr_data_dir }}/solr.xml'
    force: 'yes'
  notify: restart SolrCloud

- name: Configure pre 7.4 logging
  template:
    src: 'log4j.properties.j2'
    dest: '/solr/log4j.properties'
    force: 'yes'
  notify: restart SolrCloud

- name: Configure logging
  template:
    src: 'log4j2.xml.j2'
    dest: '/solr/log4j2.xml'
    force: 'yes'
  notify: restart SolrCloud

- name: Add orangelight jar files
  shell: "cd {{ jardirectory }} && wget {{ cjkfoldingfilter }} {{ umichsolrfilters }}"
  notify: restart SolrCloud
