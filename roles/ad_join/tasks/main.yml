---
# tasks file for roles/ad_join
- name: Ad_join | ensure required packages are installed
  ansible.builtin.package:
    name: "{{ ad_join_packages }}"
    state: present

- name: Ad_join | list all realms
  ansible.builtin.command: "realm list"
  register: realm_list
  changed_when: false

- name: do we have a realm now?
  ansible.builtin.debug:
    var: realm_list

- name: Ad_join | join the realm
  ansible.builtin.command: "realm join --verbose --user={{ ad_join_admin_user }} {{ ad_join_ad_domain }}"
  when: "'kerberos-member' not in realm_list.stdout"
  register: realm_join_output
  changed_when: false

- name: let's see about that join, eh?
  ansible.builtin.debug:
    var: realm_join_output

- name: Ad_join | ensure authselect profile directory exists
  ansible.builtin.file:
    path: "{{ ad_join_authselect_custom_path }}"
    state: directory
    mode: "0755"

- name: Ad_join | copy the custom PAM configuration
  ansible.builtin.copy:
    src: "custom_pul_sssd.tar.gz"
    dest: "{{ ad_join_authselect_custom_path }}.tar.gz"
    mode: "0755"

- name: Ad_join | extract custom PAM configuration
  ansible.builtin.unarchive:
    src: "{{ ad_join_authselect_custom_path }}.tar.gz"
    dest: /etc/authselect/custom/
    remote_src: true

- name: Ad_join | select the custom authselect profile with home directory creation
  ansible.builtin.command: "authselect select custom/{{ ad_join_authselect_profile_name }} {{ 'with-mkhomedir' if ad_join_create_home_dir else '' }}"
  args:
    creates: /etc/authselect/authselect.conf

- name: Ad_join | template sssd.conf
  ansible.builtin.template:
    src: sssd.conf.j2
    dest: "{{ ad_join_sssd_config_file }}"
    owner: root
    group: root
    mode: "0600"

- name: Ad_join | copy krb5.conf
  ansible.builtin.copy:
    src: krb5.conf
    dest: "{{ ad_join_krb5_config_file }}"
    owner: root
    group: root
    mode: "0644"

- name: Ad_join | restart sssd with custom config
  ansible.builtin.service:
    name: sssd
    enabled: true
    state: restarted

- name: Ad_join | enable oddjobd service for home directory creation
  ansible.builtin.service:
    name: oddjobd
    enabled: true
    state: started
  when: ad_join_create_home_dir

- name: Ad_join | ensure the krb5 log file directory exists
  ansible.builtin.file:
    path: /var/log/sssd/
    state: directory
    mode: "0700"

- name: Ad_join | ensure the krb5 log files exist and have the right permissions
  ansible.builtin.file:
    path: "{{ item }}"
    state: touch
    owner: root
    group: root
    mode: "0644"
  loop:
    - /var/log/krb5libs.log
    - /var/log/krb5kdc.log
    - /var/log/kadmind.log

- name: Ad_join | enable Kerberos authentication in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^[\#]*KerberosAuthentication'
    line: 'KerberosAuthentication yes'
    state: present
  notify: Restart sshd

- name: Ad_join | enable GSSAPI authentication in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^[\#]*GSSAPIAuthentication'
    line: 'GSSAPIAuthentication yes'
    state: present
  notify: Restart sshd

- name: Ad_join | Ensure UsePAM is enabled in sshd_config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^[\#]*UsePAM'
    line: 'UsePAM yes'
    state: present
  notify: Restart sshd

- name: Ad_join | Restart sshd
  ansible.builtin.service:
    name: sshd
    state: restarted

- name: Ad_join | Restart sssd
  ansible.builtin.service:
    name: sssd
    state: restarted

- name: Check sssd domain status
  ansible.builtin.command: /usr/sbin/sssctl domain-status {{ ad_join_ad_domain }}
  register: domain_status_result
  ignore_errors: true

- name: Display sssd domain status
  ansible.builtin.debug:
    var: domain_status_result.stdout_lines
