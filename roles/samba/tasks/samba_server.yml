---
- name: samba | Create Samba shares root directory
  ansible.builtin.file:
    state: directory
    path: "{{ samba_shares_root }}"
    owner: root
    group: root
    mode: 0755
  when: samba_shares
  tags: samba

- name: samba | Create share directories
  ansible.builtin.file:
    state: directory
    path: "{{ item.path|default([samba_shares_root,item.name]|join('/')) }}"
    owner: "{{ item.owner|default('root') }}"
    group: "{{ item.group|default('users') }}"
    mode: 0775
  with_items: "{{ samba_shares }}"
  tags: samba

- name: samba | Samba configuration
  ansible.builtin.template:
    dest: /etc/samba/smb.conf
    src: smb.conf.j2
    validate: 'testparm -s %s'
    mode: 0644
  notify:
    - Restart Samba services
  tags: samba

- name: samba | Start Samba service(s)
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
    enabled: true
  with_items:
    - smbd
    - nmbd
  tags: samba

- name: samba | Create samba users
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
  with_items: "{{ samba_users }}"

- name: samba | Create Samba users if they don't exist yet
  ansible.builtin.shell: >
    set -o pipefail; \
    (pdbedit --user={{ item.name }} 2>&1 > /dev/null) \
    || (echo {{ item.password }}; echo {{ item.password }}) \
    | smbpasswd -s -a {{ item.name }}
  args:
    executable: /bin/bash
  with_items: "{{ samba_users }}"
  no_log: true
  register: create_user_output
  changed_when: "'Added user' in create_user_output.stdout"
  tags: samba
