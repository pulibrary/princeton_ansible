#!/bin/bash
APP=$1
BRANCH_NAME="${BRANCH:-main}"
REPOSITORY="${REPO:-princeton_ansible}"

# Make sure we're on VPN
if ! nslookup nomad-host-prod1.lib.princeton.edu 2>&1 > /dev/null
then
  echo "Unable to connect to nomad-host-prod1. Ensure you're on VPN."
  exit 1
fi

if [[ -z "${APP}" ]];
then
  echo "Missing Application. Command: 'BRANCH=main ./bin/deploy <app>'."
  exit
fi

# Deploy using nomad-host-prod1, which has the nomad management key.
ssh deploy@nomad-host-prod1.lib.princeton.edu << EOF
  curl -s "https://raw.githubusercontent.com/pulibrary/${REPOSITORY}/${BRANCH_NAME}/nomad/deploy/${APP}.hcl" | nomad job run -
EOF
