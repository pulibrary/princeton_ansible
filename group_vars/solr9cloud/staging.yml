---
java_version: 17
install_ruby_from_source: true
install_zookeeper_from_source: true
desired_ruby_version: "3.1.0"
ruby_version_override: "ruby-3.1.0"
solr_heap_setting: '20g'
jardirectory: "/opt/solr/lib"
# more granular option would be:
# solr_java_memory: '-Xms16g -Xmx20g'
# solr shards
solr_shard_socket_timeout: 120000
solr_shard_conn_timeout:   60000
solr_update_socket_timeout: 120000
solr_update_conn_timeout:   60000
solr_update_max_connections: 512
solr_update_max_per_host:    64
# solr version
solr_cloud_download_version: 9.9.0
solr_cloud_version: "{{ solr_version }}"
solr_version: "{{ solr_cloud_download_version }}"
solr_log4j_path: '/solr/log4j2.xml'
solr_znode: solr9
solr_nodes:
  - "lib-solr-staging1.princeton.edu"
  - "lib-solr-staging2.princeton.edu"
  - "lib-solr-staging3.princeton.edu"
solr_zookeeper_hosts:
  - "lib-zk-staging4.princeton.edu:2181"
  - "lib-zk-staging5.princeton.edu:2181"
  - "lib-zk-staging6.princeton.edu:2181"
cjkfoldingfilter: https://github.com/pulibrary/pul_solr/raw/master/solr8_jars/CJKFoldingFilter.jar

# gcsfuse logrotate
gcsfuse_directory: "/var/log/gcsfuse"

solr9_gcsfuse_logrotate_rules:
  - name: "gcsfuse"
    paths:
      - "{{ gcsfuse_directory }}/*.log"
    options:
      rotate: "{{ logrotate_global_defaults.rotate }}"
      maxsize: "{{ logrotate_global_defaults.maxsize }}"
      create_mode: "{{ logrotate_global_defaults.create_mode }}"
      create_owner: "deploy"
      create_group: "deploy"
      su_user: "{{ logrotate_global_defaults.su_user }}"
      su_group: "{{ logrotate_global_defaults.su_group }}"
      postrotate: |
        systemctl reload solr-gcsfuse.service 2>/dev/null || true
# Solr9 OpenTelemetry Collector Configuration
signoz_is_local: false
signoz_otel_receivers:
  hostmetrics:
    collection_interval: 30s
    scrapers:
      cpu: {}
      load: {}
      memory: {}
      disk: {}
      network: {}
      filesystem: {}
  filelog/solr-main:
    include:
      - "/solr/logs/solr.log*"
    exclude:
      - "/solr/logs/solr.log.*.gz"
    start_at: end
    operators:
      - type: add
        field: attributes.log_type
        value: "solr_application"
      - type: add
        field: attributes.service_name
        value: "solr"
  filelog/solr-console:
    include:
      - "/solr/logs/solr-8983-console.log"
    start_at: end
    operators:
      - type: add
        field: attributes.log_type
        value: "solr_console"
      - type: add
        field: attributes.service_name
        value: "solr"
  filelog/solr-slow:
    include:
      - "/solr/logs/solr_slow_requests.log"
    start_at: end
    operators:
      - type: add
        field: attributes.log_type
        value: "solr_slow_requests"
      - type: add
        field: attributes.service_name
        value: "solr"
      - type: add
        field: attributes.performance_critical
        value: "true"
  filelog/solr-gc:
    include:
      - "/solr/logs/solr_gc.log*"
      - "/solr/logs/gc.txt*"
    exclude:
      - "/solr/logs/*.gz"
    start_at: end
    operators:
      - type: add
        field: attributes.log_type
        value: "solr_gc"
      - type: add
        field: attributes.service_name
        value: "solr"
      - type: add
        field: attributes.component
        value: "garbage_collector"

signoz_otel_processors:
  resource:
    attributes:
      - key: host.name
        value: "{{ ansible_fqdn }}"
        action: upsert
      - key: service.name
        value: "solr-server"
        action: upsert
      - key: service.version
        value: "staging"
        action: upsert
      - key: environment
        value: "staging"
        action: upsert
  batch:
    timeout: 10s
    send_batch_size: 1024

signoz_otel_exporters:
  otlp:
    endpoint: "http://sandbox-signoz1.lib.princeton.edu:4317"
    tls:
      insecure: true
  debug:
    verbosity: basic

signoz_otel_service_pipelines:
  logs:
    receivers: [filelog/solr-main, filelog/solr-console, filelog/solr-slow, filelog/solr-gc]
    processors: [resource, batch]
    exporters: [otlp, debug]
  metrics:
    receivers: [hostmetrics]
    processors: [resource, batch]
    exporters: [otlp, debug]

signoz_otel_service_extensions: []
