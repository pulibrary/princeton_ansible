---
name: Molecule Tests
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - pulibrary.hr_share
          - pulibrary.drupal9
          - pulibrary.researchdata
          - pulibrary.ansible-datadog
          - pulibrary.approvals
          - pulibrary.blacklight-app
          - pulibrary.cantaloupe
          - pulibrary.capistrano
          - pulibrary.ezproxy
          - pulibrary.extra_path
          - pulibrary.ffmpeg
          - pulibrary.figgy_filewatcher_worker
          - pulibrary.figgy_pubsub_worker
          - pulibrary.fits
          - pulibrary.geoserver
          - pulibrary.lib-jobs
          - pulibrary.lib-svn
          - pulibrary.locator
          - pulibrary.matomo
          - pulibrary.openjdk
          - pulibrary.pas
          - pulibrary.recap-www
          - pulibrary.samba
          - pulibrary.rvm
          - pulibrary.svn
          - pulibrary.zookeeper
          - pulibrary.solrcloud
          - pulibrary.consul
          - pulibrary.pas_code
          - pulibrary.dss
          - pulibrary.pulfalight
          - pulibrary.solr
          - pulibrary.libstatic
          - pulibrary.saxon
          - pulibrary.bibdata
          - pulibrary.mudd
          - pulibrary.rubyoffice
          - pulibrary.mailcatcher
          - pulibrary.timezone
          - pulibrary.psql
          - pulibrary.percona
          - pulibrary.simple_annotation
          - pulibrary.apache_tomcat
          - pulibrary.apache_ant
          - pulibrary.apache_maven
          - pulibrary.pulmap
          - pulibrary.memcached
  test-molecule3:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - php
          - drush
          - apache2
          - nginxplus
          - mariadb
          - drupal
          - libwww
          - figgy
          - deploy_user
          - common
          - redis
          - vips
          - rails_app
          - nodejs
          - imagemagick
          - passenger
          - subversion
          - postgresql
          - freetds
    steps:
      - name: Checkout branch
        run: |
          git clone https://github.com/pulibrary/princeton_ansible.git .
          git checkout ${{ github.sha }}
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.9
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Disable apparmor
        run: |
          sudo service apparmor stop
          sudo service apparmor teardown
          sudo /usr/sbin/update-rc.d -f apparmor remove
      - name: Run tests
        run: |
          ROLE=${{ matrix.role }} python run_molecule.py
