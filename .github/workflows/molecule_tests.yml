---
name: Molecule Tests
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - apache2
          - approvals
          - bibdata
          - bibdata_sqs_poller
          - bind9
          - blacklight_app
          - cantaloupe
          - capistrano
          - clamav
          - common
          - composer
          - datadog
          - deploy_user
          - dpul
          - dss
          # - elixir
          - example
          - extra_path
          - ezproxy
          - ffmpeg_s
          - figgy
          - figgy_filewatcher_worker
          - figgy_pubsub_worker
          - freetds
          - golang
          - gitlab
          # - geoserver
          - hr_share
          - imagemagick
          - lae
          - lib_jobs
          # - lib_statistics
          # - libstatic
          # - locator
          - lockers_and_study_spaces
          - mailcatcher
          - mediainfo
          - memcached
          - mysql
          - nfsserver
          - nginx
          - nginxplus
          - nodejs
          # - oawaiver
          - openjdk
          - orangelight
          - otel_collector
          # - pas
          - passenger
          - php
          - postfix
          - postgresql
          - pulfalight
          - pul_nomad
          - pulmap
          # - rabbitmq
          - ruby_app
          - redis
          - repec
          - resque_worker
          - ruby_s
          - rust
          - samba
          - shared_data
          # - sidekiq_worker
          - sneakers_worker
          # - solrcloud
          - solr9cloud
          - subversion
          - timezone
          - tippecanoe
          - towerdeploy
          - ufw_firewall
          - vips
          # - zookeeper
    steps:
      - name: Checkout branch
        run: |
          git config --global http.postBuffer 1048576000
          for i in 1 2 3 4 5; do git clone https://github.com/pulibrary/princeton_ansible.git . && break || sleep 15; done
          git checkout ${{ github.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: cache python environment
        uses: actions/cache@v3
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          #- name: Setup upterm session
          #uses: lhotari/action-upterm@v1
          #
      - name: Enable Docker retry for GHCR pulls
        run: |
          # bump Docker's default timeouts & retries
          echo '{ "registry-mirrors": [], "debug": true }' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      # pull the image early
      - name: Pre-pull Molecule base image
        run: |
          docker pull ghcr.io/pulibrary/vm-builds/ubuntu-22.04:latest

      - name: Run tests
        env:
          MOLECULE_DOCKER_PLATFORM: linux/amd64
        run: |
          ROLE=${{ matrix.role }} python run_molecule.py

      - name: Debug on failure
        if: failure()
        run: |
          docker ps -a
          docker logs $(docker ps -aq --filter name=instance) || true

