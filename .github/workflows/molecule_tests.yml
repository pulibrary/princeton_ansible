---
name: Molecule Tests
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - pulibrary.approvals
          - pulibrary.drupal
          - pulibrary.libwww
          - pulibrary.locator
          - pulibrary.matomo
          - pulibrary.pas
          - pulibrary.recap-www
          - pulibrary.ansible-datadog
          - pulibrary.apache2
          - pulibrary.bind9
          - pulibrary.blacklight-app
          - pulibrary.capistrano
          - pulibrary.common
          - pulibrary.deploy-user
          - pulibrary.extra_path
          - pulibrary.ffmpeg
          - pulibrary.fits
          - pulibrary.geoserver
          - pulibrary.mariadb
          - pulibrary.nodejs
          - pulibrary.nginxplus
          - pulibrary.openjdk
          - pulibrary.passenger
          - pulibrary.php
          - pulibrary.rails-app
          - pulibrary.redis
          - pulibrary.ruby
          - pulibrary.rvm

    steps:
      - name: Checkout branch
        uses: actions/checkout@v1
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.7
      - name: Install dependencies
        run: |
          sudo apt install docker
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Disable apparmor
        run: |
          sudo service apparmor stop
          sudo service apparmor teardown
          sudo /usr/sbin/update-rc.d -f apparmor remove
      - name: Run tests
        run: |
          cd roles/${{ matrix.role }}
          molecule test
