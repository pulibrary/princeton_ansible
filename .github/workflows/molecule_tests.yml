---
name: Molecule Tests
on: [push]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - figgy
          - hr_share
          - drupal9
          - researchdata
          - ansible-datadog
          - approvals
          - blacklight-app
          - cantaloupe
          - capistrano
          - drupal
          - ezproxy
          - extra_path
          - figgy_filewatcher_worker
          - figgy_pubsub_worker
          - fits
          - geoserver
          - libwww
          - lib-jobs
          - lib-svn
          - locator
          - matomo
          - pas
          - rails-app
          - recap-www
          - redis
          - subversion
          - svn
          - zookeeper
          - solrcloud
          - consul
          - pas_code
          - dss
          - pulfalight
          - solr
          - libstatic
          - saxon
          - bibdata
          - mudd
          - rubyoffice
          - mailcatcher
          - vips
          - timezone
          - percona
          - simple_annotation
          - apache_tomcat
          - apache_ant
          - apache_maven
          - pulmap
          - memcached
    steps:
      - name: Checkout branch
        run: |
          git config --global http.postBuffer 1048576000
          for i in 1 2 3 4 5; do git clone https://github.com/pulibrary/princeton_ansible.git . && break || sleep 15; done
          git checkout ${{ github.sha }}
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.8
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Disable apparmor
        run: |
          sudo service apparmor stop
          sudo service apparmor teardown
          sudo /usr/sbin/update-rc.d -f apparmor remove
      - name: Run tests
        run: |
          ROLE=${{ matrix.role }} python run_molecule.py
  test-molecule3:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - common
          - deploy_user
          - ruby
          - samba
          - apache2
          - rvm
          - nginxplus
          - nodejs
          - php
          - composer
          - drush
          - postgresql
          - psql
          - ffmpeg
          - openjdk
          - freetds
          - passenger
          - mariadb 
          - imagemagick
          - bind9
    steps:
      - name: Checkout branch
        run: |
          git config --global http.postBuffer 1048576000
          for i in 1 2 3 4 5; do git clone https://github.com/pulibrary/princeton_ansible.git . && break || sleep 15; done
          git checkout ${{ github.sha }}
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.9
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements3.txt
      - name: Disable apparmor
        run: |
          sudo service apparmor stop
          sudo service apparmor teardown
          sudo /usr/sbin/update-rc.d -f apparmor remove
      - name: Run tests
        run: |
          ROLE=${{ matrix.role }} python run_molecule.py
