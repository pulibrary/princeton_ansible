---
# Automates management of the library's Palo Alto firewall
# This playbook can only be run on Ansible Tower
#
- name: View records on the Palo Alto firewall
  hosts: localhost
  vars:
    ansible_python_interpreter: /usr/libexec/platform-python
    panos_provider:
      # ip_address: "{{ secret_ip_address }}"
      ip_address: "{{ provider_IP }}"
      # api_key: "{{ palo_alto_api_key }}"
      api_key: "{{ provider_API_key }}"
  tasks:
    - name: Install required library for pan-os API call
      ansible.builtin.pip:
        name:
          - pan-python
          - pan-os-python

    - name: show interpreter
      ansible.builtin.debug:
        var: ansible_python_interpreter

    - name: install python3 dnf
      ansible.builtin.dnf:
        name: python3-dnf
        state: present
      become: true

    - name: install bind-utils
      ansible.builtin.dnf:
        name: bind-utils
        state: present
      become: true

    - name: Get IP from 'host' command
      ansible.builtin.shell:
        cmd: host {{ VM_host_name }}
        # target_ip: "{{ lookup('dig', 'fs-d12345.efs.ap-southeast-2.amazonaws.com', '@10.75.0.2') }}"
      register: ip_in_question

    # - name: Use lookup to get IPs
    #   ansible.builtin.shell:
    #     cmd: dig {{ VM_host_name }}
    #     # target_ip: "{{ lookup('dig', 'fs-d12345.efs.ap-southeast-2.amazonaws.com', '@10.75.0.2') }}"
    #   register: ip_in_question

    - name: show variable from 'host' command
      ansible.builtin.debug:
        var: ip_in_question

    - name: show just IP from 'host' command
      ansible.builtin.debug:
        msg: >-
          {{ ip_in_question.stdout | regex_findall("[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+") }}

    # - name: Find all address objects
    #   paloaltonetworks.panos.panos_object_facts:
    #     provider: "{{ panos_provider }}"
    #     name_regex: ".*2019.*"
    #     object_type: "address"

    - name: Hardcode a known IP address for testing
      ansible.builtin.set_fact:
        test_ip:
          - "192.168.1.100"

    - name: find object with known IP
      paloaltonetworks.panos.panos_address_object:
        provider: "{{ panos_provider }}"
        state: gathered
        gathered_filter: "ip-netmask contains 192.168.1.100"
      #   gathered_filter: "ip-netmask contains {{ test_ip }}"
      #   gathered_filter: "value contains {{ test_ip }}"
      register: test_object

    - name: show test object address
      ansible.builtin.debug:
        var: test_object

    - name: find address stuff with panos_address_object
      paloaltonetworks.panos.panos_address_object:
        provider: "{{ panos_provider }}"
        state: gathered
        gathered_filter: "*"
      #        gathered_filter: "value contains {{ test_ip }}"
      register: address_stuff

    - name: show address stuff
      ansible.builtin.debug:
        var: address_stuff

    - name: Get a list of all security rules
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ panos_provider }}"
        destination_ip: "{{ test_ip }}"
        state: "gathered"
        gathered_filter: "*"
      register: sec_rules

    - name: show rules stuff
      ansible.builtin.debug:
        var: sec_rules

    - name: Get the definitions for the rules
      paloaltonetworks.panos.panos_security_rule:
        provider: "{{ panos_provider }}"
        state: gathered
        rule_name: "{{ item }}"
      loop:
        - LibLab_OutboundImplicitAllow
        - LibLab_Lib-LabWin2019_Rule1
        - LibLab_ImplicitDeny
        # sec_rules.rule_names???
      register: rule_defs

    - name: show rule defs
      ansible.builtin.debug:
        var: rule_defs
# Future work - create tasks to make changes:
# - name: Generate a new Palo Alto rule set
#   paloaltonetworks.panos.panos_security_rule:
# - name: Commit new firewall rules
#   paloaltonetworks.panos.panos_commit_firewall:

# other relevant docs:
# main collection page: https://paloaltonetworks.github.io/pan-os-ansible/
# module pages we might need:
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_loadcfg.html
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_nat_rule.html
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_security_rule.html
# If we need to create objects, see deprecated module for ref:
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_object.html
