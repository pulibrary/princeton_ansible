---
# Automates management of the library's Palo Alto firewall
# This playbook can only be run on Ansible Tower
#
- name: View records on the Palo Alto firewall
  hosts: localhost
  vars:
    panos_provider:
      ip_address: "{{ secret_ip_address }}"
      api_key: "{{ palo_alto_api_key }}"
  tasks:
  - name: Install required library for pan-os API call
    ansible.builtin.pip:
      name:
        - pan-python
        - pan-os-python

  - name: Get IP for VM we're curious about
    ansible.builtin.shell:
      cmd: nslookup {{ VM_host_name }}
    register: ip_in_question

  - name: show IP
    ansible.builtin.debug:
      var: ip_in_question

  - name: Find all address objects
    paloaltonetworks.panos.panos_object_facts:
      provider: "{{ panos_provider }}"
      name_regex: '.*2019.*'
      object_type: 'address'
    register: address_stuff

  - name: show address stuff
    ansible.builtin.debug:
      var: address_stuff

  - name: Get a list of all security rules
    paloaltonetworks.panos.panos_security_rule_facts:
      provider: "{{ panos_provider }}"
    register: sec_rules
    
  - name: show rules stuff
    ansible.builtin.debug:
      var: sec_rules

  - name: Get the definitions for the rules
    paloaltonetworks.panos.panos_security_rule:
      provider: "{{ panos_provider }}"
      state: gathered
      rule_name: "{{ item }}"
    loop:
      - LibLab_OutboundImplicitAllow
      - LibLab_Lib-LabWin2019_Rule1
      - LibLab_ImplicitDeny
      # sec_rules.rule_names???
    register: rule_defs

  - name: show rule defs
    ansible.builtin.debug:
      var: rule_defs

# Future work - create tasks to make changes:
  # - name: Generate a new Palo Alto rule set
  #   paloaltonetworks.panos.panos_security_rule:
  # - name: Commit new firewall rules
  #   paloaltonetworks.panos.panos_commit_firewall:

# other relevant docs:
# main collection page: https://paloaltonetworks.github.io/pan-os-ansible/
# module pages we might need:
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_loadcfg.html
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_nat_rule.html
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_security_rule.html
# If we need to create objects, see deprecated module for ref:
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_object.html
