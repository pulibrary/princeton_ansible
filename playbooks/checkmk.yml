---
# by default this playbook runs in the staging environment
# to run in production, pass '-e runtime_env=production'
- name: build the checkmk site
  hosts: pulcheck_{{ runtime_env | default('staging') }}
  remote_user: pulsys
  become: true
  vars_files:
    - ../group_vars/checkmk/{{ runtime_env | default('staging') }}.yml
    - ../group_vars/checkmk/vault.yml
  # roles:
    # - role: roles/abid
  tasks:

    - name: Import checkmk role
      ansible.builtin.import_role:
        name: checkmk.general.server

    - name: Run checkmk agent role.
      ansible.builtin.import_role:
        name: checkmk.general.agent

    - name: "Pause."
      ansible.builtin.pause:
        prompt: |
          "Press <Enter> to continue."

- name: build agent connections on a checkmk site
  hosts: sandboxes
  remote_user: pulsys
  become: true
  # gather_facts: false
  vars_files:
    - ../group_vars/checkmk/{{ runtime_env | default('staging') }}.yml
    - ../group_vars/checkmk/vault.yml
  tasks:

            - name: Activate changes on checkmk site - Showcase no changes.
              checkmk.general.activation:
                server_url: "{{ server_url }}"
                site: "{{ site }}"
                automation_user: "{{ automation_user }}"
                automation_secret: "{{ automation_secret }}"
                force_foreign_changes: true
                sites:
                  - "{{ site }}"
              delegate_to: localhost
              run_once: true

            - name: Create team folders. # these values will be informed by other group
              checkmk.general.folder:
                server_url: "{{ server_url }}"
                site: "{{ site }}"
                automation_user: "{{ automation_user }}"
                automation_secret: "{{ automation_secret }}"
                path: "{{ item.path }}"
                title: "{{ item.title }}"
                state: "present"
              delegate_to: localhost
              run_once: true
              loop: "{{ checkmk_folders }}"

            - name: Create a checkmk host.
              checkmk.general.host:
                server_url: "{{ server_url }}"
                site: "{{ site }}"
                automation_user: "{{ automation_user }}"
                automation_secret: "{{ automation_secret }}"
                host_name: "{{ inventory_hostname }}"
                folder: "{{ checkmk_folder_path }}"
                attributes:
                  site: "{{ site }}"
                  ipaddress: 127.0.0.1
                state: "present"
              delegate_to: localhost

            - name: Discover services on host.
              checkmk.general.discovery:
                server_url: "{{ server_url }}"
                site: "{{ site }}"
                automation_user: "{{ automation_user }}"
                automation_secret: "{{ automation_secret }}"
                host_name: "{{ inventory_hostname }}"
                state: "fix_all"
              delegate_to: localhost

            - name: Activate changes on site - Showcase creation of hosts and folders. # checkmk doesn't automatically accept changes
              checkmk.general.activation:
                server_url: "{{ server_url }}"
                site: "{{ site }}"
                automation_user: "{{ automation_user }}"
                automation_secret: "{{ automation_secret }}"
                force_foreign_changes: true
                sites:
                  - "{{ site }}"
              delegate_to: localhost
              run_once: true

            - name: "Pause."
              ansible.builtin.pause:
                prompt: |
                  "Press <Enter> to continue."



  post_tasks:
    - name: tell everyone on slack you ran an ansible playbook
      community.general.slack:
        token: "{{ vault_pul_slack_token }}"
        msg: "Ansible ran `{{ ansible_play_name }}` on {{ inventory_hostname }}"
        channel: "{{ slack_alerts_channel }}"
