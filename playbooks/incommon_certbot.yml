---
# you MUST run this playbook on a single host with '--limit' for example `ansible-playbook -v -e domain_name=datacommons --limit lib-adc2.princeton.edu playbooks/incommon_certbot.yml`
# This playbook will need to be run on both load balancers sequentially
# The domain_name will also be the location that will be utilized in the load balancer config `/etc/letsencrypt/live/datacommons/fullchain.pem;`
# if a valid certificate already exists the existing certificate must be revoked prior to running this playbook for the playbook to change the system
- name: add incommon acme for {{ domain_name }}
  hosts: nginxplus_{{ runtime_env | default('staging') }}
  remote_user: pulsys
  become: true

  pre_tasks:
  - name: stop playbook if you didn't use --limit
    ansible.builtin.fail:
      msg: "you must use -l or --limit"
    when: ansible_limit is not defined
    run_once: true
  vars_files:
    - ../group_vars/all/vars.yml
    - ../group_vars/all/vault.yml

  roles:
    - roles/acme

  tasks:

    #    - name: tell everyone on slack you ran an ansible playbook
    #      community.general.slack:
    #        token: "{{ vault_pul_slack_token }}"
    #        msg: "Ansible ran `{{ ansible_play_name }}` on {{ inventory_hostname }}"
    #        channel: "{{ slack_alerts_channel }}"
