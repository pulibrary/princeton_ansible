---
# installs the Rapid 7 agent
# By defualt this runs on all staging machines. To run on other machines, pass the group on which you want to install the agent at the command line
# Example:
# ansible-playbook -e runtime_env=qa playbooks/rapid7_install.yml
#
#
- name: Install Rapid 7 agent
  hosts: "{{ runtime_env | default('staging') }}"
  vars_files:
    - ../group_vars/all/vault.yml

  tasks:
  - name: Copy Rapid 7 install script to box
    ansible.builtin.copy:
      src: ../bin/Rapid7_agent_installer.sh
      dest: /opt/rapid7/
      owner: pulsys
      group: pulsys
      mode: '0744'
    become: true

  - name: Execute Rapid 7 install script
    ansible.builtin.shell: sudo /opt/rapid7/Rapid7_agent_installer.sh install_start --token {{ vault_Rapid7_token }}

  # - name: Set Rapid 7 service to restart on reboot
  #   module:
  #     param: "{{ if_param_starts_with_var }}"
  #     param2: 2048
  #     param3: RSA
  #
  # - name: Confirm that Rapid 7 agent is running
  #   module:
  #     param: "{{ if_param_starts_with_var }}"
  #     param2: 2048
  #     param3: RSA
  #

# When the agent is down, we see: 
#   pulsys@lib-confluence-staging1:~$ sudo service ir_agent status
# ‚óè ir_agent.service - Rapid7 Insight Agent
#    Loaded: loaded (/etc/systemd/system/ir_agent.service; enabled; vendor preset: enabled)
#    Active: activating (auto-restart) (Result: exit-code) since Wed 2022-11-09 21:11:34 UTC; 9s ago
#   Process: 17615 ExecStart=/opt/rapid7/ir_agent/ir_agent (code=exited, status=203/EXEC)
#  Main PID: 17615 (code=exited, status=203/EXEC)
