---
# installs the Rapid 7 agent
# By default this runs on all staging machines. To run on other machines, pass the group on which you want to install the agent at the command line
# Example:
# ansible-playbook -e runtime_env=qa playbooks/rapid7_install.yml
#
#
- name: Install Rapid 7 agent
  hosts: "{{ runtime_env | default('staging') }}"
  vars_files:
    - ../group_vars/all/vault.yml

  tasks:
  - name: Copy Rapid 7 install script to box
    ansible.builtin.copy:
      src: ../bin/Rapid7_agent_installer.sh
      dest: /opt/rapid7/
      owner: pulsys
      group: pulsys
      mode: '0744'
    become: true

  - name: Execute Rapid 7 install script
    ansible.builtin.shell: sudo /opt/rapid7/Rapid7_agent_installer.sh install_start --token {{ vault_Rapid7_token }} --attributes="library"

  # - name: Set Rapid 7 service to restart on reboot
  #   module:
  #     param: "{{ if_param_starts_with_var }}"
  #     param2: 2048
  #     param3: RSA
  #
  # - name: Confirm that Rapid 7 agent is running
  #   module:
  #     param: "{{ if_param_starts_with_var }}"
  #     param2: 2048
  #     param3: RSA
  #
