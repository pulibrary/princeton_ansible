---
# Extensive documentation our Nomad infrastructure found in
# roles/pul_nomad/README.md
#
# Examples:
#   Only app config:                       ansible-playbook playbooks/nomad.yml --tags dpulc
#   Provision prod but skip app config:    ansible-playbook playbooks/nomad.yml -e runtime_env=production --skip-tags app_config
#   Target sandbox:                        ansible-playbook playbooks/nomad.yml -e runtime_env=sandbox

- name: build the nomad cluster
  hosts: "nomad_{{ runtime_env | default('sandbox') }}"
  remote_user: pulsys
  become: true

  # Vault files (env-agnostic secrets or per-env keys within)
  vars_files:
    # This will auto include group_vars/nomad_clients.yml for clients
    # This will auto include group_vars/nomad_servers.yml for servers
    # This will auto include group_vars/nomad_[clients/servers]_[env].yml
    # This will auto include host_vars/<hosthere>.yml for specific clients.
    - ../group_vars/nomad/vault.yml
    - ../group_vars/nomad/dpulc/vault.yml
    - ../group_vars/nomad/imagecat/vault.yml
    - ../group_vars/nomad/abid/vault.yml
    - ../group_vars/nomad/logging/vault.yml
    - ../group_vars/nomad/traefik_wall/vault.yml
    - ../group_vars/nomad/circleci_deployer/vault.yml
    - ../group_vars/nomad/analytics/vault.yml
    - ../group_vars/nomad/cdh_baserow/sandbox.yml
    - ../group_vars/nomad/cdh_baserow/vault.yml
    - ../group_vars/nomad/nodemation/vault.yml
    - ../group_vars/nomad/signoz/vault.yml
    - ../group_vars/nomad/signoz/sandbox.yml
  pre_tasks:
  - name: Discover app var files for this env
    ansible.builtin.stat:
      path: "../group_vars/nomad/{{ item }}/{{ runtime_env | default('sandbox') }}.yml"
    register: app_env_stats
    loop: "{{ nomad_enabled_apps | default([]) }}"

  - name: Load app vars for this env (only if present)
    ansible.builtin.include_vars:
      file: "../group_vars/nomad/{{ item.item }}/{{ runtime_env | default('sandbox') }}.yml"
    loop: "{{ app_env_stats.results | default([]) }}"
    when: item.stat.exists

  - name: Discover app vault files
    ansible.builtin.stat:
      path: "../group_vars/nomad/{{ item }}/vault.yml"
    register: app_vault_stats
    loop: "{{ nomad_enabled_apps | default([]) }}"

  - name: Load app vault vars (only if present)
    ansible.builtin.include_vars:
      file: "../group_vars/nomad/{{ item.item }}/vault.yml"
    loop: "{{ app_vault_stats.results | default([]) }}"
    when: item.stat.exists

  roles:
    - role: pul_nomad
  post_tasks:
    - name: tell everyone on slack you ran an ansible playbook (controller-only)
      community.general.slack:
        token: "{{ vault_pul_slack_token }}"
        msg: "Ansible ran `{{ ansible_play_name }}` for {{ runtime_env | default('sandbox') }} on {{ groups['nomad_' ~ (runtime_env | default('sandbox')) ] | length }} hosts"
        channel: "{{ slack_alerts_channel }}"
      delegate_to: localhost
      run_once: true
      when:
        - (notify_slack | default(true))            # allow per-env override
      tags: [notify]
