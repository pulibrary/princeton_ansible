---
# Automates management of the library's Palo Alto firewall
# This playbook can only be run on Ansible Tower
#
- name: Back up firewall configuration, reload as necessary
  hosts: localhost
  gather_facts: no

  vars:
    ansible_python_interpreter: /usr/libexec/platform-python
    panos_provider:
      ip_address: "{{ provider_IP }}"
      api_key: "{{ provider_API_key }}"

  tasks:
# if we can use the Pan-OS API to export and update firewall config,
# we can delete these first three tasks from this playbook

    - name: Install required library for pan-os API call
      ansible.builtin.pip:
        name:
          - pan-python
          - pan-os-python

    - name: install python3 dnf and bind-utils
      ansible.builtin.dnf:
        name:
          - python3-dnf
          - bind-utils
        state: present
      become: true

    - name: See if we can connect to the test firewall by checking the config name
      paloaltonetworks.panos.panos_facts:
        # see https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_facts.html
        gather_subset: 'config'
        provider: "{{ panos_provider }}"

# copied and adapted from
# https://github.com/wpacket/pan-ansible/blob/master/pan_config_pull.yml
# These tasks extract the running config and save it locally

    - name: Backup firewall configuration using API
      ansible.builtin.uri:
        validate_certs: no
        url: "https://{{ provider_IP }}/api/?type=config&action=show&key={{ provider_API_key }}"
        return_content: yes
        method: GET
      register: configuration_string

    - name: Remove XML header and save configuration file
      ansible.builtin.copy:
        content: "{{configuration_string['content']  | regex_replace('<response.*<result>') | regex_replace('</result></response>')}}"
        dest: '/opt/dev-firewall.txt'

    - name: Read content of configuration file
      ansible.builtin.shell:
        cmd: cat /opt/dev-firewall.txt
        # click on the output for this task in Tower
        # then look at the Output tab to see the file contents

# Future work:
# 1. Put the exported configuration file under source control (private GitHub repo?)
# 2. Allow changes to the configuration file (pull requests)
# 3. Create tasks to push and commit changed configuration:
# - name: Push updated config to the Palo Alto API
#   ansible.builtin.uri:
#     validate_certs: no
#     url: "https://{{ provider_IP }}/api/?type=config&action=show&key={{ provider_API_key }}"
#
# - name: Commit new firewall rules
#   paloaltonetworks.panos.panos_commit_firewall:
#
# 4. Connect to ServiceNow for additional auditability
# 5. Rename the playbook to reflect what it does, update the Tower template

# other relevant docs:
# main collection page: https://paloaltonetworks.github.io/pan-os-ansible/
# module pages we might need:
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_loadcfg.html
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_nat_rule.html
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_security_rule.html
# If we need to create objects, see deprecated module for ref:
# https://paloaltonetworks.github.io/pan-os-ansible/modules/panos_object.html
