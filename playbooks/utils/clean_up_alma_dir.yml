---
- name: Delete oldest files from /alma directories
  hosts: libsftp_{{ runtime_env | default ('staging') }}
  remote_user: pulsys
  become: true

  vars:
    slack_alerts_channel: infrastructure

  tasks:
    - set_fact:
        mount: "{{ ansible_mounts[0] }}"
    - set_fact: disk_usage="{{ mount.size_total - mount.size_available }}"
    - set_fact: disk_usage_ratio="{{ disk_usage|float / mount.size_total }}"
    - set_fact: disk_usage_s="{{ (disk_usage|float / 1000000000) | round(1, 'common') }}GB"
    - set_fact: disk_total_s="{{ (mount.size_total / 1000000000) | round(1, 'common') }}GB"

    - name: identify old files
      # equivalent of find /alma/ -type f -not -newermt "2024-01-01" -ls
      ansible.builtin.find:
        paths: /alma/publishing
        age: 20w # twelve weeks old, roughly 3 months
        file_type: file
        recurse: true
      register: files_to_delete

    - name: show old files
      ansible.builtin.debug:
        var: item.path
      loop: "{{ files_to_delete.files }}"
      # msg: "{{ files_to_delete[item.path] }}"
    # loop: "{{ files_to_delete.keys() | list }}"
    # The task includes an option with an undefined variable.
    # The error was: 'ansible.utils.unsafe_proxy.AnsibleUnsafeText object' has no attribute 'path'.

    - name: delete old files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop: "{{ files_to_delete }}"

  post_tasks:
    - name: let folks on slack know the state of the directories
      community.general.slack:
        token: "{{ vault_tower_slack_token }}"
        msg: "Ansible has successfully deleted old files from /alma on libsftp_{{ runtime_env | default('staging') }}. The {{ ansible_mounts[0].mount }} disk was using {{ disk_usage_s }} or {{ disk_usage_ratio }} of the space, before deleting."
        channel: "{{ slack_alerts_channel }}"
