---
# Description:
#   1. Deploys one CheckMK local‚Äêcheck script per path in `log_growth_targets`
#      (all thresholds and interval are static).
#   2. Deploys any other local checks listed in `checkmk_local_scripts`.
#   3. Triggers CheckMK discovery & activation.
#
# Usage:
#   ansible-playbook playbooks/utils/checkmk_add_local_checks.yml \
#     --ask-vault-pass \
#     --limit pdc-describe-staging2.princeton.edu \
#     -e "runtime_env=staging rule_group=rails \
#         log_growth_targets=['/var/log/myapp/app.log','/var/log/other/service.log']"
#
- name: Install CheckMk local check scripts on host
  hosts: "{{ runtime_env | default('staging') }}"
  remote_user: pulsys
  become: true

  vars_files:
    - ../../group_vars/all/vault.yml
    - ../../group_vars/checkmk/{{ runtime_env | default('staging') }}.yml
    - ../../group_vars/checkmk/rule_{{ rule_group | default('rails') }}.yml
    - ../../group_vars/checkmk/agent_common.yml
    - ../../group_vars/checkmk/vault.yml

  # static thresholds & interval for log-growth checks:
  vars:
    log_growth_interval: 300   # seconds
    log_growth_warn_mb_per_hour: 20    # MB/h
    log_growth_crit_mb_per_hour: 30    # MB/h

  pre_tasks:
    - name: stop playbook if you didn't use --limit
      fail:
        msg: "you must use -l or --limit"
      when: ansible_limit is not defined
      run_once: true

    - name: set stripped agent hostname (only content before the first .) as fact
      ansible.builtin.set_fact:
        checkmk_agent_host_name: "{{ inventory_hostname | regex_search('^[^.]*') }}"

  tasks:
    - name: Ensure CheckMK local-checks dir exists
      ansible.builtin.file:
        path: /usr/lib/check_mk_agent/local
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Deploy CheckMK log-growth local checks
      ansible.builtin.template:
        src: "../../group_vars/checkmk/local_check_templates/log_growth.sh.j2"
        dest: "/usr/lib/check_mk_agent/local/log_growth_{{ item | basename }}.sh"
        owner: root
        group: root
        mode: '0755'
      loop: "{{ log_growth_targets }}"
      loop_control:
        label: "{{ item }}"
      vars:
        log_growth_logfile: "{{ item }}"
        log_growth_statefile: "/var/lib/check_mk_agent/state/{{ item | basename }}.size"
        # thresholds/interval inherited from play vars

    - name: Deploy other CheckMK local-check scripts
      ansible.builtin.template:
        src: "../../group_vars/checkmk/local_check_templates/{{ item.template }}"
        dest: "/usr/lib/check_mk_agent/local/{{ item.dest }}"
        mode: "+x"
      loop: "{{ checkmk_local_scripts }}"

    - name: Add new local services on hosts
      checkmk.general.discovery:
        server_url: "{{ checkmk_agent_server_protocol }}://{{ checkmk_agent_server }}"
        site: "{{ checkmk_agent_site }}"
        automation_user: "{{ checkmk_agent_user }}"
        automation_secret: "{{ vault_automation_secret }}"
        hosts: "{{ checkmk_agent_host_name }}"
        state: "new"

    - name: Start activation including foreign changes
      checkmk.general.activation:
        server_url: "{{ checkmk_agent_server_protocol }}://{{ checkmk_agent_server }}"
        site: "{{ checkmk_agent_site }}"
        automation_user: "{{ checkmk_agent_user }}"
        automation_secret: "{{ vault_automation_secret }}"
        force_foreign_changes: true
