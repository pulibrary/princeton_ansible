---
- name: Rebuild solr shards
  hosts: solr8cloud_{{ runtime_env | default('staging') }}
  # hosts: staging:qa:production
  remote_user: pulsys
  # become: true

  tasks:
    - name: get data from solr
      ansible.builtin.uri:
        url: http://localhost:8983/solr/admin/collections?action=CLUSTERSTATUS
        # return_content: true
      register: solr_collections
      
    - name: view solr_collections
      ansible.builtin.debug:
        var: solr_collections

    # - name: generate a variable that we can use 
    #   ansible.builtin.debug:
    #   Examples: msg: |

    - name: find dead replicas
      ansible.builtin.debug:
        var: solr_collections.collections
        # dead_replicas: "{{ solr_collections.virtual_machines | rejectattr('tags') | map(attribute='guest_name') }}"

    # The {{ vm_to_reboot }} VM
    # is on the {{ vm_info.virtual_machines[0].esxi_hostname }} host (a = Forrestal, b = New South)
    # has a mac address of {{ vm_info.virtual_machines[0].mac_address[0] }}
    # {{ vm_info.virtual_machines[0].allocated.cpu }} CPUs
    # {{ (vm_info.virtual_machines[0].allocated.memory | int / 1024) }} GB of memory
    # and {{ vm_info.virtual_machines[0].allocated.storage | human_readable }} of disk allocated
    # on the {{ vm_info.virtual_machines[0].datastore_url[0].name }} storage node in vSphere.
    # msg: "Distro: {{ ansible_distribution }}, Version: {{ ansible_distribution_version}}"

    #   - name: Find VMs without tags
    # ansible.builtin.set_fact:
    #   untagged_vms: "{{ vms_and_tags.virtual_machines | rejectattr('tags') | map(attribute='guest_name') }}"

    # - name: view the variable
    #   ansible.builtin.debug:
    #     msg: "Distro: {{ ansible_distribution }}, Version: {{ ansible_distribution_version}}"

    # - name: add shards
    #   ansible.builtin.debug:
    #     http://localhost:8983/solr/admin/collections?action=ADDREPLICA&collection=catalog-performance&shard=shard1&node=lib-solr-staging5d.princeton.edu:8983_solr
    #     msg: "Distro: {{ ansible_distribution }}, Version: {{ ansible_distribution_version}}"

    # - name: delete shards
    #   ansible.builtin.debug:
    #   http://localhost:8983/solr/admin/collections?action=DELETEREPLICA&collection=catalog-performance&shard=shard1&replica=core_node22
    #     msg: "Distro: {{ ansible_distribution }}, Version: {{ ansible_distribution_version}}"