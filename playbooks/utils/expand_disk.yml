---
#  This playbook will expand the disk on a new vm
#     
- name: expand disk
  hosts: all
  remote_user: pulsys
  become: true

  vars:
    slack_alerts_channel: infrastructure

  vars_files:
    - ../../group_vars/all/vault.yml

  pre_tasks:
    - name: stop playbook if you didn't use --limit
      ansible.builtin.fail:
        msg: "you must use -l or --limit"
      when: ansible_limit is not defined
      run_once: true

  tasks:
    - name: check the starting disk size
      ansible.builtin.command: df -h
      register: starting_disk_size

    - name: check the starting lv size
      ansible.builtin.set_fact: 
        starting_lv_size: "{{ starting_disk_size.stdout_lines[2].split()[1] }}"

    - name: view the starting_disk_size
      ansible.builtin.debug:
        var: starting_lv_size

    - name: End the play if the disk is expanded
      ansible.builtin.meta: end_host
      when:
      - starting_lv_size == '28G'

    - name: gather name of the logical volume
      ansible.builtin.command: sudo lvdisplay
      register: logical_volume

    - name: view the ansible_facts
      ansible.builtin.debug:
        var: ansible_facts

    - name: view the logical volume
      ansible.builtin.debug:
        var: logical_volume

    - name: gather the logical volume path
      ansible.builtin.set_fact:
        lv_path: "{{ logical_volume.stdout_lines[1] | split | last }}"

    - name: view lv_path
      ansible.builtin.debug:
        var: lv_path

    - name: extend the size of the logical volume
      ansible.builtin.command: sudo lvextend -l +100%FREE "{{ lv_path }}"

    - name: resize the filesystem to use the newly allocated space
      ansible.builtin.command: sudo resize2fs "{{ lv_path }}"

    - name: check the new disk size
      ansible.builtin.command: df -h
      register: new_disk_size

  post_tasks:
  - name: let folks on slack know the disk status
    community.general.slack:
      token: "{{ vault_tower_slack_token }}"
      msg: "Ansible has successfully updated the disk from `{{ starting_disk_size }}` to `{{ new_disk_size }}` on the `{{ inventory_hostname }}` VM"
      channel: "{{ slack_alerts_channel }}"
