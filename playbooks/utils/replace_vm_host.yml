---
#  This playbook deletes a VM and replaces it from a vSphere template. This is the only warning you will get. Running this playbook has destructive consequences!
#  This playbook should only be run from ansible tower.  No need for detailed instructions of examples here, because you should not run it here.
#
- name: replace the {{ replacement_vm }} VM on the {{ runtime_env | default('staging') }} vSphere
  hosts: localhost
  remote_user: pulsys
  become: true

  vars:
    slack_alerts_channel: "#infrastructure"

  vars_files:
    - ../../group_vars/all/vault.yml
    - ../../group_vars/vsphere/vault.yml
    - ../../group_vars/vsphere/{{ runtime_env | default('staging') }}.yml

  tasks:
    - name: Gather info on VM to replace
      community.vmware.vmware_vm_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        vm_name: "{{ replacement_vm }}"
        validate_certs: false
      register: old_vm_info

    - name: Print out old VM information
      ansible.builtin.debug:
        var: old_vm_info

    - name: Gather network info on VM to replace
      community.vmware.vmware_guest_network:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        name: "{{ replacement_vm }}"
        validate_certs: false
        gather_network_info: true
      register: old_vm_net_info

    - name: Print out old VM network information
      ansible.builtin.debug:
        var: old_vm_net_info

    - name: Print out warning
      ansible.builtin.debug:
        msg: My Network Name is {{ old_vm_net_info.network_info[0].network_name  }} and my MAC Address is {{ old_vm_net_info.network_info[0].mac_address }}
