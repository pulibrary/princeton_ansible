---
#  This playbook deletes a VM and replaces it from a vSphere template. This is the only warning you will get. Running this playbook has destructive consequences!
#  This playbook should only be run from ansible tower.  No need for detailed instructions of examples here, because you should not run it here.
#
- name: replace the {{ replacement_vm }} VM on the {{ runtime_env | default('staging') }} vSphere
  hosts: localhost
  remote_user: pulsys
  become: true

  vars:
    slack_alerts_channel: "#infrastructure"

  vars_files:
    - ../../group_vars/all/vault.yml
    - ../../group_vars/vsphere/vault.yml
    - ../../group_vars/vsphere/{{ runtime_env | default('staging') }}.yml

  tasks:
    - name: Gather info on VM to replace
      community.vmware.vmware_vm_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        vm_name: "{{ replacement_vm }}"
        validate_certs: false
        show_allocated: true
      register: old_vm_info

    - name: Print out old VM information
      ansible.builtin.debug:
        var: old_vm_info

    - name: Gather network info on VM to replace
      community.vmware.vmware_guest_network:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        name: "{{ replacement_vm }}"
        validate_certs: false
        gather_network_info: true
      register: old_vm_net_info

    - name: Print out old VM network information
      ansible.builtin.debug:
        var: old_vm_net_info

    - name: Print out warning
      ansible.builtin.debug:
        msg: Ansible will now move and power off the current {{ old_vm_info.virtual_machines[0].guest_name }} VM, then create a replacement in the {{ old_vm_net_info.network_info[0].network_name }} network.

    - name: Move old VM to the ToBeDeleted folder
      community.vmware.vmware_guest_move:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false
        datacenter: "{{ vcenter_datacenter }}"
        dest_folder: "{{ vm_delete_me_folder }}"
        uuid: "{{ old_vm_info.virtual_machines[0].uuid }}"

    - name: Power off old VM using UUID
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false
        datacenter: "{{ vcenter_datacenter }}"
        uuid: "{{ old_vm_info.virtual_machines[0].uuid }}"
        state: powered-off

    - name: Create a new virtual machine from a template
      community.vmware.vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: false
        datacenter: "{{ vcenter_datacenter }}"
        cluster: "{{ vcenter_cluster }}"
        folder: "{{ old_vm_info.virtual_machines[0].folder }}"
        name: "{{ replacement_vm }}"
        state: powered-on
        template: "{{ vm_template | default('template_jammy_spring_2024')}}"
        disk:
          - size: "{{ (old_vm_info.virtual_machines[0].allocated.storage / 1024) | int }}kb"
            # we are not able to use 'type: thin' with our fall 2024 templates
            # type: thin
            datastore: "{{ old_vm_info.virtual_machines[0].datastore_url }}"
        # TODO: Add another disk from an existing VMDK
        hardware:
          memory_mb: "{{ old_vm_info.virtual_machines[0].allocated.memory | int | default('16384') }}"
          num_cpus: "{{ old_vm_info.virtual_machines[0].allocated.cpu | int | default('2') }}"
          num_cpu_cores_per_socket: "{{ vm_cpu_cores | default('1') }}"
          scsi: paravirtual
          version: latest # Hardware version of virtual machine
          boot_firmware: "efi"
        cdrom:
          - controller_number: 0
            unit_number: 0
            state: poweredoff
        networks:
          - connected: true
            device_type: vmxnet3
            name: VM Network - ip4-library-servers
            mac: 00:50:56:ac:12:24
            start_connected: true
        wait_for_customization: true
