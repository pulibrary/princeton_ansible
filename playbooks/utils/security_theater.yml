---
# This playbook will install OIT mandated security tools Rapid7 and Cortex XDR
# By default this playbook runs on all hosts in the three environment groups. To run against a single host or group, use '--limit <group_or_host_name>'. For example '--limit qa' or '--limit figgy-web-staging1.princeton.edu'."
#
- name: install OIT Security Tools on a host
  hosts: all
  remote_user: pulsys
  become: true
  serial: "{{ concurrent_vms | default('5') }}"
  vars_files:
    - ../../group_vars/xdr/vault.yml
    - ../../group_vars/xdr/vars.yml
    - ../../group_vars/all/vars.yml
    - ../../group_vars/all/vault.yml

  pre_tasks:
  - name: Populate service facts
    ansible.builtin.service_facts:

  - name: Populate package facts
    ansible.builtin.package_facts:

  tasks:
  - name: check for the falcon log file
    ansible.builtin.stat:
      path: "/var/log/falcon-sensor.log"
      # path: "/var/log/falcon-libbpf.log"
    register: falcon_configured

  - name: set to greenfield if falcon log is absent
    ansible.builtin.set_fact:
      install_type: greenfield
      xdr_version: "{{ greenfield_xdr_version }}"
    when:
      - not falcon_configured.stat.exists
    # when:
    #   - "'falcon-sensor' not in ansible_facts.services"

  - name: set to brownfield if falcon log is present
    ansible.builtin.set_fact:
      install_type: brownfield
      xdr_version: "{{ brownfield_xdr_version }}"
    when:
      - falcon_configured.stat.exists
    # when:
    #   - "'falcon-sensor' not in ansible_facts.services"

  - name: Download the XDR deb file (Ubuntu)
    ansible.builtin.unarchive:
      src: "https://pulmirror.princeton.edu/mirror/palo/{{ install_type }}/Linux-{{ xdr_version }}_deb.tar.gz"
      dest: /opt/
      creates: /opt/{{ cortex_install }}.deb
      remote_src: true
    become: true
    when:
      - ansible_os_family == "Debian"

  - name: Download the XDR rpm file (RedHat)
    ansible.builtin.unarchive:
      src: "https://pulmirror.princeton.edu/mirror/palo/{{ install_type }}/Linux-{{ xdr_version }}_rpm.tar.gz"
      dest: /opt/
      creates: /opt/{{ cortex_install }}.rpm
      remote_src: true
    become: true
    when:
      - ansible_os_family == "RedHat"

  - name: Install Cortex XDR dependencies (RedHat)
    ansible.builtin.dnf:
      name: selinux-policy-devel
      state: present
    become: true
    when:
      - ansible_os_family == "RedHat"

  # Create config directory
  - name: Create /etc/panw directory
    ansible.builtin.file:
      path: /etc/panw
      state: directory
      owner: root
      group: root
      mode: '0755'
    become: true

  # Build the config file
  - name: Build the XDR config file
    ansible.builtin.copy:
      content: |
        --distribution-id {{ xdr_vault_distribution_id }}
        --distribution-server {{ xdr_distribution_server }}
      dest: /etc/panw/cortex.conf
      owner: root
      group: root
      mode: '0744'
    become: true

  # apt module equiv of sudo dpkg -i filename for ubuntu
  - name: install XDR agent (Ubuntu)
    ansible.builtin.apt:
      deb: "/opt/{{ cortex_install }}.deb"
    when:
      - ansible_os_family == "Debian"

  # yum module equiv of sudo yum -y install for rocky
  - name: install XDR agent (RedHat)
    ansible.builtin.dnf:
      name: "/opt/{{ cortex_install }}.rpm"
      state: present
      disable_gpg_check: true
    when:
      - ansible_os_family == "RedHat"
  #
  # Force agent checkin after installation
  - name: Run cytool checkin
    ansible.builtin.command:
      cmd: /opt/traps/bin/cytool checkin
    become: true
    register: cytool_result
    changed_when: cytool_result.rc == 0

  - name: Install, configure, and start BigFix
    when: "ansible_facts.services['besclient.service'] is not defined"
    block:
      - name: Import BigFix GPG key
        ansible.builtin.rpm_key:
          state: present
          key: https://software.bigfix.com/download/bes/95/RPM-GPG-KEY-BigFix-9-V2
        when:
          - ansible_os_family == "RedHat"

      - name: Create bigfix directory
        ansible.builtin.file:
          path: /etc/opt/BESClient
          state: directory
          mode: '0755'

      - name: Download BigFix masthead
        ansible.builtin.get_url:
          url: "{{ vault_bigfix_url }}"
          dest: "/etc/opt/BESClient/actionsite.afxm"
          owner: root
          group: root
          mode: "0600"

      - name: Download the bigfix deb file (Ubuntu)
        ansible.builtin.get_url:
          url: "https://software.bigfix.com/download/bes/100/BESAgent-10.0.7.52-debian6.amd64.deb"
          dest: "/tmp/BESAgent-10.0.7.52-debian6.amd64.deb"
          owner: pulsys
          group: pulsys
          mode: "0644"
        when:
        - ansible_os_family == "Debian"

      - name: Download the bigfix deb file (RedHat)
        ansible.builtin.get_url:
          url: "https://software.bigfix.com/download/bes/100/BESAgent-10.0.7.52-rhe6.x86_64.rpm"
          dest: "/tmp/BESAgent-10.0.7.52-rhel6.x86_64.rpm"
          owner: pulsys
          group: pulsys
          mode: "0644"
        when:
        - ansible_os_family == "RedHat"

      - name: install BESClient agent (Ubuntu)
        ansible.builtin.apt:
          deb: "/tmp/BESAgent-10.0.7.52-debian6.amd64.deb"
        when:
          - ansible_os_family == "Debian"

      - name: install BESClient agent (RedHat)
        ansible.builtin.dnf:
          name: "/tmp/BESAgent-10.0.7.52-rhel6.x86_64.rpm"
          state: present
        when:
          - ansible_os_family == "RedHat"

      - name: Launch the BigFix client
        ansible.builtin.command: /etc/init.d/besclient start
      #For future maintenance, BigFix block ends here

  - name: Install, configure, and start Rapid7
    when: "ansible_facts.services['ir_agent.service'] is not defined"
    block:
      - name: Download the Rapid7 deb file (Ubuntu)
        ansible.builtin.get_url:
          url: "https://us.storage.endpoint.ingress.rapid7.com/com.rapid7.razor.public/endpoint/agent/latest/linux/x86_64/rapid7_insight_agent_x64.deb"
          dest: "/tmp/rapid7-insight-agent_latest_amd64.deb"
          mode: "0644"
        when:
          - ansible_os_family == "Debian"

      - name: Download the Rapid7 rpm file (RedHat)
        ansible.builtin.get_url:
          url: "https://us.storage.endpoint.ingress.rapid7.com/com.rapid7.razor.public/endpoint/agent/latest/linux/x86_64/rapid7_insight_agent_x64.rpm"
          dest: "/tmp/rapid7-insight-agent-latest.x86_64.rpm"
          mode: "0644"
        when:
          - ansible_os_family == "RedHat"

      - name: install Rapid7 agent (Ubuntu)
        ansible.builtin.apt:
          deb: "/tmp/rapid7-insight-agent_latest_amd64.deb"
        become: true
        when:
          - ansible_os_family == "Debian"

      - name: Verify GPG signature (RedHat)
        ansible.builtin.rpm_key:
          state: present
          key: https://us.storage.endpoint.ingress.rapid7.com/com.rapid7.razor.public/endpoint/agent/latest/linux/x86_64/Rapid7_public_key.pub
        become: true
        when:
          - ansible_os_family == "RedHat"

      - name: install Rapid7 agent (RedHat)
        ansible.builtin.yum:
          name: "/tmp/rapid7-insight-agent-latest.x86_64.rpm"
          state: present
        become: true
        when:
          - ansible_os_family == "RedHat"

      # - name: Configure the agent with token
      #   ansible.builtin.shell:
      #     /opt/rapid7/ir_agent/components/insight_agent/{{ rapid7_version }}/configure_agent.sh --token {{ vault_Rapid7_token }} --attributes="Library Systems"
      #   become: true

      - name: Restart or start rapid7
        ansible.builtin.service:
          name: ir_agent
          state: restarted
        become: true

  # post_tasks:
  #   - name: send information to slack
  #     ansible.builtin.include_tasks:
  #       file: slack_tasks_end_of_playbook.yml
