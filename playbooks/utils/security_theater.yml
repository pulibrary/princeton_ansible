---
#  This playbook will install OIT recommended security tools Rapid7 and Crowdstrike
# By default this playbook runs on all hosts in the three environment groups. To run against a single host or group, use '--limit <group_or_host_name>'. For example '--limit qa' or '--limit figgy-web-staging1.princeton.edu'."
#
- name: install OIT Security Tools on a host
  hosts: all
  remote_user: pulsys
  serial: "{{ concurrent_vms | default('5') }}"
  vars_files:
    - ../../group_vars/crowdstrike/vault.yml
    - ../../group_vars/crowdstrike/vars.yml
    - ../../group_vars/all/vars.yml
    - ../../group_vars/all/vault.yml
  
  pre_tasks: 
  - name: Populate service facts
    ansible.builtin.service_facts:

  - name: Populate package facts
    ansible.builtin.package_facts:

  tasks:
  - name: Download the Rapid7 deb file (Ubuntu)
    ansible.builtin.get_url:
      url: "https://isoshare.cpaneldev.princeton.edu/isoShares/Agents/Rapid7/Latest/Linux/rapid7-insight-agent_{{ rapid7_version }}-1_amd64.deb"
      dest: "/tmp/rapid7-insight-agent_{{ rapid7_version }}-1_amd64.deb"
      mode: "0644"
    when:
      - ansible_os_family == "Debian"

  - name: Download the Rapid7 rpm file (RedHat)
    ansible.builtin.get_url:
      url: "https://isoshare.cpaneldev.princeton.edu/isoShares/Agents/Rapid7/Latest/Linux/rapid7-insight-agent-{{ rapid7_version }}-1.x86_64.rpm"
      dest: "/tmp/rapid7-insight-agent-{{ rapid7_version }}-1.x86_64.rpm"
      mode: "0644"
    when:
      - ansible_os_family == "RedHat"

  - name: install Rapid7 agent (Ubuntu)
    ansible.builtin.apt:
      deb: "/tmp/rapid7-insight-agent_{{ rapid7_version }}-1_amd64.deb"
    become: true
    when:
      - ansible_os_family == "Debian"

  - name: Verify GPG signature (RedHat)
    ansible.builtin.rpm_key:
      state: present
      key: https://us.storage.endpoint.ingress.rapid7.com/com.rapid7.razor.public/endpoint/agent/latest/linux/x86_64/Rapid7_public_key.pub
    become: true
    when:
      - ansible_os_family == "RedHat"

  - name: install Rapid7 agent (RedHat)
    ansible.builtin.yum:
      name: "/tmp/rapid7-insight-agent-{{ rapid7_version }}-1.x86_64.rpm"
      state: present
    become: true
    when:
      - ansible_os_family == "RedHat"

  - name: Configure the agent with token
    ansible.builtin.shell:
      /opt/rapid7/ir_agent/components/insight_agent/{{ rapid7_version }}/configure_agent.sh --token {{ vault_Rapid7_token }} --attributes="Library Systems"
    become: true

  - name: Restart or start rapid7
    ansible.builtin.service:
      name: ir_agent
      state: restarted
    become: true

  # post_tasks:
  #   - name: send information to slack
  #     ansible.builtin.include_tasks:
  #       file: slack_tasks_end_of_playbook.yml
