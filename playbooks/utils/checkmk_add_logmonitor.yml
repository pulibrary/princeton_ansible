---
# Description: Deploys a CheckMK local check script to monitor log-growth rate of any log file.
#
# Requirements:
#  - CheckMK agent must be installed on target hosts.
#
# Variables (defaults can be overridden via -e):
#   log_growth_logfile          Path to the log to watch
#   log_growth_statefile        Where to store the previous size
#   log_growth_interval         Agent run interval in seconds
#   log_growth_warn_mb_per_hour Warning threshold in MB/hour
#   log_growth_crit_mb_per_hour Critical threshold in MB/hour
#
# Usage example:
#   ansible-playbook checkmk_log_growth.yml -i inventory \
#     -e "log_growth_logfile=/var/log/custom.log \
#         log_growth_statefile=/var/lib/check_mk_agent/state/custom.size \
#         log_growth_interval=600 \
#         log_growth_warn_mb_per_hour=10 \
#         log_growth_crit_mb_per_hour=20"

- name: Install CheckMk local check scripts on host
  hosts: "{{ runtime_env | default ('staging') }}"
  remote_user: pulsys
  become: true
  vars:
    log_growth_logfile: "/var/log/myapp/app.log"
    log_growth_statefile: "/var/lib/check_mk_agent/state/app.log.size"
    log_growth_interval: 300
    log_growth_warn_mb_per_hour: 20
    log_growth_crit_mb_per_hour: 30
  vars_files:
    - ../../group_vars/all/vault.yml
    - ../../group_vars/checkmk/{{ runtime_env | default('staging') }}.yml
    - ../../group_vars/checkmk/agent_common.yml
    - ../../group_vars/checkmk/vault.yml

  pre_tasks:
    - name: stop playbook if you didn't use --limit
      fail:
        msg: "you must use -l or --limit"
      when: ansible_limit is not defined
      run_once: true
    - name: set stripped agent hostname (only content before the first .) as fact
      ansible.builtin.set_fact:
        checkmk_agent_host_name: "{{ inventory_hostname | regex_search('^[^.]*') }}"

  tasks:
    - name: Ensure CheckMK local checks directory exists
      ansible.builtin.file:
        path: /usr/lib/check_mk_agent/local
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Deploy CheckMK log-growth local check script
      ansible.builtin.template:
        src: "../../group_vars/checkmk/local_check_templates/log_growth.sh.j2"
        dest: "/usr/lib/check_mk_agent/local/log_growth.sh"
        mode: "+x"

    - name: "Add new local services on hosts."
      checkmk.general.discovery:
        server_url: "{{ checkmk_agent_server_protocol }}://{{ checkmk_agent_server }}"
        site: "{{ checkmk_agent_site }}"
        automation_user: "{{ checkmk_agent_user }}"
        automation_secret: "{{ vault_automation_secret }}"
        hosts: "{{ checkmk_agent_host_name }}"
        state: "new"

    - name: "Start activation including foreign changes."
      checkmk.general.activation:
        server_url: "{{ checkmk_agent_server_protocol }}://{{ checkmk_agent_server }}"
        site: "{{ checkmk_agent_site }}"
        automation_user: "{{ checkmk_agent_user }}"
        automation_secret: "{{ vault_automation_secret }}"
        force_foreign_changes: 'true'
