---
# To run the playbook:
# ansible-playbook playbooks/utils/checkmk_agent.yml --limit=<machine/group> -e checkmk_folder=linux/rdss
# folder names must be all lower case and should not begin with a slash

- name: Install CheckMk agent on host
  hosts: staging:qa:production
  remote_user: pulsys
  become: true

  vars_files:
    - ../../group_vars/all/vault.yml
    - ../../group_vars/all/checkmk.yml
    - ../../group_vars/checkmk/rule.yml

  tasks:
    - name: "Create a rule for systemd processes to ignore"
      checkmk.general.rule:
        server_url: "{{checkmk_agent_server_protocol}}://{{ checkmk_agent_server }}"
        site: "{{ checkmk_agent_site }}"
        automation_user: "{{ checkmk_agent_user }}"
        automation_secret: "{{ checkmk_agent_pass }}"
        ruleset: "checkgroup_parameters:systemd_services_summary"
        rule:
          conditions: {
            "host_labels": [],
            "host_name": {
              "match_on": [
                "pdc-describe-staging2.princeton.edu"
              ],
              "operator": "one_of"
            },
            "host_tags": [],
            "service_labels": []
          }
          properties: {
            "comment": "Allow systemd processes to be monitored on pdc-describe-staging2",
            "description": "Alert on Disabled Systemd",
            "disabled": false,
            "documentation_url": "https://github.com/Checkmk/ansible-collection-checkmk.general/blob/main/plugins/modules/rules.py"
          }
          value_raw: "{{ systemd_value_raw }}"
          location:
            folder: "/linux/rdss"
        state: "present"
      register: response

    - name: Show the ID of the new rule
      ansible.builtin.debug:
        msg: "RULE ID : {{ response.id }}"
