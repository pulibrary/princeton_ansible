---
#  This playbook will install the podman container engine
#     
- name: Install podman engine
  hosts: staging:qa:production
  remote_user: pulsys
  become: true
  vars:
    - podman_version: "v5.1.1-1"
    - podman_static_url: "https://github.com/mgoltzsche/podman-static/releases"
  vars_files:
    - ../../group_vars/all/vars.yml
    - ../../group_vars/all/vault.yml

  tasks:

    - name: Ensure uidmap package is installed
      ansible.builtin.apt:
        name: uidmap
        state: present
        update_cache: true

    - name: Download podman binary
      ansible.builtin.get_url:
        url: "{{ podman_static_url }}/download/{{ podman_version }}/podman-linux-amd64.tar.gz"
        dest: /tmp/podman-linux-amd64.tar.gz

    - name: Download podman binary signature
      ansible.builtin.get_url:
        url: "{{ podman_static_url }}/download/{{ podman_version }}/podman-linux-amd64.tar.gz.asc"
        dest: /tmp/podman-linux-amd64.tar.gz.asc

    - name: Import GPG key
      ansible.builtin.command: gpg --keyserver hkps://keyserver.ubuntu.com --recv-keys 0CCF102C4F95D89E583FF1D4F8B5AF50344BB503
      args:
        creates: /root/.gnupg

    - name: Verify podman binary
      ansible.builtin.command: gpg --batch --verify /tmp/podman-linux-amd64.tar.gz.asc /tmp/podman-linux-amd64.tar.gz
      ignore_errors: true

    - name: Extract podman binary
      ansible.builtin.unarchive:
        src: /tmp/podman-linux-amd64.tar.gz
        dest: /tmp
        remote_src: true

    - name: Copy podman binaries and configuration
      ansible.builtin.copy:
        src: /tmp/podman-linux-amd64/usr
        dest: /
        remote_src: true
      notify:
        - enable podman-restart

    - name: Create symbolic link for docker compatibility
      ansible.builtin.file:
        src: /usr/local/bin/podman
        dest: /usr/local/bin/docker
        state: link

    - name: Update /etc/subuid
      ansible.builtin.lineinfile:
        path: /etc/subuid
        line: "{{ lookup('pipe', 'id -un') }}:100000:200000"
        create: true

    - name: Update /etc/subgid
      ansible.builtin.lineinfile:
        path: /etc/subgid
        line: "{{ lookup('pipe', 'id -gn') }}:100000:200000"
        create: true
  handlers:
    - name: enable podman-restart
      ansible.builtin.systemd:
        name: podman-restart
        enabled: true

  post_tasks:
    - name: send information to slack
      ansible.builtin.include_tasks:
        file: slack_tasks_end_of_playbook.yml
