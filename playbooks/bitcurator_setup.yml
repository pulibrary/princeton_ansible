---
- name: BitCurator Environment Setup
  hosts: sandbox-acozine.lib.princeton.edu
  remote_user: pulsys
  become: true
  vars_files:
    - ../group_vars/bitcurator/shared.yml
    - ../group_vars/bitcurator/vault.yml

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Create bcadmin user
      ansible.builtin.user:
        name: "{{ admin_user }}"
        state: present
        createhome: true
        shell: /bin/bash
        groups: sudo
        append: true

    - name: Set password for bcadmin user (optional - change or remove as needed)
      ansible.builtin.user:
        name: "{{ admin_user }}"
        password: "{{ admin_user_password }}"

    - name: Create apps directory
      ansible.builtin.file:
        path: "{{ apps_dir }}"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0755'

    - name: Install BitCurator dependencies
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop: "{{ bitcurator_dependencies }}"

    - name: Download BitCurator CLI
      ansible.builtin.get_url:
        url: "https://github.com/BitCurator/bitcurator-cli/releases/download/{{ bitcurator_version }}/bitcurator-cli-linux"
        dest: "{{ download_dir }}/bitcurator-cli-linux"
        mode: '0644'
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Move BitCurator to /usr/local/bin
      ansible.builtin.copy:
        src: "{{ download_dir }}/bitcurator-cli-linux"
        dest: /usr/local/bin/bitcurator
        remote_src: true
        mode: '0755'
        owner: root
        group: root

    - name: Run BitCurator install
      ansible.builtin.command: bitcurator install
      args:
        creates: /usr/local/bin/bitcurator
      register: bitcurator_install

    - name: Download xRDP installer
      ansible.builtin.get_url:
        url: "https://www.c-nergy.be/downloads/xRDP/xrdp-installer-{{ xrdp_installer_version }}.zip"
        dest: "{{ download_dir }}/xrdp-installer-{{ xrdp_installer_version }}.zip"
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Unzip xRDP installer
      ansible.builtin.unarchive:
        src: "{{ download_dir }}/xrdp-installer-{{ xrdp_installer_version }}.zip"
        dest: "{{ download_dir }}"
        remote_src: yes
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Make xRDP installer executable
      ansible.builtin.file:
        path: "{{ download_dir }}/xrdp-installer-{{ xrdp_installer_version }}.sh"
        mode: '0755'

    - name: Run xRDP installer with sound support
      ansible.builtin.command: "{{ download_dir }}/xrdp-installer-{{ xrdp_installer_version }}.sh -s"
      args:
        creates: /etc/xrdp/xrdp.ini

    - name: Download Bagger
      ansible.builtin.get_url:
        url: "https://github.com/LibraryOfCongress/bagger/releases/download/v{{ bagger_version }}/bagger-{{ bagger_version }}.zip"
        dest: "{{ download_dir }}/bagger-{{ bagger_version }}.zip"
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Unzip Bagger to apps directory
      ansible.builtin.unarchive:
        src: "{{ download_dir }}/bagger-{{ bagger_version }}.zip"
        dest: "{{ apps_dir }}"
        remote_src: true
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Download Droid
      ansible.builtin.get_url:
        url: "https://cdn.nationalarchives.gov.uk/documents/droid-binary-{{ droid_version }}-bin.zip"
        dest: "{{ download_dir }}/"
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Unzip Droid to apps directory
      ansible.builtin.unarchive:
        src: "{{ download_dir }}/droid-binary-{{ droid_version }}-bin.zip"
        dest: "{{ apps_dir }}"
        remote_src: true
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"

    - name: Create Desktop directory if it doesn't exist
      ansible.builtin.file:
        path: "{{ admin_home }}/Desktop"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0755'

    - name: Ensure snapd service is running
      ansible.builtin.systemd:
        name: snapd
        state: started
        enabled: yes

    - name: Install FSLint via snap
      community.general.snap:
        name: fslint-unofficial
        state: present

    - name: Display completion message
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "BitCurator Environment Setup Complete!"
          - "=========================================="
          - ""
          - "Next Steps:"
          - "1. Change bcadmin password: sudo passwd bcadmin"
          - "2. Reboot the system: sudo reboot"
          - "3. After reboot, verify BitCurator: bitcurator --version"
          - "4. Test XRDP connection to this system"
          - ""
          - "=========================================="
