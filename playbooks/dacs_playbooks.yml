# by default this playbook runs in the staging environment
# to run in qa, pass '-e runtime_env=qa'
# to run in production, pass '-e runtime_env=production'
- name: Run all DACS playbooks
  hosts: dacs:&{{runtime_env|default('staging')}}
  remote_user: pulsys
  become: true
  tags:
    - rails
    - vue
    - drupal
    - php
  block:
    - name: Run the allsearch api playbook
      ansible.builtin.import_playbook: allsearch_api.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the approvals playbook
      ansible.builtin.import_playbook: approvals.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the bibdata playbook
      ansible.builtin.import_playbook: bibdata.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the dss playbook
      ansible.builtin.import_playbook: dss.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the lib jobs playbook
      ansible.builtin.import_playbook: lib_jobs.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the lockers and study rooms playbook
      ansible.builtin.import_playbook: lockers_and_study_rooms.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the orangelight playbook
      ansible.builtin.import_playbook: orangelight.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the repec playbook
      ansible.builtin.import_playbook: repec.yml runtime_env={{runtime_env|default('staging')}}
      when: "'rails' in ansible_run_tags"
    - name: Run the allsearch frontend playbook
      ansible.builtin.import_playbook: allsearch_frontend.yml runtime_env={{runtime_env|default('staging')}}
      when: "'vue' in ansible_run_tags"
    - name: Run the static tables playbook
      ansible.builtin.import_playbook: static_tables.yml runtime_env={{runtime_env|default('staging')}}
      when: "'vue' in ansible_run_tags"
    - name: Run the byzantine playbook
      ansible.builtin.import_playbook: byzantine.yml runtime_env={{runtime_env|default('staging')}}
      when: "'drupal' in ansible_run_tags or 'php' in ansible_run_tags"
    - name: Run the researchdata playbook
      ansible.builtin.import_playbook: researchdata.yml runtime_env={{runtime_env|default('staging')}}
      when: "'drupal' in ansible_run_tags or 'php' in ansible_run_tags"
    - name: Run the pas playbook
      ansible.builtin.import_playbook: pas.yml runtime_env={{runtime_env|default('staging')}}
      when: "'php' in ansible_run_tags"
    - name: Run the video reserves playbook
      ansible.builtin.import_playbook: video_reserves.yml runtime_env={{runtime_env|default('staging')}}
      when: "'php' in ansible_run_tags"
  rescue:
    - name: send slack an alert when a playbook fails
      community.general.slack:
        token: "{{ vault_pul_slack_token }}"
        msg: "Ansible playbook `{{ ansible_play_name }}` failed on {{ inventory_hostname }}"
        channel: "{{ slack_alerts_channel }}"





