---
# this will run on your local machine and build a docker image for local mediaflux development
# to run this playbook, use the following command: ansible-playbook mflux-docker.yml
# to run the docker image, use the following command: docker run -it -rm -d -p 0.0.0.0:80 -name mediaflux-development Rocky-ansible-base
- name: Pull latest Rocky9 Image
  hosts: localhost
  tasks:
  - name: Pull Docker-Rocky9 Image
    docker_container:
      name: "Rocky-ansible-base"
      image: "rockylinux:9"
      state: started
      command: tail -f /dev/null
      mac_address: "02:42:ac:11:00:02"
  - name: Add Rocky9 Image to Ansible Hosts
    add_host:
      name: "Rocky-ansible-base"
      ansible_connection: docker
      ansible_ssh_user: root

# Run the mediaflux configurations for the docker container
- name: install mediaflux in a docker container
  hosts: "Rocky-ansible-base"
  gather_facts: false
  vars:
       runtime_env: "docker"
  vars_files:
    - ../group_vars/mflux/docker.yml
    - ../group_vars/mflux/vault.yml
  roles:
    - role: ../roles/mflux

- name: Snapshot base image to create newly configured Image
  hosts: localhost
  tasks:
    - name: Commit Docker image
      command: docker commit "Rocky-ansible-base" "mediaflux-base"

- name: Clean Up Docker Containers
  hosts: localhost
  tasks:
    - name: Remove Running Base Image
      docker_container:
        name: Rocky-ansible-base
        state: absent
        force_kill: yes

- name: Update entrypoint
  hosts: localhost
  tasks:
  - name: Update entrypoint
    docker_container:
      name: "mediaflux-container"
      image: "mediaflux-base"
      state: started
      mac_address: "02:42:ac:11:00:02"
      command: /usr/bin/java -jar /opt/mediaflux/bin/aserver.jar application.home=/opt/mediaflux nogui
      published_ports: 8888:80
      publish_all_ports: true
      privileged: true
  - name: Add mediaflux-container to Ansible Hosts
    add_host:
      name: "mediaflux-container"
      ansible_connection: docker
      ansible_ssh_user: root

- name: Snapshot mediaflux-development to create newly configured Image
  hosts: localhost
  tasks:
    - name: Commit Docker mediaflux-development
      command: docker commit "mediaflux-container" "mediaflux-development"

- name: Clean Up Docker Containers
  hosts: localhost
  tasks:
    - name: Remove Running Base Image
      docker_container:
        name: mediaflux-container
        state: absent
        force_kill: yes


# Just run mediaflux
# - /usr/bin/java -jar /opt/mediaflux/bin/aserver.jar application.home=/opt/mediaflux nogui

# Create a docker container from the image
# docker create --name mediaflux-a --publish 8888:80 --mac-address 02:42:ac:11:00:02 mediaflux-development

# Start the container
# docker start mediaflux-a