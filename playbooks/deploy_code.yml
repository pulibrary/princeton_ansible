---
# pass up to three vars, for example:
# '-e project_name=orangelight'
# '-e branch_name=my_branch'
# to run in production, pass '-e runtime_env=production'
- name: Deploy code with Capistrano
  hosts: "{{ project_name }}_{{ runtime_env | default('staging') }}"
  remote_user: pulsys
  become: true
  vars:
    project_dir: /opt/deploy/{{ project_repo }}
    github_key_path:
  tasks:
    - name: update code repo
      ansible.builtin.git:
        repo: https://github.com/pulibrary/{{ project_name }}.git
        dest: "{{ project_dir}}"
        single_branch: true
        version: "{{ branch_name | default('main') }}"

    - name: cap deploy
      ansible.builtin.shell: cd {{ project_dir }} && branch={{ branch_name }} bundle exec cap {{ runtime_env }} deploy

#    - name: update PR
#      could use the GitHub API:
#      https://docs.github.com/en/rest/issues/comments?apiVersion=2022-11-28#create-an-issue-comment 

  post_tasks:
  - name: let folks on slack know you deployed
    community.general.slack:
      token: "{{ vault_pul_slack_token }}"
      msg: "Ansible deployed `{{ branch_name }}` of `{{ project_repo }}` on {{ inventory_hostname }}"
      channel: #server-alerts
