---
- hosts: all
  serial: 2
  remote_user: pulsys
  become: true
  pre_tasks:

    - name: test for python on new VM
      ansible.builtin.raw: test -e /usr/bin/python
      changed_when: false
      failed_when: false
      register: check_python

    - name: Install Python  # this has to be raw in the event python is not installed
      ansible.builtin.raw: apt -y update && apt install -y python-minimal python-pip
      when: check_python.rc != 0

  tasks:

    - name: Update apt
      ansible.builtin.apt:
        update_cache: true
        force_apt_get: true
        cache_valid_time: 3600

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: dist
        force_apt_get: true
